<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - Odisha e-Guru</title>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
    mermaid.initialize({ startOnLoad: true, theme: 'default' });
</script>
    <style>
* {
    box-sizing: border-box;
}

/* Base Styles - Mobile First */
body, h1, h2, h3, h4, p, ul, li {
    margin: 0;
    padding: 0;
}

html, body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    width: 100%;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

        /* Force welcome page to be on top when shown */
.welcome-page.active {
    display: flex !important;
    z-index: 99999 !important;
    position: fixed !important;
}

.container.hidden {
    display: none !important;
    z-index: -1 !important;
}
        
/* Welcome Page - Mobile Optimized */
.welcome-page {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    min-height: 100vh;
    padding: 0;
    padding-top: 30px;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 9999;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    overflow: hidden;
}

.welcome-page-inner {
    height: 100%;
    overflow-y: auto;
    padding: 20px 10px 15px 10px;
    width: 100%;
}

.welcome-page::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    animation: backgroundMove 15s ease-in-out infinite;
}


.welcome-card {
    background: rgba(255, 255, 255, 0.98);
    border-radius: 20px;
    padding: 20px 15px;
    max-width: 420px;
    width: calc(100% - 20px);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 1;
    animation: slideUp 0.6s ease-out;
}

.welcome-logo {
    width: 90px;
    height: 90px;
    margin: 0 auto 15px;
    display: block;
    border-radius: 50%;
    border: 4px solid #667eea;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    animation: bounce 2s ease-in-out infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.welcome-title {
    text-align: center;
    color: #667eea;
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 8px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
}

.welcome-subtitle {
    text-align: center;
    color: #764ba2;
    font-size: 13px;
    margin-bottom: 20px;
    font-weight: 600;
}

.roll-input-group {
    margin-bottom: 20px;
}

.roll-label {
    display: block;
    color: #667eea;
    font-weight: 700;
    margin-bottom: 10px;
    font-size: 14px;
    text-align: center;
}

.roll-input {
    width: 100%;
    padding: 14px 20px;
    border: 3px solid #667eea;
    border-radius: 50px;
    font-size: 18px;
    text-align: center;
    font-weight: 700;
    transition: all 0.3s ease;
    background: white;
    letter-spacing: 2px;
}

.roll-input:focus {
    outline: none;
    border-color: #764ba2;
    box-shadow: 0 0 0 5px rgba(118, 75, 162, 0.2);
    transform: scale(1.02);
}

.roll-input::placeholder {
    color: #aaa;
    font-weight: 500;
    letter-spacing: 1px;
}

.enter-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 50px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.enter-btn:hover:not(:disabled) {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
}

.enter-btn:active:not(:disabled) {
    transform: translateY(-1px);
}

.enter-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.message {
    padding: 15px;
    border-radius: 15px;
    text-align: center;
    margin-top: 20px;
    font-weight: 600;
    display: none;
    animation: slideIn 0.3s ease-out;
    white-space: pre-line;
    line-height: 1.6;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.show {
    display: block;
}

.message.error {
    background: linear-gradient(135deg, #ff6b6b, #ff8e53);
    color: white;
    animation: shake 0.5s ease-in-out;
}

.message.success {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
}

.message.loading {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.info-text {
    text-align: center;
    color: #888;
    font-size: 14px;
    margin-top: 20px;
}

.security-badge {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    border: 2px solid #4CAF50;
    border-radius: 15px;
    padding: 15px;
    margin-top: 20px;
    text-align: center;
}

.security-badge-title {
    color: #2e7d32;
    font-weight: 700;
    font-size: 14px;
    margin-bottom: 8px;
}

.security-badge-text {
    color: #388e3c;
    font-size: 12px;
    line-height: 1.6;
}

/* Main Container */
.container {
    background: white;
    max-width: 100%;
    width: 100%;
    min-height: 100vh;
    overflow-x: hidden;
    padding: 0;
    margin: 0;
    display: none;
}

.container.show {
    display: block;
}

/* Header */
.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 15px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: pulse 4s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.05); opacity: 0.7; }
}

.header h1 {
    font-size: 20px;
    margin-bottom: 6px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    position: relative;
    z-index: 1;
}

.header p {
    font-size: 12px;
    opacity: 0.95;
    position: relative;
    z-index: 1;
}

.assistant-image {
    width: 110px;
    height: 110px;
    margin: 12px auto 0 !important;
    display: block;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
}

.assistant-section {
    padding: 15px 0 20px 0;
}

/* Quick Actions */
.quick-actions {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 15px 0;
    margin: 0;
}

.actions-title {
    color: #1e3c72;
    font-weight: bold;
    font-size: 15px;
    margin: 0 15px 12px 15px;
    text-align: center;
}

.main-action-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 14px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    margin: 0 15px;
    width: calc(100% - 30px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    -webkit-tap-highlight-color: transparent;
}

.main-action-btn:active {
    transform: scale(0.98);
}

.action-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin: 12px 15px 0 15px;
    width: calc(100% - 30px);
}

.action-grid.hidden {
    display: none !important;
}
.action-btn {
    background: white;
    border: 2px solid #667eea;
    color: #000000;
    padding: 12px 8px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    -webkit-tap-highlight-color: transparent;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-btn:active {
    background: #667eea;
    color: white;
    transform: scale(0.97);
}

/* Input Container */
.input-container {
    background: linear-gradient(135deg, #f0f8ff 0%, #e6f2ff 100%);
    padding: 15px 0;
    margin: 0;
}

.input-label {
    color: #667eea;
    font-weight: bold;
    margin: 0 15px 10px 15px;
    display: block;
    font-size: 14px;
}

.assistant-input {
    width: calc(100% - 30px);
    padding: 15px;
    border: 2px solid #667eea;
    border-radius: 10px;
    font-size: 15px;
    resize: vertical;
    min-height: 100px;
    font-family: inherit;
    transition: all 0.3s ease;
    margin: 0 15px;
    background: white;
    line-height: 1.5;
}

.assistant-input:focus {
    outline: none;
    border-color: #764ba2;
    box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.15);
}

/* Audio Controls - Compact Mobile Version */
.audio-control-section {
    background: transparent;
    padding: 0;
    margin: 0 15px 8px 15px;
}

.audio-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 0;
}

.audio-checkbox {
    width: 14px;
    height: 14px;
    cursor: pointer;
}

.audio-label {
    color: #667eea;
    font-weight: 500;
    font-size: 11px;
    cursor: pointer;
}

.play-stop-btn {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
    width: 100%;
    -webkit-tap-highlight-color: transparent;
}

.play-stop-btn:active {
    transform: scale(0.97);
}

.play-stop-btn.playing {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    box-shadow: 0 3px 12px rgba(244, 67, 54, 0.4);
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.75; }
}

.play-stop-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.send-btn {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 13px 30px;
    border-radius: 25px;
    font-size: 14px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s ease;
    width: calc(100% - 30px);
    margin: 12px 15px 0 15px;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    -webkit-tap-highlight-color: transparent;
}

.send-btn:active {
    transform: scale(0.98);
}

/* Response Container */
.response-container {
    background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
    padding: 5px 0;
    margin-top: 0;
    display: none;
    animation: fadeIn 0.5s ease;
}

.response-container.show {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(15px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Test Container */
.test-container {
    background: white;
    padding: 0;
    margin: 0;
}

.question-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-left: 4px solid #667eea;
    padding: 15px 12px;
    margin: 0 0 12px 0;
}

.question-number {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 5px 12px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 11px;
    display: inline-block;
    margin-bottom: 8px;
}

.question-text {
    color: #333;
    font-size: 14px;
    font-weight: 600;
    margin: 8px 0;
    line-height: 1.6;
    text-align: left;
}

.option-btn {
    background: white;
    border: 2px solid #dee2e6;
    color: #333;
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
    margin: 0 0 8px 0;
    width: 100%;
    display: block;
    -webkit-tap-highlight-color: transparent;
    line-height: 1.4;
}

.option-btn:active {
    transform: scale(0.98);
}

.option-btn.selected {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-color: #667eea;
    color: white;
    font-weight: 600;
}

.option-btn.correct {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    border-color: #4CAF50;
    color: white;
}

.option-btn.wrong {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    border-color: #f44336;
    color: white;
}

.submit-test-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 14px 35px;
    border-radius: 25px;
    font-size: 15px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s ease;
    width: calc(100% - 30px);
    margin: 20px 15px 15px 15px;
    box-shadow: 0 5px 18px rgba(102, 126, 234, 0.4);
    -webkit-tap-highlight-color: transparent;
}

.submit-test-btn:active {
    transform: scale(0.98);
}

/* Certificate */
.certificate-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-top: 4px solid #667eea;
    border-bottom: 4px solid #667eea;
    padding: 25px 15px;
    margin: 0;
    text-align: center;
}

.certificate-header {
    font-size: 22px;
    color: #667eea;
    font-weight: 900;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
}

.certificate-body {
    font-size: 14px;
    color: #333;
    margin: 12px 0;
    line-height: 1.7;
}

.score-big {
    font-size: 40px;
    font-weight: 900;
    color: #4CAF50;
    margin: 15px 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.performance-badge {
    display: inline-block;
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
    margin: 12px 0;
}

.badge-excellent {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #fff;
}

.badge-good {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
}

.badge-average {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
}

.badge-needs-work {
    background: linear-gradient(135deg, #FF9800, #F57C00);
    color: white;
}

/* Welcome Modal */
.welcome-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    z-index: 1000;
    padding: 15px;
    overflow-y: auto;
}

.welcome-content {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 20px;
    padding: 25px 20px;
    max-width: 420px;
    width: 100%;
    text-align: center;
    animation: modalSlideIn 0.5s ease;
    box-shadow: 0 15px 50px rgba(0,0,0,0.5);
    margin: 15px auto;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.welcome-icon {
    font-size: 50px;
    margin-bottom: 12px;
    animation: iconBounce 2s infinite;
}

@keyframes iconBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.welcome-title {
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 22px;
    font-weight: 900;
    margin-bottom: 12px;
}

.welcome-text {
    color: #555;
    font-size: 13px;
    line-height: 1.6;
    margin-bottom: 20px;
}


.permission-item.checked .permission-checkbox {
    background: #4CAF50;
    border-color: #4CAF50;
}

.permission-checkbox::after {
    content: 'âœ“';
    color: white;
    font-size: 14px;
    font-weight: bold;
    display: none;
}

.permission-item.checked .permission-checkbox::after {
    display: block;
}

.permission-text {
    flex: 1;
    font-size: 12px;
    color: #333;
    font-weight: 500;
    line-height: 1.4;
    text-align: justify;
    text-justify: inter-word;
    hyphens: auto;  /* Optional: for better word breaks */
}
.start-btn {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 14px 40px;
    border-radius: 30px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 18px rgba(76, 175, 80, 0.4);
    width: 100%;
    margin: 0;
    opacity: 0.5;
    pointer-events: none;
    -webkit-tap-highlight-color: transparent;
}

.start-btn.enabled {
    opacity: 1;
    pointer-events: auto;
}

.start-btn.enabled:active {
    transform: scale(0.98);
}

/* Matching Exercise */
.match-option {
    transition: all 0.3s ease;
    -webkit-tap-highlight-color: transparent;
}

.match-option:active {
    transform: scale(0.98);
}

.matching-columns-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 0 8px;
}

[id^="match-row-"] {
    transition: all 0.3s ease;
    cursor: pointer;
}

[id^="match-answer-"] {
    transition: all 0.3s ease;
}

.column-header {
    position: sticky;
    top: 0;
    z-index: 10;
}

.scroll-hint {
    text-align: center;
    padding: 8px;
    background: #fff3cd;
    color: #856404;
    font-size: 11px;
    border-radius: 4px;
    margin: 10px 15px;
}

/* Tablet Styles (481px - 768px) */
@media (min-width: 481px) and (max-width: 768px) {
    .welcome-card {
        padding: 40px 30px;
        max-width: 480px;
    }
    
    .welcome-logo {
        width: 140px;
        height: 140px;
    }
    
    .welcome-title {
        font-size: 26px;
    }
    
    .header h1 {
        font-size: 24px;
    }
    
    .assistant-image {
        width: 130px;
        height: 130px;
    }
    
    .action-btn {
        font-size: 14px;
        padding: 14px 10px;
    }
    
    .assistant-input {
        font-size: 16px;
        min-height: 120px;
    }
}

/* Desktop Styles (769px and above) */
@media (min-width: 769px) {
    .welcome-card {
        padding: 50px 40px;
        max-width: 500px;
    }
    
    .welcome-logo {
        width: 160px;
        height: 160px;
    }
    
    .welcome-title {
        font-size: 32px;
    }
    
    .watermark {
        font-size: 11px;
        padding: 8px 15px;
        bottom: 10px;
        right: 10px;
    }
    
    .container {
        max-width: 100%;
        margin: 0 auto;
    }
    
    .header {
        padding: 35px 30px;
    }
    
    .header h1 {
        font-size: 32px;
    }
    
    .assistant-section {
        padding: 30px 30px 40px;
        max-width: 900px;
        margin: 0 auto;
    }
    
    .assistant-image {
        width: 180px;
        height: 180px;
    }
    
    .action-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        max-width: 800px;
        margin: 15px auto 0;
    }
    
    .action-btn {
        font-size: 15px;
        padding: 14px 12px;
        min-height: 55px;
    }
    
    .action-btn:hover {
        border-color: #667eea;
        background: #f0f4ff;
        transform: translateX(3px);
    }
    
    .main-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }
    
    .assistant-input {
        max-width: 800px;
        margin: 0 auto;
        display: block;
        font-size: 16px;
        padding: 18px;
    }
    
    .send-btn {
        max-width: 800px;
        margin: 15px auto 0;
        display: block;
    }
    
    .send-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
    }
    
    .input-container {
        padding: 25px 30px;
    }
    
    .quick-actions {
        padding: 25px 30px;
    }
    
    .question-card {
        max-width: 800px;
        margin: 0 auto 15px;
        padding: 20px 18px;
    }
    
    .question-text {
        font-size: 15px;
    }
    
    .option-btn {
        font-size: 14px;
        padding: 12px 15px;
    }
    
    .option-btn:hover {
        border-color: #667eea;
        background: #f0f4ff;
        transform: translateX(5px);
    }
    
    .submit-test-btn {
        max-width: 400px;
        margin: 25px auto 15px;
    }
    
    .submit-test-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }
    
    .certificate-container {
        padding: 40px 30px;
        max-width: 900px;
        margin: 0 auto;
    }
    
    .certificate-header {
        font-size: 32px;
    }
    
    .certificate-body {
        font-size: 16px;
    }
    
    .score-big {
        font-size: 52px;
    }
    
    .performance-badge {
        font-size: 16px;
        padding: 10px 25px;
    }
    
    .welcome-content {
        padding: 35px 30px;
        max-width: 380px;
    }
    
    .welcome-icon {
        font-size: 70px;
    }
    
    .welcome-title {
        font-size: 26px;
    }
    
    .welcome-text {
        font-size: 15px;
    }
    
  .permission-text {
        font-size: 13px;
        text-align: justify; /* Add here too */
    }
}
    
    .start-btn {
        max-width: 350px;
        margin: 0 auto;
    }
    
    .start-btn.enabled:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 22px rgba(76, 175, 80, 0.6);
    }
    
    .audio-control-section {
        max-width: 800px;
        margin: 0 auto 10px;
    }
    
    .play-stop-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.5);
    }
}

/* Extra Small Mobile (max 400px) */
@media (max-width: 400px) {
    .welcome-card {
        padding: 25px 15px;
    }
    
    .welcome-logo {
        width: 100px;
        height: 100px;
    }
    
    .welcome-title {
        font-size: 20px;
    }
    
    .welcome-subtitle {
        font-size: 13px;
    }
    
    .roll-input {
        font-size: 16px;
        padding: 12px 18px;
    }
    
    .enter-btn {
        font-size: 14px;
        padding: 13px;
    }
    
    .header h1 {
        font-size: 18px;
    }
    
    .header p {
        font-size: 11px;
    }
    
    .assistant-image {
        width: 95px;
        height: 95px;
    }
    
    .actions-title {
        font-size: 14px;
    }
    
    .main-action-btn {
        font-size: 14px;
        padding: 12px;
    }
    
    .action-btn {
        font-size: 12px;
        padding: 10px 6px;
        min-height: 48px;
    }
    
    .assistant-input {
        font-size: 14px;
        padding: 13px;
        min-height: 90px;
    }
    
    .send-btn {
        font-size: 13px;
        padding: 12px 25px;
    }
    
    .question-text {
        font-size: 13px;
    }
    
    .option-btn {
        font-size: 12px;
        padding: 9px 10px;
    }
    
    .certificate-header {
        font-size: 20px;
    }
    
    .certificate-body {
        font-size: 13px;
    }
    
    .score-big {
        font-size: 36px;
    }
    
    .performance-badge {
        font-size: 13px;
        padding: 7px 18px;
    }
    
    .welcome-content {
        padding: 20px 15px;
    }
    
    .welcome-icon {
        font-size: 45px;
    }
    
    .welcome-title {
        font-size: 20px;
    }
    
    .welcome-text {
        font-size: 12px;
    }
    
    .permission-item {
        padding: 10px;
        gap: 8px;
    }
    
    .permission-text {
         font-size: 11px;
        text-align: justify; /* Add here too */
    }
    
    .start-btn {
        font-size: 14px;
        padding: 12px 35px;
    }
    
    .match-option {
        font-size: 11px;
        padding: 8px !important;
    }
    
    .matching-columns-grid {
        gap: 6px;
        padding: 0 5px;
    }
}

/* Landscape Orientation Optimization */
@media (max-height: 600px) and (orientation: landscape) {
    .welcome-page {
        padding-top: 15px;
    }
    
    .welcome-card {
        padding: 20px 25px;
    }
    
    .welcome-logo {
        width: 90px;
        height: 90px;
        margin-bottom: 15px;
    }
    
    .welcome-title {
        font-size: 20px;
        margin-bottom: 6px;
    }
    
    .welcome-subtitle {
        font-size: 13px;
        margin-bottom: 20px;
    }
    
    .roll-input-group {
        margin-bottom: 15px;
    }
    
    .assistant-image {
        width: 90px;
        height: 90px;
    }
    
    .header {
        padding: 15px;
    }
    
    .welcome-content {
        padding: 20px;
        margin: 10px auto;
    }
    
    .welcome-icon {
        font-size: 40px;
        margin-bottom: 8px;
    }
}

/* Print Styles */
@media print {
    .welcome-page,
    .watermark,
    .main-action-btn,
    .action-grid,
    .send-btn,
    .audio-control-section {
        display: none !important;
    }
    
    .container {
        display: block !important;
    }
    
    .header {
        background: white !important;
        color: black !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .certificate-container {
        page-break-inside: avoid;
    }
}

/* Accessibility Improvements */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
    .action-btn,
    .option-btn {
        border-width: 3px;
    }
    
    .roll-input,
    .assistant-input {
        border-width: 3px;
    }
}

/* Dark Mode Support (if needed in future) */
@media (prefers-color-scheme: dark) {
    /* Currently using fixed color scheme, but structure ready for dark mode */
}



/* Make the marquee container not add to height */
body > div:first-child {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10000;
    margin: 0;
}

/* Adjust main content to account for fixed marquee */
.welcome-page {
    padding-top: 40px; /* Adjust based on marquee height */
}

.container {
    padding-top: 40px; /* Adjust based on marquee height */
}
    </style>
</head>
<body>
<div style="background: #ff9800; padding: 8px; color: white; font-weight: bold; position: fixed; top: 0; left: 0; right: 0; z-index: 99999; overflow: hidden; margin: 0;">
    <marquee behavior="scroll" direction="left" style="margin: 0;">
        Â© 2025 â€¢ This is the property of Odisha e-Guru,Mayurbhanj,Odisha â€¢ For Educational Use Only â€¢ Copying & Distribution Prohibited â€¢ All Rights Reserved
    </marquee>
</div>
   <!-- Welcome Page with Roll Number -->
<div class="welcome-page" id="welcomePage">
    <div class="welcome-card">
        <h1 class="welcome-title">Welcome to</h1>
        <p class="welcome-subtitle">Odisha e-Guru Learning Platform</p>
        
        <div class="roll-input-group">
            <label class="roll-label">ğŸ“ Enter Your Roll Number</label>
            <input type="number" 
                   id="rollInput" 
                   class="roll-input" 
                   placeholder="Enter Roll Number">
        </div>
        
<!-- Single Consolidated Consent Checkbox -->
<div style="background: linear-gradient(135deg, #f8f9ff 0%, #e8eeff 100%); border: 2px solid #667eea; border-radius: 16px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15); transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.25)'" onmouseout="this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.15)'">
    <div style="display: flex; align-items: flex-start; gap: 15px; cursor: pointer;" onclick="toggleConsentCheckbox()">
       <div id="consentCheckbox" class="permission-checkbox" style="width: 24px; height: 24px; border: 2px solid #667eea; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.3s ease; margin-top: 3px; background: white;">
        </div>
        <div style="flex: 1; color: #2d3748;">
            <span style="font-size: 15px; line-height: 1.7; text-align: justify; display: block;">
                <strong style="color: #667eea;">I consent to</strong> automatic audio playback, internet access for translations, external search when needed, data storage access, and agree to all <a href="https://sites.google.com/view/eguruodishastp/terms-and-conditions" style="color: #667eea; text-decoration: none; font-weight: 600; border-bottom: 2px solid #667eea; transition: all 0.2s;" onmouseover="this.style.borderBottomColor='#764ba2'" onmouseout="this.style.borderBottomColor='#667eea'">terms and conditions</a> of Odisha e-Guru including collection of device information for security purposes.
            </span>
        </div>
    </div>
</div>
        
        <button class="enter-btn" id="enterBtn" onclick="validateAndEnter()">
            ğŸš€ Start Learning
        </button>
        
        <div class="message" id="messageBox"></div>
        
        <div class="security-badge">
            <div class="security-badge-title">ğŸ”’ Secure Access</div>
            <div class="security-badge-text">
                Your roll number is linked to this device only.<br>
                Sharing is not allowed and will be detected.
            </div>
        </div>
        
        <p class="info-text">
            ğŸ“š Your gateway to Digital learning.
        </p>
    </div>
</div>
    <div class="container" id="mainApp">
  <div class="header">
  <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 15px; position: relative; z-index: 100; padding: 0 5px;">
    <!-- Roll Number Button (Left) - DEEP BLUE -->
    <div id="userInfo" 
         style="background: linear-gradient(135deg, #1e3c72, #2a5298); 
                color: white; 
                border: none; 
                padding: 12px 24px; 
                border-radius: 30px; 
                font-size: 15px; 
                font-weight: 700; 
                box-shadow: 0 5px 15px rgba(30, 60, 114, 0.5);
                transition: all 0.3s ease;
                -webkit-tap-highlight-color: transparent;
                position: relative;
                z-index: 100;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                flex: 1;
                min-height: 48px;
                border: 2px solid rgba(255,255,255,0.2);">
        <span style="font-size: 18px;">ğŸ“</span>
        <span style="letter-spacing: 0.5px;">Roll: --</span>
    </div>
    
    <!-- Back Button (Right) - DEEP BLUE -->
    <button onclick="backToRollPage()" 
            style="background: linear-gradient(135deg, #1e3c72, #2a5298); 
                   color: white; 
                   border: 2px solid rgba(255,255,255,0.2); 
                   padding: 12px 24px; 
                   border-radius: 30px; 
                   font-size: 15px; 
                   font-weight: 700; 
                   cursor: pointer; 
                   box-shadow: 0 5px 15px rgba(30, 60, 114, 0.5);
                   transition: all 0.3s ease;
                   -webkit-tap-highlight-color: transparent;
                   position: relative;
                   z-index: 100;
                   display: flex;
                   align-items: center;
                   justify-content: center;
                   gap: 8px;
                   flex: 1;
                   min-height: 48px;"
            onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 8px 20px rgba(30, 60, 114, 0.7)'; this.style.background='linear-gradient(135deg, #2a5298, #1e3c72)'"
            onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 5px 15px rgba(30, 60, 114, 0.5)'; this.style.background='linear-gradient(135deg, #1e3c72, #2a5298)'">
        <span style="font-size: 18px; font-weight: 900;">â†</span>
        <span style="letter-spacing: 0.5px;">Back</span>
    </button>
</div>
    <h1>ğŸ“ Odisha e-Guru Assistant</h1>
          
            <img src="https://github.com/eguruOdisha/BNSS/raw/main/bot%20image-1.gif" 
                 alt="AI Assistant" 
                 class="assistant-image">
        </div>
        <div class="assistant-section">
            <div class="quick-actions">
                <button class="main-action-btn" id="mainActionBtn" onclick="toggleActions()">
                    â„¹ï¸ What Can I Do? <span style="margin-left: auto;">â–¼</span>
                </button>

                <div class="action-grid hidden" id="actionGrid">
   <button class="action-btn" onclick="quickAction('concept')">
                        ğŸ’¡ Concept & Example
                    </button>
                    <button class="action-btn" onclick="quickAction('mcq')">
                        ğŸ“ MCQ Test
                    </button>
                    <button class="action-btn" onclick="quickAction('truefalse')">
                        âœ“âœ— True/False
                    </button>
                    <button class="action-btn" onclick="quickAction('fillblanks')">
                        ğŸ“‹ Fill Blanks
                    </button>
                    <button class="action-btn" onclick="quickAction('matching')">
                        ğŸ”— Matching
                    </button>
                    <button class="action-btn" onclick="quickAction('arrange')">
                        ğŸ”¤ Arrange Words
                    </button>
               </div>

<!-- NEW: BNSS Section Toggle Button -->
<button class="main-action-btn" id="bnssTextBtn" onclick="toggleBNSSText()" 
        style="margin-top: 12px; background: linear-gradient(135deg, #4CAF50, #45a049);">
    ğŸ“œ View BNSS Section-1 Text <span style="margin-left: auto;" id="bnssArrow">â–¼</span>
</button>

<!-- NEW: BNSS Text Content (Hidden by default) -->
<div id="bnssTextContent" style="display: none; background: white; border: 3px solid #4CAF50; border-radius: 12px; padding: 20px; margin: 12px 15px 0 15px; box-shadow: 0 3px 15px rgba(0,0,0,0.1);">
    <h3 style="color: #4CAF50; font-size: 18px; font-weight: 900; margin-bottom: 15px; text-align: center;">
        BNSS, 2023: Section-1
    </h3>
    <h4 style="color: #667eea; font-size: 16px; font-weight: 700; margin-bottom: 12px; text-align: center;">
        Short title, extent and commencement.
    </h4>
    
    <div style="background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <p style="text-align: justify; line-height: 1.6;">
            <strong style="color: #667eea;">(1)</strong> This Act may be called the <strong>Bharatiya Nagarik Suraksha Sanhita, 2023</strong>.
        </p>
    </div>
    
    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <p style="text-align: justify; line-height: 1.6;">
            <strong style="color: #856404;">(2)</strong> The provisions of this Sanhita, other than those relating to Chapters IX, XI and XII thereof, shall not apply---
        </p>
        <div style="margin-top: 10px; padding-left: 20px;">
            <div style="margin-bottom: 8px; text-align: justify;"><strong>(a)</strong> to the State of Nagaland;</div>
            <div style="text-align: justify;"><strong>(b)</strong> to the tribal areas,</div>
        </div>
        <p style="margin-top: 10px; text-align: justify; line-height: 1.6;">but the concerned State Government may, by notification, apply such provisions or any of them to the whole or part of the State of Nagaland or such tribal areas, as the case may be, with such supplemental, incidental or consequential modifications, as may be specified in the notification.</p>
    </div>
    
    <div style="background: #e3f2fd; border-left: 4px solid #2196F3; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <p style="text-align: justify; line-height: 1.6;">
            <strong style="color: #1976D2;">Explanation.</strong>---In this section, "tribal areas" means the territories which immediately before the 21st day of January, 1972, were included in the tribal areas of Assam, as referred to in paragraph 20 of the Sixth Schedule to the Constitution, other than those within the local limits of the municipality of Shillong.
        </p>
    </div>
    
    <div style="background: #e8f5e9; border-left: 4px solid #4CAF50; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <p style="text-align: justify; line-height: 1.6;">
            <strong style="color: #2e7d32;">(3)</strong> It shall come into force on such date<sup>1</sup> as the Central Government may, by notification in the Official Gazette, appoint.
        </p>
    </div>
    
    <div style="background: #f5f5f5; border-left: 4px solid #9e9e9e; padding: 15px; border-radius: 8px;">
        <strong style="color: #666;">FOOTNOTE:</strong> 
        <p style="margin-top: 8px; font-size: 13px; line-height: 1.6; text-align: justify;">
            <sup>1</sup> 1st July, 2024, [except the provisions of the entry relation to Section 106(2) in the first Schedule], vide notification No. S.O. 848(E), dated, 23rd day of February, 2024, see Gazette of India, Extraordinary, Part II, sec. 3(ii).
        </p>
    </div>
</div>
<!-- NEW: Web Link Button -->
<a href="https://sites.google.com/view/bnss-chapter-i/section-1/s1bot" target="_blank" style="text-decoration: none;">
    <button class="main-action-btn" style="margin-top: 12px; background: linear-gradient(135deg, #FF6B6B, #FF8E53);">
        ğŸ”— Talk with Special Assistant<span style="margin-left: auto;">â†’</span>
    </button>
</a>


                </div>
            <div class="input-container">
                <label class="input-label">ğŸ’¬ Ask Your Question (Hindi/English):</label>
                
                <div class="audio-control-section">
                    <div class="audio-toggle">
                        <input type="checkbox" id="autoplayCheckbox" class="audio-checkbox" checked onchange="toggleAutoplay()">
                        <label for="autoplayCheckbox" class="audio-label">ğŸ”Š Auto-play audio answers</label>
                    </div>
                </div>
                
                <textarea class="assistant-input" 
                          id="assistantInput" 
                          placeholder="Please write here....."
                          onkeypress="if(event.key === 'Enter' && event.shiftKey) { event.preventDefault(); sendQuery(); }"></textarea>
                
                <button class="send-btn" onclick="sendQuery()">
                    Send Question â¤
                </button>
            </div>
            <div class="response-container" id="responseContainer"></div>
        </div>
<!-- Watermark -->
<div class="watermark" id="watermark"></div>
    </div>

<style>
#loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
}
</style>

<div id="loading-screen">
    <div style="text-align: center; color: white;">
        <div style="font-size: 50px; margin-bottom: 20px;">â³</div>
        <h2>Loading...</h2>
    </div>
</div>

<script>
window.addEventListener('load', () => {
    document.getElementById('loading-screen').style.display = 'none';
});
</script>

<script>
let assistantQAData = null;
let userRollNumber = null;
let userDeviceId = null;
let sessionStartTime = null;
let consentChecked = false;

// Configuration
const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSV_NiKHXWdgB75gy-qNFLeeVUzTEM5ysWxeZqQ3Fj0MjvTTBr2EAaQe5hqz1Wd8xd/exec';
let currentTest = null;
let userAnswers = {};
let currentAudio = null;
let autoplayEnabled = true;
let cumulativeScore = 0;              // âœ… ADD THIS
let cumulativeTotalMarks = 0;         // âœ… ADD THIS

// Device Fingerprinting
function generateDeviceFingerprint() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('fingerprint', 2, 2);
    const canvasData = canvas.toDataURL();
    
    const fingerprint = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        screenRes: `${screen.width}x${screen.height}x${screen.colorDepth}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        canvas: hashString(canvasData),
        webGL: getWebGLFingerprint(),
        cpuCores: navigator.hardwareConcurrency || 'unknown',
        deviceMemory: navigator.deviceMemory || 'unknown',
        touchSupport: 'ontouchstart' in window
    };
    
    return hashString(JSON.stringify(fingerprint));
}

function getWebGLFingerprint() {
    try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) return 'no-webgl';
        
        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
        if (!debugInfo) return 'no-debug-info';
        
        const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
        return hashString(renderer);
    } catch (e) {
        return 'error';
    }
}

function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return Math.abs(hash).toString(36);
}

// Message Display Helper
function showMessage(message, type = 'error') {
    const messageBox = document.getElementById('messageBox');
    messageBox.textContent = message;
    messageBox.className = `message ${type} show`;
    
    if (type !== 'loading') {
        setTimeout(() => {
            messageBox.classList.remove('show');
        }, 8000);
    }
}

// Consent Checkbox Toggle
function toggleConsentCheckbox() {
    consentChecked = !consentChecked;
    const checkbox = document.getElementById('consentCheckbox');
    const enterBtn = document.getElementById('enterBtn');
    
    if (consentChecked) {
        checkbox.style.background = '#4CAF50';
        checkbox.style.borderColor = '#4CAF50';
        checkbox.innerHTML = '<span style="color: white; font-size: 16px; font-weight: bold;">âœ“</span>';
        enterBtn.style.opacity = '1';
    } else {
        checkbox.style.background = 'transparent';
        checkbox.style.borderColor = '#666';
        checkbox.innerHTML = '';
        enterBtn.style.opacity = '0.6';
    }
}

// Roll Number Validation
async function validateAndEnter() {
    if (!assistantQAData) {
        await loadAssistantData();
    }
    const rollInput = document.getElementById('rollInput');
    const rollNumber = parseInt(rollInput.value);
    const enterBtn = document.getElementById('enterBtn');
    
    // Check consent first
    if (!consentChecked) {
        showMessage('âš ï¸ Please accept the consent to continue', 'error');
        return;
    }
    
    // Validate input
    if (isNaN(rollNumber) || rollNumber <= 0) {
        showMessage('âš ï¸ Please enter a valid roll number', 'error');
        rollInput.style.borderColor = '#ff6b6b';
        setTimeout(() => {
            rollInput.style.borderColor = '#667eea';
        }, 3000);
        return;
    }
    
    // Disable button and show loading
    enterBtn.disabled = true;
    enterBtn.textContent = 'â³ Verifying...';
    showMessage('ğŸ” Verifying your roll number with server...', 'loading');
    
    // Generate device fingerprint
    userDeviceId = generateDeviceFingerprint();
    console.log('Device ID:', userDeviceId);
    
    // Browser info
    const getBrowserType = () => {
        const ua = navigator.userAgent.toLowerCase();
        if (ua.includes('chrome')) return 'Chrome';
        if (ua.includes('firefox')) return 'Firefox';
        if (ua.includes('safari')) return 'Safari';
        if (ua.includes('edge')) return 'Edge';
        return 'Other';
    };
    
    const getDeviceType = () => {
        if (/mobile|android|iphone/i.test(navigator.userAgent)) return 'Mobile';
        if (/tablet|ipad/i.test(navigator.userAgent)) return 'Tablet';
        return 'Desktop';
    };
    
    const browserInfo = `${getBrowserType()} | ${getDeviceType()}`;
    
    try {
        // Send verification request
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain',
            },
          
body: JSON.stringify({
    rollNumber: rollNumber,
    deviceId: userDeviceId,
    browserInfo: browserInfo,
    timestamp: new Date().toISOString(),
    appType: 'learning-assistant' // âœ… MAKE SURE THIS IS SET
})
        });
        
        const result = await response.json();
        console.log('Server response:', result);
        
        if (result.success) {
            // SUCCESS
            userRollNumber = rollNumber;
            sessionStartTime = new Date();
            
            showMessage(result.message || 'âœ… Roll number verified successfully!', 'success');
            
            setTimeout(() => {
                const welcomePage = document.getElementById('welcomePage');
welcomePage.style.display = 'none';
welcomePage.classList.remove('active');
               const mainApp = document.getElementById('mainApp');
mainApp.classList.add('show');
mainApp.classList.remove('hidden');
mainApp.style.display = 'block';
                document.getElementById('userInfo').innerHTML = `<span style="font-size: 18px;">ğŸ“</span><span style="letter-spacing: 0.5px;">Roll: ${rollNumber}</span>`;
                updateWatermark();
                loadAssistantData();
            }, 1500);
            
        } else {
            // FAILED
            showMessage(result.message || 'âŒ Verification failed', 'error');
            enterBtn.disabled = false;
            enterBtn.textContent = 'ğŸš€ Start Learning';
        }
        
    } catch (error) {
        console.error('Verification error:', error);
        showMessage('âŒ Connection error. Please check your internet and try again.', 'error');
        enterBtn.disabled = false;
        enterBtn.textContent = 'ğŸš€ Start Learning';
    }
}

// Watermark Update
function updateWatermark() {
    const watermark = document.getElementById('watermark');
    if (watermark && userRollNumber) {
        const now = new Date();
        watermark.textContent = `Roll: ${userRollNumber} | ${now.toLocaleTimeString('en-IN')}`;
        
        setInterval(() => {
            const time = new Date().toLocaleTimeString('en-IN');
            watermark.textContent = `Roll: ${userRollNumber} | ${time}`;
        }, 60000);
    }
}

// Enter Key Support
window.addEventListener('DOMContentLoaded', function() {
    const rollInput = document.getElementById('rollInput');
    if (rollInput) {
        rollInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                validateAndEnter();
            }
        });
    }
});

// Session Monitoring
let inactivityTimer;
const INACTIVITY_LIMIT = 30 * 60 * 1000; // 30 minutes

function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        alert('â° Session expired due to inactivity. Please refresh the page.');
        location.reload();
    }, INACTIVITY_LIMIT);
}

['mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer);
});

resetInactivityTimer();



let shownQuestions = {
    mcq: [],
    truefalse: [],
    fillblank: [],
    fillblanks: [],
    matching: [],
    word_arrangement: []
};

const CATEGORIES = {
    'bare_act': 'ğŸ“œ Bare Section',
    'subsection_1': 'ğŸ“‹ Subsection-1',
    'subsection_2': 'ğŸ“‹ Subsection-2',
    'explanation_subsection_2': 'ğŸ’¡ Explanation to Subsection-2',
    'subsection_3': 'ğŸ“‹ Subsection-3',
    'footnote': 'ğŸ“ Footnote'
};

const CONCEPT_CATEGORIES = {
    'bare_act': 'ğŸ“œ Bare Section',
    'subsection_1': 'ğŸ“‹ Subsection-1',
    'subsection_2': 'ğŸ“‹ Subsection-2',
    'explanation_to_subsection_2': 'ğŸ’¡ Explanation to Subsection-2',
    'subsection_3': 'ğŸ“‹ Subsection-3',
    'footnote': 'ğŸ“ Footnote'              // âœ… Only keep this one
};

async function loadAssistantData() {
    try {
        console.log('ğŸ”„ Loading assistant data...');
        console.log('ğŸŒ Fetching from GitHub Raw...');
        
        const timestamp = Date.now();
        
        // âœ… GitHub Raw URL with cache buster
        const response = await fetch(`https://raw.githubusercontent.com/eguruOdisha/BNSS/main/s1assistant-qa.json?t=${timestamp}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('âœ… Raw data received:', data);
        
        // Fix data structure
        assistantQAData = Array.isArray(data) ? data[0] : data;
        
        console.log('âœ… Assistant data loaded successfully');
        console.log('ğŸ“Š Data structure:', Object.keys(assistantQAData));
        
    } catch (error) {
        console.error('âŒ Failed to load assistant data:', error);
        assistantQAData = null;
        alert('âš ï¸ Failed to load database. Please refresh the page.');
    }
}
    
function getMermaidForCategory(category) {
    const mermaidGraphs = {
        'bare_act': `
graph TD
    A[BNSS Section 1] --> B[Short Title]
    A --> C[Extent]
    A --> D[Commencement]
    B --> E[Bharatiya Nagarik<br/>Suraksha Sanhita 2023]
    C --> F[Special Provisions<br/>for Nagaland]
    C --> G[Tribal Areas<br/>Exceptions]
    D --> H[Notified Date:<br/>1st July 2024]
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style E fill:#4CAF50,stroke:#45a049,color:#fff
`,
        'subsection_1': `
graph LR
    A[Subsection 1] --> B[Short Title]
    B --> C[Bharatiya Nagarik<br/>Suraksha Sanhita]
    B --> D[Year: 2023]
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style C fill:#4CAF50,stroke:#45a049,color:#fff
`,
        'subsection_2': `
graph TD
    A[Subsection 2:<br/>Extent] --> B[General Application]
    A --> C[Exceptions]
    C --> D[Nagaland State]
    C --> E[Tribal Areas]
    E --> F[Assam Tribal Areas<br/>pre-1972]
    E --> G[Excluding Shillong<br/>Municipality]
    D --> H[State Govt can<br/>notify application]
    E --> H
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style C fill:#FF6B6B,stroke:#FF8E53,color:#fff
`,
        'explanation_to_subsection_2': `
graph TD
    A[Explanation to<br/>Subsection 2] --> B[Defines 'Tribal Areas']
    B --> C[Territories before<br/>21st January 1972]
    C --> D[Included in Assam<br/>Tribal Areas]
    D --> E[As per Sixth Schedule<br/>to Constitution]
    E --> F[Paragraph 20]
    C --> G[Exclusion: Shillong<br/>Municipality]
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style B fill:#FFA726,stroke:#FB8C00,color:#fff
`,
        'subsection_3': `
graph LR
    A[Subsection 3:<br/>Commencement] --> B[Central Govt<br/>Notification]
    B --> C[Official Gazette]
    C --> D[Appointed Date:<br/>1st July 2024]
    D --> E[Except Section<br/>106 2]
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style D fill:#4CAF50,stroke:#45a049,color:#fff
`,
        'footnote': `
graph TD
    A[Footnote 1] --> B[Commencement Date]
    B --> C[1st July 2024]
    C --> D[Exception]
    D --> E[Section 106 2<br/>in First Schedule]
    B --> F[Notification Details]
    F --> G[S.O. 848 E]
    F --> H[Date: 23rd Feb 2024]
    F --> I[Gazette of India<br/>Extraordinary]
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style C fill:#4CAF50,stroke:#45a049,color:#fff
    style E fill:#FF6B6B,stroke:#FF8E53,color:#fff
`
    };
    
    return mermaidGraphs[category] || null;
}

// UI FUNCTIONS
function toggleActions() {
    const actionGrid = document.getElementById('actionGrid');
    const mainBtn = document.getElementById('mainActionBtn');
    const arrow = mainBtn.querySelector('span');
    
    if (actionGrid.classList.contains('hidden')) {
        actionGrid.classList.remove('hidden');
        arrow.textContent = 'â–²';
    } else {
        actionGrid.classList.add('hidden');
        arrow.textContent = 'â–¼';
    }
}


function toggleAutoplay() {
    autoplayEnabled = document.getElementById('autoplayCheckbox').checked;
    console.log('Autoplay:', autoplayEnabled ? 'Enabled' : 'Disabled');
}

// AUDIO FUNCTIONS
function playAudio(audioUrl) {
    if (!audioUrl) return;
    
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
    }
    
    currentAudio = new Audio(audioUrl);
    
    currentAudio.addEventListener('ended', () => {
        updatePlayButton(false);
    });
    
    currentAudio.addEventListener('play', () => {
        updatePlayButton(true);
    });
    
    currentAudio.play().catch(error => {
        console.error('Audio playback failed:', error);
        alert('âš ï¸ Audio playback failed. Please check your internet connection.');
    });
}

function togglePlayStop() {
    if (!currentAudio) return;
    
    if (currentAudio.paused) {
        currentAudio.play();
    } else {
        currentAudio.pause();
        updatePlayButton(false);
    }
}

function updatePlayButton(isPlaying) {
    const playBtn = document.getElementById('playStopBtn');
    if (!playBtn) return;
    
    if (isPlaying) {
        playBtn.innerHTML = '<span style="font-size: 18px;">â¸ï¸</span> Stop Audio';
        playBtn.classList.add('playing');
    } else {
        playBtn.innerHTML = '<span style="font-size: 18px;">â–¶ï¸</span> Play Audio';
        playBtn.classList.remove('playing');
    }
}


function sendQuery() {
    try {
        const inputElement = document.getElementById('assistantInput');
        const query = (inputElement && inputElement.value) ? inputElement.value.trim() : '';
        if (!query) {
            alert('âš ï¸ Please write your question first.');
            return;
        }

        const normalizedQuery = query.toLowerCase().replace(/\s+/g, ' ').trim();
        console.log('ğŸ” Query:', query);
        console.log('ğŸ” Normalized:', normalizedQuery);

        // Extract all numbers from the query
        const numberMatches = normalizedQuery.match(/\d+/g);
        const extractedNumber = numberMatches ? parseInt(numberMatches[numberMatches.length - 1], 10) : null;
        
        console.log('ğŸ”¢ Extracted number:', extractedNumber);

        // Enhanced category patterns - MORE SPECIFIC MATCHING
        const CATEGORY_PATTERNS = [
            { 
                key: 'explanation_to_subsection_2', 
                patterns: [
                    'explanation to subsection 2',
                    'explanation subsection 2',
                    'explanation to subsection two',
                    'explanation subsection two',
                    'explanation to sub section 2',
                    'explanation sub section 2',
                    'explanation to subsection2',
                    'explanation subsection2'
                ]
            },
            { 
                key: 'subsection_1', 
                patterns: [
                    'subsection 1',
                    'subsection one',
                    'sub section 1',
                    'sub section one',
                    'subsection1',
                    'subsection-1'
                ]
            },
            { 
                key: 'subsection_2', 
                patterns: [
                    'subsection 2',
                    'subsection two',
                    'sub section 2',
                    'sub section two',
                    'subsection2',
                    'subsection-2'
                ]
            },
            { 
                key: 'subsection_3', 
                patterns: [
                    'subsection 3',
                    'subsection three',
                    'sub section 3',
                    'sub section three',
                    'subsection3',
                    'subsection-3'
                ]
            },
            { 
                key: 'footnote', 
                patterns: [
                    'footnote',
                    'foot note',
                    'foot notes',
                    'foot-note'
                ]
            },
            { 
                key: 'bare_act', 
                patterns: [
                    'bare act',
                    'bare section',
                    'section 1',
                    'section one',
                    'bareact',
                    'bare-act'
                ]
            }
        ];

        let detectedCategory = null;
        // Sort patterns by length (longest first) for better matching
        for (const catObj of CATEGORY_PATTERNS) {
            const sortedPatterns = catObj.patterns.sort((a, b) => b.length - a.length);
            for (const pattern of sortedPatterns) {
                if (normalizedQuery.includes(pattern)) {
                    detectedCategory = catObj.key;
                    break;
                }
            }
            if (detectedCategory) break;
        }

        console.log('ğŸ·ï¸ Detected category:', detectedCategory);

        // âœ… NEW: WH QUESTION HANDLER (RULE-1)
        const WH_WORDS = [
            { key: 'what', patterns: ['what is', 'what are', 'what'] },
            { key: 'why', patterns: ['why is', 'why are', 'why'] },
            { key: 'where', patterns: ['where is', 'where are', 'where'] },
            { key: 'when', patterns: ['when is', 'when are', 'when'] },
            { key: 'which', patterns: ['which is', 'which are', 'which'] },
            { key: 'how', patterns: ['how is', 'how are', 'how does', 'how'] }
        ];

        let detectedWhWord = null;
        
        // Check for WH words
        for (const whObj of WH_WORDS) {
            const sortedPatterns = whObj.patterns.sort((a, b) => b.length - a.length);
            for (const pattern of sortedPatterns) {
                if (normalizedQuery.includes(pattern)) {
                    detectedWhWord = whObj.key;
                    break;
                }
            }
            if (detectedWhWord) break;
        }

        console.log('â“ Detected WH word:', detectedWhWord);

        // âœ… RULE-1: If WH word + Category detected, answer the WH question
        if (detectedWhWord && detectedCategory) {
            console.log('âœ… RULE-1: WH Question + Category detected');
            console.log(`   - WH: ${detectedWhWord}`);
            console.log(`   - Category: ${detectedCategory}`);
            
            // Clear input
            inputElement.value = '';
            
            // Show loading
            showLoadingMessage(`Finding ${detectedWhWord} about ${CATEGORIES[detectedCategory] || detectedCategory}...`);
            
            // Answer the WH question
            setTimeout(() => answerWhQuestion(detectedWhWord, detectedCategory), 500);
            return;
        }

        // âœ… NEW: GENERAL DAY-TO-DAY QUERIES HANDLER
        const generalResponses = handleGeneralQuery(normalizedQuery);
        if (generalResponses) {
            inputElement.value = '';
            showGeneralResponse(generalResponses);
            return;
        }

        // Test type detection - IMPROVED ORDER (check specific patterns first)
        
        const TEST_TYPES = {
            mcq: ['mcq', 'multiple choice', 'multiple-choice', 'mcqs'],
            truefalse: ['true false', 'truefalse', 'true/false', 'true or false'],
            fillblanks: ['fill in blank', 'fill in blanks', 'fill blank', 'fill blanks', 'fill in the blank', 'fill in the blanks', 'fillinblank'],
            matching: ['matching', 'matches', 'match'],
            arrange: ['arrangement', 'arrange word', 'arrange words', 'arrange']
        };

        let detectedTestType = null;
        // Check in priority order (more specific first)
        for (const [key, patterns] of Object.entries(TEST_TYPES)) {
            const sortedPatterns = patterns.sort((a, b) => b.length - a.length);
            for (const pattern of sortedPatterns) {
                if (normalizedQuery.includes(pattern)) {
                    detectedTestType = key;
                    break;
                }
            }
            if (detectedTestType) break;
        }

        console.log('ğŸ§¾ Detected test type:', detectedTestType);

        // Clear input
        inputElement.value = '';

        // RULE K: Category name only (no test type, no number) - Show concept & example
if (detectedCategory && !detectedTestType) {
    console.log('âœ… RULE K: Showing concept for category only (from prompt)');
    showLoadingMessage('Loading concept & example...');
    setTimeout(() => showConceptContent(detectedCategory, true), 500);  // true = from prompt
    return;
}
        // ========== MCQ RULES ==========
        if (detectedTestType === 'mcq') {
            if (extractedNumber) {
                if (detectedCategory) {
                    // RULE B: Direct start with category
                    const pool = getCategoryQuestionPool(detectedCategory, 'mcq_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No MCQ questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(extractedNumber, pool.length);
                    if (extractedNumber > pool.length) {
                        alert(`âš ï¸ Only ${pool.length} questions available. Starting test with ${pool.length} questions.`);
                    }
                    showLoadingMessage('Loading your MCQ test...');
                    setTimeout(() => startTestWithCategory('mcq', detectedCategory, count), 500);
                } else {
                    // RULE A: Show category selection with typewriting view
                    showNumberBasedTestSelection('mcq', extractedNumber);
                }
            } else {
                // No number provided - Use default (5 questions)
                const defaultCount = 5;
                if (detectedCategory) {
                    const pool = getCategoryQuestionPool(detectedCategory, 'mcq_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No MCQ questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(defaultCount, pool.length);
                    showLoadingMessage('Loading your MCQ test...');
                    setTimeout(() => startTestWithCategory('mcq', detectedCategory, count), 500);
                } else {
                    showNumberBasedTestSelection('mcq', defaultCount);
                }
            }
            return;
        }

        // ========== TRUE/FALSE RULES ==========
        if (detectedTestType === 'truefalse') {
            if (extractedNumber) {
                if (detectedCategory) {
                    // RULE D: Direct start with category
                    const pool = getCategoryQuestionPool(detectedCategory, 'truefalse_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No True/False questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(extractedNumber, pool.length);
                    if (extractedNumber > pool.length) {
                        alert(`âš ï¸ Only ${pool.length} questions available. Starting test with ${pool.length} questions.`);
                    }
                    showLoadingMessage('Loading your True/False test...');
                    setTimeout(() => startTestWithCategory('truefalse', detectedCategory, count), 500);
                } else {
                    // RULE C: Show category selection with typewriting view
                    showNumberBasedTestSelection('truefalse', extractedNumber);
                }
            } else {
                // No number provided - Use default (5 questions)
                const defaultCount = 5;
                if (detectedCategory) {
                    const pool = getCategoryQuestionPool(detectedCategory, 'truefalse_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No True/False questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(defaultCount, pool.length);
                    showLoadingMessage('Loading your True/False test...');
                    setTimeout(() => startTestWithCategory('truefalse', detectedCategory, count), 500);
                } else {
                    showNumberBasedTestSelection('truefalse', defaultCount);
                }
            }
            return;
        }

        // ========== FILL BLANKS RULES ==========
        if (detectedTestType === 'fillblanks') {
            if (extractedNumber) {
                if (detectedCategory) {
                    // RULE F: Direct start with category
                    const pool = getCategoryQuestionPool(detectedCategory, 'fillblank_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Fill in the Blanks questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(extractedNumber, pool.length);
                    if (extractedNumber > pool.length) {
                        alert(`âš ï¸ Only ${pool.length} questions available. Starting test with ${pool.length} questions.`);
                    }
                    showLoadingMessage('Loading your Fill in the Blanks test...');
                    setTimeout(() => startTestWithCategory('fillblanks', detectedCategory, count), 500);
                } else {
                    // RULE E: Show category selection with typewriting view
                    showNumberBasedTestSelection('fillblanks', extractedNumber);
                }
            } else {
                // No number provided - Use default (5 questions)
                const defaultCount = 5;
                if (detectedCategory) {
                    const pool = getCategoryQuestionPool(detectedCategory, 'fillblank_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Fill in the Blanks questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(defaultCount, pool.length);
                    showLoadingMessage('Loading your Fill in the Blanks test...');
                    setTimeout(() => startTestWithCategory('fillblanks', detectedCategory, count), 500);
                } else {
                    showNumberBasedTestSelection('fillblanks', defaultCount);
                }
            }
            return;
        }

        // ========== MATCHING RULES ==========
        if (detectedTestType === 'matching') {
            if (extractedNumber) {
                // RULE G: Number provided - show category selection
                if (detectedCategory) {
                    // RULE H: Direct start with category and number
                    const pool = getCategoryQuestionPool(detectedCategory, 'matching_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Matching exercises available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(extractedNumber, pool.length);
                    if (extractedNumber > pool.length) {
                        alert(`âš ï¸ Only ${pool.length} exercises available. Starting with ${pool.length} exercises.`);
                    }
                    showLoadingMessage('Loading your Matching exercises...');
                    setTimeout(() => startTestWithCategory('matching', detectedCategory, count), 500);
                } else {
                    // RULE G: Show category selection
                    showNumberBasedTestSelection('matching', extractedNumber);
                }
            } else {
                // No number - default behavior (all exercises)
                if (detectedCategory) {
                    const pool = getCategoryQuestionPool(detectedCategory, 'matching_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Matching exercises available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    showLoadingMessage('Loading your Matching exercises...');
                    setTimeout(() => startTestWithCategory('matching', detectedCategory, pool.length), 500);
                } else {
                    showNumberBasedTestSelection('matching', 1);
                }
            }
            return;
        }

        // ========== ARRANGE/WORDS RULES ==========
        if (detectedTestType === 'arrange') {
            if (extractedNumber) {
                // RULE I: Number provided - show category selection
                if (detectedCategory) {
                    // RULE J: Direct start with category and number
                    const pool = getCategoryQuestionPool(detectedCategory, 'word_arrangement_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Word Arrangement exercises available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(extractedNumber, pool.length);
                    if (extractedNumber > pool.length) {
                        alert(`âš ï¸ Only ${pool.length} exercises available. Starting with ${pool.length} exercises.`);
                    }
                    showLoadingMessage('Loading your Word Arrangement exercises...');
                    setTimeout(() => startTestWithCategory('arrange', detectedCategory, count), 500);
                } else {
                    // RULE I: Show category selection
                    showNumberBasedTestSelection('arrange', extractedNumber);
                }
            } else {
                // No number - default behavior (all exercises)
                if (detectedCategory) {
                    const pool = getCategoryQuestionPool(detectedCategory, 'word_arrangement_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Word Arrangement exercises available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    showLoadingMessage('Loading your Word Arrangement exercises...');
                    setTimeout(() => startTestWithCategory('arrange', detectedCategory, pool.length), 500);
                } else {
                    showNumberBasedTestSelection('arrange', 1);
                }
            }
            return;
        }

        // RULE M: If no match, search on Google
        const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}+BNSS`;
        window.open(googleSearchUrl, '_blank');
        showTestMessage('ğŸ” Searching on Google...');

    } catch (error) {
        console.error('âŒ Error in sendQuery:', error);
        alert('An unexpected error occurred while processing your query.');
    }
}

// âœ… NEW FUNCTION: Answer WH Questions
function answerWhQuestion(whWord, category) {
    if (!assistantQAData || !assistantQAData.section1) {
        console.error('âŒ assistantQAData not loaded');
        showErrorMessage('Database not loaded. Please refresh the page.');
        return;
    }
    
    console.log('ğŸ” Searching for WH answer:', { whWord, category });
    
    let content = null;
    
    // Search in bare_act
    if (category === 'bare_act' && assistantQAData.section1.bare_act) {
        if (assistantQAData.section1.bare_act[whWord]) {
            content = assistantQAData.section1.bare_act[whWord].content;
        }
    }
    
    // Search in subsections (subsection_1, subsection_2, subsection_3)
    if (!content && assistantQAData.section1.subsections && assistantQAData.section1.subsections[category]) {
        const subsection = assistantQAData.section1.subsections[category];
        if (subsection[whWord]) {
            content = subsection[whWord].content;
        }
    }
    
    // Search in special categories (explanation_to_subsection_2, footnote)
    if (!content && assistantQAData.section1[category]) {
        const section = assistantQAData.section1[category];
        if (section[whWord]) {
            content = section[whWord].content;
        }
    }
    
    // If content found
    if (content && content.length > 0) {
        console.log('âœ… WH answer found');
        const answerData = content[0];
       displayAnswer(answerData.text, answerData.audioUrl, true);
    } else {
        // No answer found
        const categoryLabel = CATEGORIES[category] || category;
        const whLabel = whWord.charAt(0).toUpperCase() + whWord.slice(1);
        
        showErrorMessage(`No "${whLabel}" answer available for ${categoryLabel}.`);
        console.log('âŒ No WH answer found for:', { whWord, category });
    }
}

// Helper function to show loading message
function showLoadingMessage(message) {
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #667eea;">
            <div style="font-size: 50px; margin-bottom: 20px;">â³</div>
            <h3>${message}</h3>
        </div>
    `;
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}

// Helper function to show error message
function showErrorMessage(message) {
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = `
        <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px; margin: 15px;">
            <p style="color: #856404; font-size: 15px; margin: 0;">
                âŒ ${message}
            </p>
        </div>
    `;
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}




function showConceptForCategory(category) {
    closeDropdown();
    
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #667eea;"><h3>Loading concept content...</h3></div>';
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    
    const content = findConceptContent(category);
    
    if (!content) {
        const categoryLabel = CONCEPT_CATEGORIES[category] || CATEGORIES[category] || category;
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px; margin: 0;">
                <p style="color: #856404; font-size: 15px; margin: 0;">
                    âŒ No concept & example content available for ${categoryLabel}.
                </p>
            </div>
        `;
        return;
    }
    
    displayAnswer(content.text, content.audioUrl);
}

function showCategoryExplanation(category) {
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #667eea;"><h3>Loading content...</h3></div>';
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    
    // Find the explanation content in your JSON
    const content = findCategoryExplanation(category);
    
    if (!content) {
        const categoryLabel = CATEGORIES[category] || category;
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px; margin: 0;">
                <p style="color: #856404; font-size: 15px; margin: 0;">
                    âŒ No explanation content available for ${categoryLabel}.
                </p>
            </div>
        `;
        return;
    }
    
    displayAnswer(content.text, content.audioUrl);
}

function findCategoryExplanation(category) {
    if (!assistantQAData || !assistantQAData.section1) {
        console.error('âŒ assistantQAData not loaded');
        return null;
    }
    
    console.log('ğŸ” Searching for explanation:', category);
    
    // Check in subsections first
    if (assistantQAData.section1.subsections && assistantQAData.section1.subsections[category]) {
        const subsection = assistantQAData.section1.subsections[category];
        if (subsection.explanation && subsection.explanation.content && subsection.explanation.content.length > 0) {
            console.log('âœ… Found explanation in subsection');
            return subsection.explanation.content[0];
        }
    }
    
    // Check direct properties
    if (assistantQAData.section1[category]) {
        const section = assistantQAData.section1[category];
        if (section.explanation && section.explanation.content && section.explanation.content.length > 0) {
            console.log('âœ… Found explanation at section level');
            return section.explanation.content[0];
        }
    }
    
    console.error('âŒ No explanation found for', category);
    return null;
}

function showNumberBasedTestSelection(testType, count) {
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    
    console.log('ğŸ” showNumberBasedTestSelection called:', { testType, count });
    
    // âœ… COMPLETE test labels for ALL types
    const testLabels = {
        'mcq': 'MCQ',
        'truefalse': 'True/False',
        'fillblanks': 'Fill in the Blanks',
        'matching': 'Matching',
        'arrange': 'Word Arrangement'
    };
    
    const testLabel = testLabels[testType] || testType;
    
    console.log('âœ… Test label resolved:', testLabel); // Debug log
    
    // Different wording for exercises vs questions
    const isExercise = (testType === 'matching' || testType === 'arrange');
    const itemType = isExercise ? 'Exercise' : 'Question';
    const itemTypePlural = isExercise ? 'Exercises' : 'Questions';
    
    const displayText = count > 1 ? itemTypePlural : itemType;
    
    console.log('âœ… Display text:', displayText); // Debug log
    
    // TYPEWRITING STYLE - Clean white background with blue category buttons
    let html = `
        <div style="background: white; border-radius: 12px; padding: 25px; margin: 15px; box-shadow: 0 3px 15px rgba(0,0,0,0.1);">
            <h3 style="color: #667eea; text-align: center; margin-bottom: 20px; font-size: 20px;">
                ğŸ“š Select Category for ${count} ${testLabel} ${displayText}
            </h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
    `;
    
    const poolMap = {
        'mcq': 'mcq_pool',
        'truefalse': 'truefalse_pool',
        'fillblanks': 'fillblank_pool',
        'matching': 'matching_pool',
        'arrange': 'word_arrangement_pool'
    };
    
    const poolName = poolMap[testType];
    console.log('ğŸ” Pool name:', poolName);
    
    let hasCategories = false;
    
    for (const [key, label] of Object.entries(CATEGORIES)) {
        const pool = getCategoryQuestionPool(key, poolName);
        const availableCount = pool ? pool.length : 0;
        
        console.log(`ğŸ“Š ${key}: ${availableCount} items in ${poolName}`);
        
        // Show button if enough items are available
        if (availableCount >= count) {
            hasCategories = true;
            html += `
                <button onclick="startTestWithCategory('${testType}', '${key}', ${count})"
                        style="width: 100%;
                               background: linear-gradient(135deg, #667eea, #764ba2); 
                               border: none; 
                               color: white; 
                               padding: 15px; 
                               border-radius: 10px; 
                               font-size: 15px; 
                               font-weight: 700; 
                               cursor: pointer; 
                               transition: all 0.3s ease;
                               text-align: left;
                               box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(102, 126, 234, 0.5)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(102, 126, 234, 0.3)';">
                    ${label}
                    <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">
                        âœ“ ${availableCount} ${isExercise ? 'exercises' : 'questions'} available
                    </div>
                </button>
            `;
        }
    }
    
    if (!hasCategories) {
        html += `
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px;">
                <p style="color: #856404; font-size: 15px; margin: 0;">
                    âŒ No categories have ${count} ${displayText.toLowerCase()} available for ${testLabel}.
                </p>
            </div>
        `;
    }
    
    html += `
            </div>
            <button onclick="resetTest()"
                    style="width: 100%;
                           background: #f44336; 
                           color: white; 
                           border: none; 
                           padding: 12px; 
                           border-radius: 25px; 
                           font-size: 14px; 
                           font-weight: 600; 
                           cursor: pointer;
                           margin-top: 15px;
                           transition: all 0.3s ease;"
                    onmouseover="this.style.background='#d32f2f'"
                    onmouseout="this.style.background='#f44336'">
                âœ• Cancel
            </button>
        </div>
    `;
    
    container.innerHTML = html;
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}


// DISPLAY FUNCTIONS
function showTestMessage(message) {
    const container = document.getElementById('responseContainer');
    container.innerHTML = `
        <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px; margin: 0;">
            <p style="color: #856404; font-size: 15px; margin: 0;">${message}</p>
        </div>
    `;
}


function displayAnswer(answer, audioUrl, isWhQuestion = false, isConceptFromPrompt = false) {
    const container = document.getElementById('responseContainer');
    
    const hasValidAudio = audioUrl && 
                          audioUrl.trim() !== '' && 
                          (audioUrl.startsWith('http://') || audioUrl.startsWith('https://') || audioUrl.startsWith('blob:'));
    
    let audioControlHTML = '';
    if (hasValidAudio) {
        audioControlHTML = `
            <div style="margin-top: 15px; text-align: center;">
                <button id="playStopBtn" onclick="togglePlayStop()" class="play-stop-btn" style="width: auto; min-width: 180px;">
                    <span style="font-size: 18px;">â–¶ï¸</span> Play Audio
                </button>
            </div>
        `;
    }
    
    const containsHTML = /<br>|<\/br>|<p>|<\/p>|<div>|<\/div>|<ul>|<\/ul>|<li>|<\/li>|<strong>|<\/strong>|<b>|<\/b>|<i>|<\/i>/i.test(answer);
    
    // Create unique ID for this answer
    const answerId = 'answer-text-' + Date.now();
    
    // Get category mermaid graph if displaying concept content
    let categoryImageHTML = '';
    if (currentTest && currentTest.displayingCategory) {
        const mermaidCode = getMermaidForCategory(currentTest.displayingCategory);
        if (mermaidCode) {
            const mermaidId = 'mermaid-' + Date.now();
            categoryImageHTML = `
                <div style="margin-bottom: 20px; text-align: center; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <div class="mermaid" id="${mermaidId}">${mermaidCode}</div>
                </div>
            `;
        }
    }
    
    container.innerHTML = `
        <div style="background: white; border-radius: 10px; padding: 20px; margin: 0; box-shadow: 0 3 15px rgba(0,0,0,0.1);">
            ${categoryImageHTML}
            <div style="color: #667eea; font-weight: bold; font-size: 16px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
                ğŸ“ Answer:
            </div>
            <div id="typewriterText" style="color: #000; font-size: 15px; line-height: 1.6; white-space: pre-wrap; text-align: justify;">
            </div>
            
            <!-- Hidden div for translation with full text -->
            <div id="${answerId}" style="display: none;">${answer.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '')}</div>
            
            <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; padding: 10px 0; border-top: 1px solid #e0e0e0;">
                <button onclick="translateTextInNewTab('${answerId}', 'or')" style="background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; border: none; padding: 10px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3); white-space: nowrap;">
                    ğŸŒ à¬“à¬¡à¬¼à¬¿à¬† (Odia)
                </button>
                <button onclick="translateTextInNewTab('${answerId}', 'bn')" style="background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; border: none; padding: 10px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(78, 205, 196, 0.3); white-space: nowrap;">
                    ğŸŒ à¦¬à¦¾à¦‚à¦²à¦¾ (Bengali)
                </button>
                <button onclick="translateTextInNewTab('${answerId}', 'hi')" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); white-space: nowrap;">
                    ğŸŒ à¤¹à¤¿à¤‚à¤¦à¥€ (Hindi)
                </button>
            </div>
            
            ${audioControlHTML}
        </div>
    `;
    
    window.currentAudioUrl = audioUrl;

    // Only autoplay if enabled AND it's from a prompt (WH question or concept from prompt)
    if (autoplayEnabled && hasValidAudio && audioUrl && (isWhQuestion || isConceptFromPrompt)) {
        playAudio(audioUrl);
    }
    
    const textElement = document.getElementById('typewriterText');
    
    // âœ… FIXED: Always use typewriter for prompts, strip HTML if needed
    if (isWhQuestion || isConceptFromPrompt) {
        // Strip HTML tags for typewriter display
        const plainText = answer.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '').trim();
        typewriterEffect(plainText, textElement, isConceptFromPrompt ? 90 : 20);
    } else {
        // For non-WH questions (manual category selection), display immediately
        if (containsHTML) {
            textElement.innerHTML = answer;
        } else {
            textElement.textContent = answer;
        }
    }
    
// Reinitialize mermaid for dynamically added diagrams
if (typeof mermaid !== 'undefined') {
    setTimeout(() => {
        mermaid.init(undefined, document.querySelectorAll('.mermaid'));
    }, 100);
}
}

// âœ… Typewriter function remains the same
function typewriterEffect(text, element, speed = 20) {
    let index = 0;
    
    element.textContent = ''; // Clear existing content
    
    function type() {
        if (index < text.length) {
            element.textContent += text.charAt(index);
            index++;
            setTimeout(type, speed);
        }
    }
    
    type();
}

// QUICK ACTION FUNCTIONS
function quickAction(action) {
    if (action === 'concept') {
        showConceptCategories();
        return;
    }
    
    selectedTestType = action;
    showInlineCategories(action);
}

function showConceptCategories() {
    document.querySelectorAll('.category-dropdown').forEach(dd => dd.remove());
    
    const buttons = document.querySelectorAll('.action-btn');
    let targetButton = null;
    
    buttons.forEach(btn => {
        if (btn.textContent.includes('Concept & Example')) {
            targetButton = btn;
        }
    });
    
    if (!targetButton) return;
    
    const dropdown = document.createElement('div');
    dropdown.className = 'category-dropdown';
    dropdown.style.cssText = `
        position: fixed;
        background: white;
        border: 3px solid #667eea;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 300px;
        max-width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        padding: 15px;
    `;
    
    let html = `
        <div style="color: #667eea; font-weight: 900; font-size: 14px; margin-bottom: 12px; text-align: center; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
            ğŸ’¡ Select Category for Concept & Example
        </div>
    `;
    
    for (const [key, label] of Object.entries(CONCEPT_CATEGORIES)) {
        html += `
            <button onclick="showConceptContent('${key}')" 
                    style="width: 100%;
                           background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                           border: 2px solid #dee2e6; 
                           color: #333; 
                           padding: 12px; 
                           border-radius: 8px; 
                           font-size: 13px; 
                           font-weight: 700; 
                           cursor: pointer; 
                           transition: all 0.3s ease;
                           text-align: left;
                           margin-bottom: 8px;"
                    onmouseover="this.style.background='linear-gradient(135deg, #667eea, #764ba2)'; this.style.color='white'; this.style.borderColor='#667eea'; this.style.transform='translateX(3px)';"
                    onmouseout="this.style.background='linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)'; this.style.color='#333'; this.style.borderColor='#dee2e6'; this.style.transform='translateX(0)';">
                ${label}
            </button>
        `;
    }
    
    html += `
        <button onclick="closeDropdown()" 
                style="width: 100%;
                       background: #f44336; 
                       color: white; 
                       border: none; 
                       padding: 10px; 
                       border-radius: 20px; 
                       font-size: 12px; 
                       font-weight: 600; 
                       cursor: pointer;
                       margin-top: 8px;
                       transition: all 0.3s ease;"
                onmouseover="this.style.background='#d32f2f'"
                onmouseout="this.style.background='#f44336'">
            âœ• Close
        </button>
    `;
    
    dropdown.innerHTML = html;
    
    const rect = targetButton.getBoundingClientRect();
    dropdown.style.left = `${Math.min(rect.left, window.innerWidth - 320)}px`;
    dropdown.style.top = `${rect.bottom + 5}px`;
    
    document.body.appendChild(dropdown);
    
    const dropdownRect = dropdown.getBoundingClientRect();
    if (dropdownRect.bottom > window.innerHeight) {
        dropdown.style.top = `${rect.top - dropdownRect.height - 5}px`;
    }
    
    setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
    }, 100);
}

function showConceptContent(category, fromPrompt = false) {
    closeDropdown();
    
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #667eea;"><h3>Loading content...</h3></div>';
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    
    const content = findConceptContent(category);
    
    if (!content) {
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px; margin: 0;">
                <p style="color: #856404; font-size: 15px; margin: 0;">
                    âŒ No concept & example content available for ${CONCEPT_CATEGORIES[category]}.
                </p>
            </div>
        `;
        return;
    }
    
    // Store category for image display
    if (!currentTest) currentTest = {};
    currentTest.displayingCategory = category;
    
    // If from prompt: use typewriter + autoplay audio
    // If from button: no typewriter, no autoplay
    if (fromPrompt) {
        displayAnswer(content.text, content.audioUrl, false, true);  // true = isConceptFromPrompt
    } else {
        displayAnswer(content.text, null, false, false);  // null = no audio
    }
}

function findConceptContent(category) {
    if (!assistantQAData || !assistantQAData.section1) {
        console.error('âŒ assistantQAData not loaded');
        return null;
    }
    
    console.log('ğŸ” Searching for concept content:', category);
    console.log('ğŸ“Š Full section1 keys:', Object.keys(assistantQAData.section1));
    
    // âœ… Handle bare_act FIRST
    if (category === 'bare_act' && assistantQAData.section1.bare_act) {
        const bareAct = assistantQAData.section1.bare_act;
        
        if (bareAct.concept_with_example && 
            bareAct.concept_with_example.content && 
            bareAct.concept_with_example.content.length > 0) {
            
            console.log('âœ… Found concept content in bare_act');
            return bareAct.concept_with_example.content[0];
        }
    }
    
    // âœ… Check subsections FIRST (this is where footnote lives!)
    if (assistantQAData.section1.subsections) {
        console.log('ğŸ“Š Subsections keys:', Object.keys(assistantQAData.section1.subsections));
        
        // Try direct category match
        if (assistantQAData.section1.subsections[category]) {
            const subsection = assistantQAData.section1.subsections[category];
            
            if (subsection.concept_with_example && 
                subsection.concept_with_example.content && 
                subsection.concept_with_example.content.length > 0) {
                
                console.log('âœ… Found concept content in subsections.' + category);
                return subsection.concept_with_example.content[0];
            }
        }
        
        // âœ… Special case: if category is 'footnote', try 'footnote_1'
        if (category === 'footnote' && assistantQAData.section1.subsections.footnote_1) {
            const footnote = assistantQAData.section1.subsections.footnote_1;
            
            if (footnote.concept_with_example && 
                footnote.concept_with_example.content && 
                footnote.concept_with_example.content.length > 0) {
                
                console.log('âœ… Found concept content in subsections.footnote_1');
                return footnote.concept_with_example.content[0];
            }
        }
    }
    
    // Special handling for explanation_to_subsection_2 (might be at section1 level)
    if (category === 'explanation_to_subsection_2') {
        // Try section1 level first
        if (assistantQAData.section1.explanation_to_subsection_2) {
            const explanation = assistantQAData.section1.explanation_to_subsection_2;
            
            if (explanation.concept_with_example && 
                explanation.concept_with_example.content && 
                explanation.concept_with_example.content.length > 0) {
                
                console.log('âœ… Found concept content in explanation_to_subsection_2');
                return explanation.concept_with_example.content[0];
            }
        }
        
        // Try subsections level
        if (assistantQAData.section1.subsections && 
            assistantQAData.section1.subsections.explanation_to_subsection_2) {
            
            const explanation = assistantQAData.section1.subsections.explanation_to_subsection_2;
            
            if (explanation.concept_with_example && 
                explanation.concept_with_example.content && 
                explanation.concept_with_example.content.length > 0) {
                
                console.log('âœ… Found concept content in subsections.explanation_to_subsection_2');
                return explanation.concept_with_example.content[0];
            }
        }
    }
    
    // Generic fallback check at section1 level
    if (assistantQAData.section1[category]) {
        const section = assistantQAData.section1[category];
        
        if (section.concept_with_example && 
            section.concept_with_example.content && 
            section.concept_with_example.content.length > 0) {
            
            console.log('âœ… Found concept content at section1.' + category);
            return section.concept_with_example.content[0];
        }
    }
    
    console.error('âŒ No concept content found for', category);
    console.log('ğŸ“Š Available section1 properties:', Object.keys(assistantQAData.section1));
    if (assistantQAData.section1.subsections) {
        console.log('ğŸ“Š Available subsections:', Object.keys(assistantQAData.section1.subsections));
    }
    return null;
} 

function showInlineCategories(testType) {
    document.querySelectorAll('.category-dropdown').forEach(dd => dd.remove());
    
    const buttons = document.querySelectorAll('.action-btn');
    let targetButton = null;
    
    const testMap = {
        'mcq': 'MCQ Test',
        'truefalse': 'True/False',
        'fillblanks': 'Fill Blanks',
        'matching': 'Matching',
        'arrange': 'Arrange Words'
    };
    
    buttons.forEach(btn => {
        if (btn.textContent.includes(testMap[testType])) {
            targetButton = btn;
        }
    });
    
    if (!targetButton) return;
    
    const dropdown = document.createElement('div');
    dropdown.className = 'category-dropdown';
    dropdown.style.cssText = `
        position: fixed;
        background: white;
        border: 3px solid #667eea;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 300px;
        max-width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        padding: 15px;
    `;
    
    let html = `
        <div style="color: #667eea; font-weight: 900; font-size: 14px; margin-bottom: 12px; text-align: center; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
            ğŸ“š Select Category & Questions
        </div>
    `;
    
    for (const [key, label] of Object.entries(CATEGORIES)) {
        const poolMap = {
            'mcq': 'mcq_pool',
            'truefalse': 'truefalse_pool',
            'fillblanks': 'fillblank_pool',
            'matching': 'matching_pool',
            'arrange': 'word_arrangement_pool'
        };
        
        const poolName = poolMap[testType];
        const pool = getCategoryQuestionPool(key, poolName);
        const availableCount = pool ? pool.length : 0;
        
        if (availableCount === 0) {
            html += `
                <div style="background: #f5f5f5; 
                           border: 2px solid #e0e0e0; 
                           color: #999; 
                           padding: 12px; 
                           border-radius: 8px; 
                           font-size: 12px; 
                           text-align: left;
                           margin-bottom: 8px;
                           opacity: 0.6;">
                    ${label}
                    <div style="font-size: 10px; color: #f44336; margin-top: 4px;">
                        âŒ No questions available
                    </div>
                </div>
            `;
        } else {
            if (testType === 'matching' || testType === 'arrange') {
                html += `
                    <button onclick="startTestDirectly('${key}', '${testType}', 1)" 
                            style="width: 100%;
                                   background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                                   border: 2px solid #dee2e6; 
                                   color: #333; 
                                   padding: 12px; 
                                   border-radius: 8px; 
                                   font-size: 13px; 
                                   font-weight: 700; 
                                   cursor: pointer; 
                                   transition: all 0.3s ease;
                                   text-align: left;
                                   margin-bottom: 8px;"
                            onmouseover="this.style.background='linear-gradient(135deg, #667eea, #764ba2)'; this.style.color='white'; this.style.borderColor='#667eea'; this.style.transform='translateX(3px)';"
                            onmouseout="this.style.background='linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)'; this.style.color='#333'; this.style.borderColor='#dee2e6'; this.style.transform='translateX(0)';">
                        ${label}
                        <div style="font-size: 10px; color: #4CAF50; margin-top: 4px;">
                            âœ“ ${availableCount} exercise${availableCount > 1 ? 's' : ''} available
                        </div>
                    </button>
                `;
            } else {
                html += `
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                               border: 2px solid #dee2e6; 
                               border-radius: 8px; 
                               padding: 12px;
                               margin-bottom: 8px;">
                        <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 8px;">
                            ${label}
                        </div>
                        <div style="font-size: 10px; color: #4CAF50; margin-bottom: 10px;">
                            âœ“ ${availableCount} questions available
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <select id="count-${key}" 
                                   style="flex: 1;
                                          padding: 10px; 
                                          border: 2px solid #667eea; 
                                          border-radius: 8px; 
                                          font-size: 16px; 
                                          text-align: center; 
                                          font-weight: bold;
                                          background: white;
                                          color: #333;
                                          cursor: pointer;
                                          box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);">
                `;
                
                for (let i = 1; i <= availableCount; i++) {
                    const selected = i === Math.min(5, availableCount) ? 'selected' : '';
                    html += `<option value="${i}" ${selected}>${i} Question${i > 1 ? 's' : ''}</option>`;
                }
                
                html += `
                            </select>
                            <button onclick="startTestWithCount('${key}', '${testType}', ${availableCount})"
                                    style="background: linear-gradient(135deg, #4CAF50, #45a049); 
                                           color: white; 
                                           border: none; 
                                           padding: 10px 20px; 
                                           border-radius: 8px; 
                                           font-size: 14px; 
                                           font-weight: 700; 
                                           cursor: pointer;
                                           white-space: nowrap;
                                           box-shadow: 0 3px 10px rgba(76, 175, 80, 0.4);
                                           transition: all 0.3s ease;"
                                    onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(76, 175, 80, 0.6)'"
                                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 3px 10px rgba(76, 175, 80, 0.4)'">
                                Start â†’
                            </button>
                        </div>
                    </div>
                `;
            }
        }
    }
    
    html += `
        <button onclick="closeDropdown()" 
                style="width: 100%;
                       background: #f44336; 
                       color: white; 
                       border: none; 
                       padding: 10px; 
                       border-radius: 20px; 
                       font-size: 12px; 
                       font-weight: 600; 
                       cursor: pointer;
                       margin-top: 8px;
                       transition: all 0.3s ease;"
                onmouseover="this.style.background='#d32f2f'"
                onmouseout="this.style.background='#f44336'">
            âœ• Close
        </button>
    `;
    
    dropdown.innerHTML = html;
    
    const rect = targetButton.getBoundingClientRect();
    dropdown.style.left = `${Math.min(rect.left, window.innerWidth - 320)}px`;
    dropdown.style.top = `${rect.bottom + 5}px`;
    
    document.body.appendChild(dropdown);
    const dropdownRect = dropdown.getBoundingClientRect();
    if (dropdownRect.bottom > window.innerHeight) {
        dropdown.style.top = `${rect.top - dropdownRect.height - 5}px`;
    }
    
    setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
    }, 100);
}

function handleOutsideClick(e) {
    const dropdown = document.querySelector('.category-dropdown');
    if (dropdown && !dropdown.contains(e.target) && !e.target.classList.contains('action-btn')) {
        closeDropdown();
    }
}

function closeDropdown() {
    document.querySelectorAll('.category-dropdown').forEach(dd => dd.remove());
    document.removeEventListener('click', handleOutsideClick);
}

function startTestWithCount(category, testType, maxAllowed) {
    const input = document.getElementById(`count-${category}`);
    const count = parseInt(input.value) || 5;
    
    if (count < 1 || count > maxAllowed) {
        alert(`âš ï¸ Please enter a number between 1 and ${maxAllowed}`);
        return;
    }
    
    console.log('Starting test:', { category, testType, count });
    
    closeDropdown();
    
    setTimeout(() => {
        startTestWithCategory(testType, category, count);
    }, 100);
}

function startTestDirectly(category, testType, count) {
    console.log('Direct start:', { category, testType, count });
    
    closeDropdown();
    
    setTimeout(() => {
        startTestWithCategory(testType, category, count);
    }, 100);
}

// âœ… FUNCTION 1: GENERAL QUERY HANDLER WITH HINDI SUPPORT (ROMANIZED)
function handleGeneralQuery(query) {
    // Greetings (English + Romanized Hindi)
    const greetings = ['hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening', 'namaste', 'namaskar', 'suprabhat', 'shubh sandhya', 'pranam'];
    for (const greeting of greetings) {
        if (query.includes(greeting)) {
            return {
                text: `ğŸ™ Hello! Welcome to Odisha e-Guru Learning Platform.\n\nI'm your BNSS Section-1 assistant. I can help you with:\n\nğŸ“š Concepts & Examples\nğŸ“ MCQ Tests\nâœ“âœ— True/False Tests\nğŸ“‹ Fill in the Blanks\nğŸ”— Matching Exercises\nğŸ”¤ Word Arrangement\n\nHow can I assist you today?`,
                type: 'greeting'
            };
        }
    }
    
    // Help queries (English + Romanized Hindi)
    const helpPatterns = ['help', 'what can you do', 'how to use', 'guide me', 'assist me', 'can you help', 'madad', 'sahayata', 'kaise use kare', 'use', 'meri madad karo', 'kaise upyog kare'];
    for (const pattern of helpPatterns) {
        if (query.includes(pattern)) {
            return {
                text: `ğŸ’¡ Here's how to use me:\n\n1ï¸âƒ£ Ask for concepts: "Show me concept of Subsection-1"\n2ï¸âƒ£ Take tests: "Give me 5 MCQ questions on Bare Act"\n3ï¸âƒ£ Ask WH questions: "What is Subsection-2?"\n\nAvailable categories:\nğŸ“œ Bare Section\nğŸ“‹ Subsection-1, 2, 3\nğŸ’¡ Explanation to Subsection-2\nğŸ“ Footnote\n\nJust type your question!`,
                type: 'help'
            };
        }
    }
    
    // Thank you (English + Romanized Hindi)
    const thankPatterns = ['thank you', 'thanks', 'thank u', 'thnx', 'appreciate', 'dhanyavaad', 'dhanyavad', 'shukriya', 'thanku'];
    for (const pattern of thankPatterns) {
        if (query.includes(pattern)) {
            return {
                text: `ğŸ˜Š You're welcome! Happy learning!\n\nFeel free to ask me anything about BNSS Section-1.`,
                type: 'thanks'
            };
        }
    }
    
    // About bot (English + Romanized Hindi)
    const aboutPatterns = ['who are you', 'what are you', 'your name', 'introduce yourself', 'tum kaun ho', 'kaun', 'aap kaun hai', 'aap kaun hain', 'apna parichay do', 'tumhara naam'];
    for (const pattern of aboutPatterns) {
        if (query.includes(pattern)) {
            return {
                text: `ğŸ¤– I'm Odisha e-Guru Assistant!\n\nI'm an AI-powered learning assistant designed to help you master BNSS Section-1.\n\nI can:\nâœ… Explain concepts with examples\nâœ… Generate practice tests\nâœ… Answer your questions\nâœ… Provide translations in Odia, Hindi, Bengali\n\nBuilt with â¤ï¸ for learners in Odisha.`,
                type: 'about'
            };
        }
    }
    
    // How are you (English + Romanized Hindi)
    const wellbeingPatterns = ['how are you', 'how r u', 'how do you do', 'whats up', "what's up", 'kaise ho', 'kaisi ho', 'kya haal hai', 'sab theek', 'kaise hain'];
    for (const pattern of wellbeingPatterns) {
        if (query.includes(pattern)) {
            return {
                text: `ğŸ˜Š I'm doing great, thank you for asking!\n\nI'm here and ready to help you learn BNSS Section-1.\n\nWhat would you like to explore today?`,
                type: 'wellbeing'
            };
        }
    }
    
    // Bye/Goodbye (English + Romanized Hindi)
    const byePatterns = ['bye', 'goodbye', 'see you', 'see ya', 'gotta go', 'take care', 'alvida', 'phir milenge', 'chalta hu', 'chalta hoon', 'jaata hu'];
    for (const pattern of byePatterns) {
        if (query.includes(pattern)) {
            return {
                text: `ğŸ‘‹ Goodbye! Keep learning and stay motivated!\n\n"Education is the most powerful weapon which you can use to change the world." - Nelson Mandela\n\nCome back anytime! ğŸ“š`,
                type: 'goodbye'
            };
        }
    }
    
    // Jokes (English + Romanized Hindi)
    const jokePatterns = ['tell me a joke', 'joke', 'make me laugh', 'funny', 'joke sunao', 'chutkula', 'chutkula sunao', 'hansao', 'mazak', 'mazaak'];
    for (const pattern of jokePatterns) {
        if (query.includes(pattern)) {
            const jokes = [
                "Why did the law student fail his exam? Because he couldn't pass the bar! ğŸ˜„",
                "Why don't lawyers go to the beach? Because cats keep trying to bury them in the sand! ğŸ–ï¸ğŸ˜‚",
                "What's a lawyer's favorite drink? Just-ice! âš–ï¸ğŸ˜„",
                "Why did the judge break up with the lawyer? Too many objections! ğŸ’”ğŸ˜‚"
            ];
            const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];
            return {
                text: `ğŸ˜„ Here's a legal joke for you:\n\n${randomJoke}\n\nNow, back to learning BNSS Section-1! ğŸ“š`,
                type: 'joke'
            };
        }
    }
    
    // Motivation (English + Romanized Hindi)
    const motivationPatterns = ['motivate me', 'inspire me', 'motivation', 'feeling low', 'tired', 'demotivated', 'prerna', 'prerana', 'motivation do', 'himmat do', 'utsahit karo', 'thak gaya', 'thak gayi'];
    for (const pattern of motivationPatterns) {
        if (query.includes(pattern)) {
            const quotes = [
                "ğŸŒŸ 'The only way to do great work is to love what you do.' - Steve Jobs",
                "ğŸ’ª 'Believe you can and you're halfway there.' - Theodore Roosevelt",
                "ğŸ¯ 'Success is not final, failure is not fatal: it is the courage to continue that counts.' - Winston Churchill",
                "ğŸ“š 'Education is the passport to the future, for tomorrow belongs to those who prepare for it today.' - Malcolm X"
            ];
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            return {
                text: `${randomQuote}\n\nKeep going! Every question you answer brings you closer to mastery. You've got this! ğŸ’ªâœ¨`,
                type: 'motivation'
            };
        }
    }
    
    // Time/Date (English + Romanized Hindi)
    const timePatterns = ['date', 'samay', 'time', 'tarikh'];
    for (const pattern of timePatterns) {
        if (query.includes(pattern)) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-IN');
            const dateStr = now.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            return {
                text: `ğŸ• Current Time: ${timeStr}\nğŸ“… Today's Date: ${dateStr}\n\nLet's make the most of today's learning! ğŸ“š`,
                type: 'time'
            };
        }
    }
    
    return null; // No general query matched
}

// âœ… FUNCTION 2: DISPLAY GENERAL RESPONSE
function showGeneralResponse(response) {
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    
    const emojis = {
        greeting: 'ğŸ‘‹',
        help: 'ğŸ’¡',
        thanks: 'ğŸ˜Š',
        about: 'ğŸ¤–',
        wellbeing: 'ğŸ˜Š',
        goodbye: 'ğŸ‘‹',
        joke: 'ğŸ˜„',
        motivation: 'ğŸŒŸ',
        time: 'ğŸ•'
    };
    
    const emoji = emojis[response.type] || 'ğŸ’¬';
    
    container.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 25px; margin: 15px; box-shadow: 0 3px 15px rgba(0,0,0,0.1);">
            <div style="text-align: center; font-size: 50px; margin-bottom: 20px;">${emoji}</div>
            <div id="generalResponseText" style="color: #333; font-size: 15px; line-height: 1.8; white-space: pre-wrap; text-align: justify;"></div>
        </div>
    `;
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    
    // Typewriter effect
    const textElement = document.getElementById('generalResponseText');
    typewriterEffect(response.text, textElement, 30);
}

function startTestWithCategory(testType, category, count) {
    const poolMap = {
        'mcq': 'mcq_pool',
        'truefalse': 'truefalse_pool',
        'fillblanks': 'fillblank_pool',
        'matching': 'matching_pool',
        'arrange': 'word_arrangement_pool'
    };
    
    const poolName = poolMap[testType];
    const pool = getCategoryQuestionPool(category, poolName);
    
    if (!pool || pool.length === 0) {
        alert(`âŒ No questions available in ${CATEGORIES[category]} for this test type.`);
        return;
    }
    
    if (count > pool.length) {
        alert(`âš ï¸ Only ${pool.length} questions available in this category. Starting test with ${pool.length} questions.`);
        count = pool.length;
    }
    
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #667eea;"><h3>Loading test...</h3></div>';
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    
    // âœ… SPECIAL HANDLING for Matching and Word Arrangement
    if (testType === 'matching' || testType === 'arrange') {
        // Store all exercises with navigation support
        currentTest = {
            type: testType,
            category: category,
            allExercises: pool,              // âœ… All exercises
            currentExerciseIndex: 0,         // âœ… Start from first
            data: pool[0],                   // âœ… Current exercise data
            totalMarks: testType === 'matching' ? pool[0].columnA.length : 1,
            totalExercises: pool.length      // âœ… Total count
        };
        userAnswers = {};
        
        // Render appropriate test
        if (testType === 'matching') {
            renderMatchingTest();
        } else {
            renderWordArrangementTest();
        }
        return;
    }
    
    // âœ… REGULAR HANDLING for MCQ, True/False, Fill Blanks
    console.log('ğŸ” BEFORE getUniqueQuestions:', { poolSize: pool.length, count, testType });
    const questions = getUniqueQuestions(pool, count, testType);
    console.log('âœ… AFTER getUniqueQuestions:', { questionsCount: questions.length, questions });
    
    if (questions.length === 0) {
        console.error('âŒ getUniqueQuestions returned empty array!');
        alert('âŒ Could not load questions. Please try again.');
        return;
    }
    
    currentTest = {
        type: testType,
        category: category,
        questions: questions,
        data: null,
        totalMarks: questions.length
    };
    userAnswers = {};
    
    // Render appropriate test type
    switch(testType) {
        case 'mcq':
            renderMCQTest();
            break;
        case 'truefalse':
            renderTrueFalseTest();
            break;
        case 'fillblanks':
            renderFillBlanksTest();
            break;
        default:
            alert('âŒ Unknown test type');
    }
}
function getCategoryQuestionPool(category, poolName) {
    if (!assistantQAData) {
        console.error('âŒ assistantQAData not loaded');
        return [];
    }
    
    console.log('ğŸ” Searching for:', { category, poolName });
    
    // âœ… FIX: Handle bare_act FIRST (before subsections)
    if (category === 'bare_act' && assistantQAData.section1 && assistantQAData.section1.bare_act) {
        if (assistantQAData.section1.bare_act[poolName]) {
            const pool = assistantQAData.section1.bare_act[poolName];
            console.log('âœ… Found in section1.bare_act:', pool.length, 'items');
            return pool;
        }
    }
    
    // âœ… Check subsections (for subsection_1, subsection_2, etc.)
    if (assistantQAData.section1 && assistantQAData.section1.subsections) {
        if (assistantQAData.section1.subsections[category]) {
            const subsection = assistantQAData.section1.subsections[category];
            if (subsection[poolName]) {
                const pool = subsection[poolName];
                console.log('âœ… Found in section1.subsections:', pool.length, 'items');
                return pool;
            }
        }
    }
    
    // âœ… Check special categories (explanation_to_subsection_2, footnote_1)
    if (assistantQAData.section1 && assistantQAData.section1[category]) {
        const section = assistantQAData.section1[category];
        if (section[poolName]) {
            console.log('âœ… Found in section1.' + category + ':', section[poolName].length, 'items');
            return section[poolName];
        }
    }
    
    // âœ… Last resort: Recursive search
    console.log('âš ï¸ Starting deep recursive search...');
    let foundPool = null;
    
    function searchRecursively(obj, path = '', depth = 0) {
        if (depth > 15 || foundPool !== null) return;
        if (!obj || typeof obj !== 'object') return;
        
        if (obj[poolName] && Array.isArray(obj[poolName]) && obj[poolName].length > 0) {
            console.log('âœ… Found via recursive search at path:', path);
            foundPool = obj[poolName];
            return;
        }
        
        for (let key in obj) {
            if (obj.hasOwnProperty(key) && typeof obj[key] === 'object') {
                searchRecursively(obj[key], path + '.' + key, depth + 1);
            }
        }
    }
    
    searchRecursively(assistantQAData, 'assistantQAData');
    
    if (foundPool && foundPool.length > 0) {
        console.log('âœ… Recursive search successful:', foundPool.length, 'items');
        return foundPool;
    }
    
    console.error('âŒ No pool found for category:', category, 'poolName:', poolName);
    return [];
}

function getUniqueQuestions(pool, count, questionType) {
    if (!pool || pool.length === 0) {
        console.error('âŒ getUniqueQuestions: pool is empty or null');
        return [];
    }
    
    console.log('ğŸ” getUniqueQuestions called:', { poolLength: pool.length, count, questionType });
    
    if (!shownQuestions[questionType]) {
        shownQuestions[questionType] = [];
    }
    
    if (shownQuestions[questionType].length >= pool.length) {
        console.log('ğŸ”„ Resetting shown questions for', questionType);
        shownQuestions[questionType] = [];
    }
    
    const availableQuestions = pool.filter(q => {
        if (!q.id) {
            console.warn('âš ï¸ Question missing ID:', q);
            return true;
        }
        return !shownQuestions[questionType].includes(q.id);
    });
    
    console.log('ğŸ“Š Available questions:', availableQuestions.length);
    
    const shuffled = availableQuestions.sort(() => Math.random() - 0.5);
    const selected = shuffled.slice(0, Math.min(count, availableQuestions.length));
    
    selected.forEach(q => {
        if (q.id) {
            shownQuestions[questionType].push(q.id);
        }
    });
    
    console.log('âœ… Selected questions:', selected.length);
    return selected;
}

// TRANSLATION FUNCTIONS
function createTranslationButtons(text, elementId) {
    return `
        <div style="margin-top: 10px; display: flex; gap: 6px; justify-content: flex-start; flex-wrap: wrap;">
            <button onclick="translateTextInNewTab('${elementId}', 'or')" style="background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                ğŸŒ Odia
            </button>
            <button onclick="translateTextInNewTab('${elementId}', 'bn')" style="background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                ğŸŒ Bengali
            </button>
            <button onclick="translateTextInNewTab('${elementId}', 'hi')" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                ğŸŒ Hindi
            </button>
        </div>
    `;
}

function translateTextInNewTab(elementId, targetLanguage) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const text = element.textContent || element.innerText;
    if (!text || !text.trim()) return;
    
    const encodedText = encodeURIComponent(text.trim());
    const languageCodes = { 'or': 'or', 'bn': 'bn', 'hi': 'hi' };
    const langCode = languageCodes[targetLanguage];
    
    const googleTranslateUrl = `https://translate.google.com/?sl=en&tl=${langCode}&text=${encodedText}`;
    window.open(googleTranslateUrl, '_blank');
}

function translateCombinedText(elementId, targetLanguage) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const text = element.textContent || element.innerText;
    if (!text || !text.trim()) return;
    
    const encodedText = encodeURIComponent(text.trim());
    const languageCodes = { 'or': 'or', 'bn': 'bn', 'hi': 'hi' };
    const langCode = languageCodes[targetLanguage];
    
    const googleTranslateUrl = `https://translate.google.com/?sl=en&tl=${langCode}&text=${encodedText}`;
    window.open(googleTranslateUrl, '_blank');
}

// TEST RENDERING FUNCTIONS
function renderMCQTest() {
    const container = document.getElementById('responseContainer');
    
    let html = `
        <div class="test-container">
            <div style="text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 3px solid #667eea;">
                <h2 style="color: #667eea; font-size: 22px; font-weight: 900; margin-bottom: 10px;">ğŸ¯ MCQ TEST</h2>
                <p style="color: #666; font-size: 14px; margin: 0;">Total Questions: ${currentTest.questions.length} | Total Marks: ${currentTest.totalMarks}</p>
            </div>
    `;
    
    currentTest.questions.forEach((q, index) => {
        const combinedText = q.question + '\n\n' + q.options.map((opt, i) => `${String.fromCharCode(65 + i)}) ${opt}`).join('\n');
        const combinedId = `mcq-combined-${index}`;
        
        html += `
            <div class="question-card" id="question-${index}">
                <span class="question-number">Question ${index + 1}</span>
                <div class="question-text">${q.question}</div>
                
                <div style="margin-top: 12px; display: flex; gap: 6px; justify-content: flex-start; flex-wrap: wrap;">
                    <button onclick="translateCombinedText('${combinedId}', 'or')" style="background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                        ğŸŒ Odia
                    </button>
                    <button onclick="translateCombinedText('${combinedId}', 'bn')" style="background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                        ğŸŒ Bengali
                    </button>
                    <button onclick="translateCombinedText('${combinedId}', 'hi')" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                        ğŸŒ Hindi
                    </button>
                </div>
                
                <div id="${combinedId}" style="display: none;">${combinedText}</div>
                
                <div style="margin-top: 15px;">
        `;
        
        q.options.forEach((opt, i) => {
            html += `
                <button class="option-btn" onclick="selectOption(${index}, ${i})">
                    ${String.fromCharCode(65 + i)}) ${opt}
                </button>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += `
            <button class="submit-test-btn" onclick="submitTest(event)">
                ğŸ“Š Submit Test & Get Certificate
            </button>
        </div>
    `;
    
    container.innerHTML = html;
}

function selectOption(questionIndex, optionIndex) {
    userAnswers[questionIndex] = optionIndex;
    
    const questionCard = document.getElementById(`question-${questionIndex}`);
    const buttons = questionCard.querySelectorAll('.option-btn');
    
    buttons.forEach((btn, i) => {
        if (i === optionIndex) {
            btn.classList.add('selected');
        } else {
            btn.classList.remove('selected');
        }
    });
}

function submitTest(event) {
    const submitBtn = event.target;
    if (submitBtn.disabled) return;
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.5';
    submitBtn.textContent = 'âœ“ Test Submitted';
    
    if (Object.keys(userAnswers).length < currentTest.questions.length) {
        alert('âš ï¸ Please answer all questions!');
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.textContent = 'ğŸ“Š Submit Test';
        return;
    }
    
    let correctAnswers = 0;
    
    currentTest.questions.forEach((q, index) => {
        const questionCard = document.getElementById(`question-${index}`);
        const buttons = questionCard.querySelectorAll('.option-btn');
        
        buttons.forEach((btn, i) => {
            btn.style.pointerEvents = 'none';
            
            if (i === q.correct) {
                btn.classList.add('correct');
            }
            
            if (userAnswers[index] === i && i !== q.correct) {
                btn.classList.add('wrong');
            }
        });
        
        if (userAnswers[index] === q.correct) {
            correctAnswers++;
        }
        
        const explanation = document.createElement('div');
        explanation.style.cssText = 'background: #e8f5e9; border-left: 4px solid #4CAF50; border-radius: 8px; padding: 12px; margin-top: 15px; font-size: 13px; color: #2e7d32;';
        explanation.innerHTML = `<strong>ğŸ’¡ Explanation:</strong> ${q.explanation}`;
        questionCard.appendChild(explanation);
    });
    
    const percentage = (correctAnswers / currentTest.totalMarks * 100).toFixed(1);
    showCertificate(correctAnswers, currentTest.totalMarks, percentage, 'MCQ Test');
}

function renderTrueFalseTest() {
    const container = document.getElementById('responseContainer');
    
    let html = `
        <div class="test-container">
            <div style="text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 3px solid #667eea;">
                <h2 style="color: #667eea; font-size: 22px; font-weight: 900; margin-bottom: 10px;">âœ“âœ— TRUE/FALSE TEST</h2>
                <p style="color: #666; font-size: 14px; margin: 0;">Total Questions: ${currentTest.questions.length} | Total Marks: ${currentTest.totalMarks}</p>
            </div>
    `;
    
    currentTest.questions.forEach((q, index) => {
        const questionId = `tf-q-${index}`;
        html += `
            <div class="question-card" id="question-${index}">
                <span class="question-number">Question ${index + 1}</span>
                <div class="question-text" id="${questionId}">${q.statement}</div>
                ${createTranslationButtons(q.statement, questionId)}
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="option-btn" onclick="selectTFOption(${index}, true)" style="flex: 1;">
                        âœ“ TRUE
                    </button>
                    <button class="option-btn" onclick="selectTFOption(${index}, false)" style="flex: 1;">
                        âœ— FALSE
                    </button>
                </div>
            </div>
        `;
    });
    
    html += `
            <button class="submit-test-btn" onclick="submitTFTest(event)">
                ğŸ“Š Submit Test & Get Certificate
            </button>
        </div>
    `;
    
    container.innerHTML = html;
}

function selectTFOption(questionIndex, value) {
    userAnswers[questionIndex] = value;
    
    const questionCard = document.getElementById(`question-${questionIndex}`);
    const buttons = questionCard.querySelectorAll('.option-btn');
    
    buttons.forEach((btn, i) => {
        if ((i === 0 && value === true) || (i === 1 && value === false)) {
            btn.classList.add('selected');
        } else {
            btn.classList.remove('selected');
        }
    });
}

function submitTFTest(event) {
    const submitBtn = event.target;
    if (submitBtn.disabled) return;
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.5';
    submitBtn.textContent = 'âœ“ Test Submitted';
    
    if (Object.keys(userAnswers).length < currentTest.questions.length) {
        alert('âš ï¸ Please answer all questions!');
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.textContent = 'ğŸ“Š Submit Test';
        return;
    }
    
    let correctAnswers = 0;
    
    currentTest.questions.forEach((q, index) => {
        const questionCard = document.getElementById(`question-${index}`);
        const buttons = questionCard.querySelectorAll('.option-btn');
        
        buttons.forEach((btn, i) => {
            btn.style.pointerEvents = 'none';
            
            if ((i === 0 && q.correct === true) || (i === 1 && q.correct === false)) {
                btn.classList.add('correct');
            }
            
            if (userAnswers[index] === (i === 0) && userAnswers[index] !== q.correct) {
                btn.classList.add('wrong');
            }
        });
        
        if (userAnswers[index] === q.correct) {
            correctAnswers++;
        }
        
        const explanation = document.createElement('div');
        explanation.style.cssText = 'background: #e8f5e9; border-left: 4px solid #4CAF50; border-radius: 8px; padding: 12px; margin-top: 15px; font-size: 13px; color: #2e7d32;';
        explanation.innerHTML = `<strong>ğŸ’¡ Explanation:</strong> ${q.explanation}`;
        questionCard.appendChild(explanation);
    });
    
    const percentage = (correctAnswers / currentTest.totalMarks * 100).toFixed(1);
    showCertificate(correctAnswers, currentTest.totalMarks, percentage, 'True/False Test');
}

function renderFillBlanksTest() {
    const container = document.getElementById('responseContainer');
    
    let html = `
        <div class="test-container">
            <div style="text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 3px solid #667eea;">
                <h2 style="color: #667eea; font-size: 22px; font-weight: 900; margin-bottom: 10px;">ğŸ“‹ FILL IN THE BLANKS</h2>
                <p style="color: #666; font-size: 14px; margin: 0;">Total Questions: ${currentTest.questions.length} | Total Marks: ${currentTest.totalMarks}</p>
            </div>
    `;
    
    currentTest.questions.forEach((q, index) => {
        const questionId = `fb-q-${index}`;
        html += `
            <div class="question-card" id="question-${index}">
                <span class="question-number">Question ${index + 1}</span>
                <div class="question-text" id="${questionId}">${q.question}</div>
                ${createTranslationButtons(q.question, questionId)}
                <div style="margin-top: 15px;">
                    <input type="text" 
                           class="assistant-input" 
                           id="answer-${index}"
                           placeholder="Type your answer here..."
                           style="min-height: 45px; font-size: 14px;"
                           onchange="saveFillBlankAnswer(${index}, this.value)">
                </div>
            </div>
        `;
    });
    
    html += `
            <button class="submit-test-btn" onclick="submitFillBlankTest(event)">
                ğŸ“Š Submit Test & Get Certificate
            </button>
        </div>
    `;
    
    container.innerHTML = html;
}

function saveFillBlankAnswer(questionIndex, value) {
    userAnswers[questionIndex] = value.trim();
}

function submitFillBlankTest(event) {
    const submitBtn = event.target;
    if (submitBtn.disabled) return;
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.5';
    submitBtn.textContent = 'âœ“ Test Submitted';
    
    if (Object.keys(userAnswers).length < currentTest.questions.length) {
        alert('âš ï¸ Please answer all questions!');
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.textContent = 'ğŸ“Š Submit Test';
        return;
    }
    
    let correctAnswers = 0;
    
    currentTest.questions.forEach((q, index) => {
        const questionCard = document.getElementById(`question-${index}`);
        const input = document.getElementById(`answer-${index}`);
        input.disabled = true;
        
        const userAns = (userAnswers[index] || '').toLowerCase().trim();
        const correctAns = q.answer.toLowerCase().trim();
        
        const isCorrect = userAns === correctAns;
        
        if (isCorrect) {
            correctAnswers++;
            input.style.borderColor = '#4CAF50';
            input.style.background = '#e8f5e9';
        } else {
            input.style.borderColor = '#f44336';
            input.style.background = '#ffebee';
        }
        
        const result = document.createElement('div');
        result.style.cssText = `background: ${isCorrect ? '#e8f5e9' : '#fff3cd'}; border-left: 4px solid ${isCorrect ? '#4CAF50' : '#ffc107'}; border-radius: 8px; padding: 12px; margin-top: 15px; font-size: 13px; color: ${isCorrect ? '#2e7d32' : '#856404'};`;
        result.innerHTML = `<strong>âœ… Correct Answer:</strong> ${q.answer}`;
        questionCard.appendChild(result);
    });
    
    const percentage = (correctAnswers / currentTest.totalMarks * 100).toFixed(1);
    showCertificate(correctAnswers, currentTest.totalMarks, percentage, 'Fill in the Blanks Test');
}

function renderMatchingTest() {
    const match = currentTest.data;
    currentTest.userMatches = {};
    
    // âœ… Calculate exercise number
    const exerciseNum = currentTest.currentExerciseIndex + 1;
    const totalExercises = currentTest.totalExercises || 1;
    
    let html = `
        <div style="background: white; border-radius: 0; padding: 0; margin: 0;">
            <div style="text-align: center; padding: 20px 15px; border-bottom: 3px solid #667eea;">
                <h2 style="color: #667eea; font-size: 22px; font-weight: 900; margin-bottom: 10px;">ğŸ”— MATCHING EXERCISE</h2>
                <p style="color: #666; font-size: 14px; margin: 0;">Total Questions: ${match.columnA.length} | Total Marks: ${match.columnA.length}</p>
                
                <!-- âœ… NEW: Exercise counter -->
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; margin-top: 10px; font-weight: 700; font-size: 14px;">
                    Exercise ${exerciseNum} of ${totalExercises}
                </div>
                
                <p style="color: #764ba2; font-size: 13px; margin-top: 8px; font-weight: 600;">Match Column A with Column B</p>
            </div>
            
            <div style="padding: 15px 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 10px;">
                    <div>
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 10px;">
                            ğŸ“Œ COLUMN A
                        </div>
    `;
    
    match.columnA.forEach((item, i) => {
        html += `
            <div onclick="selectMatchRow(${i})" style="background: #f8f9fa; padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid #667eea; cursor: pointer;">
                <div style="font-weight: bold; color: #667eea; margin-bottom: 4px;">${i + 1}.</div>
                <div style="font-size: 13px; color: #333;">${item}</div>
            </div>
        `;
    });
    
    html += `
                    </div>
                    <div>
                        <div style="background: linear-gradient(135deg, #764ba2, #667eea); color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 10px;">
                            ğŸ“Œ COLUMN B
                        </div>
    `;
    
  match.columnB.forEach((item, i) => {
        html += `
            <div class="match-option" id="colB-option-${i}" data-index="${i}" onclick="selectMatchOption(${i})" 
                 style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 2px solid #dee2e6; cursor: pointer; transition: all 0.3s ease;">
                <div style="font-weight: bold; color: #764ba2; margin-bottom: 4px;">${String.fromCharCode(65 + i)}.</div>
                <div style="font-size: 13px; color: #333;">${item}</div>
            </div>
        `;
    });
    
    html += `
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f2ff 100%); padding: 15px; margin: 15px 0 0 0;">
                    <h3 style="color: #667eea; text-align: center; margin-bottom: 15px; font-size: 16px;">âœï¸ Your Matches</h3>
                    <div id="userMatchesDisplay" style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 15px; min-height: 100px;">
    `;
    
    match.columnA.forEach((item, i) => {
        html += `
            <div id="match-row-${i}" style="padding: 8px; margin-bottom: 6px; border-bottom: 1px dashed #ddd; display: flex; align-items: center; gap: 10px;">
                <span style="font-weight: bold; color: #667eea; min-width: 30px;">${i + 1}.</span>
                <span style="color: #999; font-size: 13px;">â†’</span>
                <span id="match-answer-${i}" style="color: #999; font-style: italic; font-size: 13px;">Click Column B to match</span>
            </div>
        `;
    });
    
    html += `
                    </div>
                    
                    <!-- âœ… NEW: Navigation Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
    `;
    
    // Previous button
    if (exerciseNum > 1) {
        html += `
                        <button onclick="goToPreviousExercise()" style="flex: 1; background: linear-gradient(135deg, #FFA726, #FB8C00); color: white; border: none; padding: 12px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            â† Previous Exercise
                        </button>
        `;
    }
    
    // Next button (only if not last exercise)
    if (exerciseNum < totalExercises) {
        html += `
                        <button onclick="goToNextExercise()" style="flex: 1; background: linear-gradient(135deg, #66BB6A, #43A047); color: white; border: none; padding: 12px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            Next Exercise â†’
                        </button>
        `;
    }
    
    html += `
                    </div>
                    
                    <button class="submit-test-btn" onclick="submitMatchingTest(event)" style="margin: 0 15px;">
                        ğŸ“Š Submit & Check Answers
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('responseContainer').innerHTML = html;
    window.selectedMatchRow = null;
}

function selectMatchRow(rowIndex) {
    for (let i = 0; i < currentTest.data.columnA.length; i++) {
        const colAItem = document.querySelector(`[onclick="selectMatchRow(${i})"]`);
        if (colAItem) {
            colAItem.style.background = '#f8f9fa';
            colAItem.style.borderLeft = '4px solid #667eea';
        }
    }
    
    const selectedColAItem = document.querySelector(`[onclick="selectMatchRow(${rowIndex})"]`);
    if (selectedColAItem) {
        selectedColAItem.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
        selectedColAItem.style.borderLeft = '4px solid #2196F3';
    }
    
    window.selectedMatchRow = rowIndex;
}

function selectMatchOption(optionIndex) {
    // Reset all Column B options to default style
    for (let i = 0; i < currentTest.data.columnB.length; i++) {
        const colBOption = document.getElementById(`colB-option-${i}`);
        if (colBOption) {
            colBOption.style.background = 'white';
            colBOption.style.borderColor = '#dee2e6';
            colBOption.style.transform = 'scale(1)';
        }
    }
    
    // Highlight clicked Column B option
    const clickedOption = document.getElementById(`colB-option-${optionIndex}`);
    if (clickedOption) {
        clickedOption.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
        clickedOption.style.borderColor = '#2196F3';
        clickedOption.style.transform = 'scale(1.02)';
    }
    
    if (window.selectedMatchRow === null || window.selectedMatchRow === undefined) {
        for (let i = 0; i < currentTest.data.columnA.length; i++) {
            if (!currentTest.userMatches[i]) {
                window.selectedMatchRow = i;
                selectMatchRow(i);
                break;
            }
        }
    }
    
    const rowIndex = window.selectedMatchRow;
    const letter = String.fromCharCode(65 + optionIndex);
    
    currentTest.userMatches[rowIndex] = optionIndex;
    
    const answerSpan = document.getElementById(`match-answer-${rowIndex}`);
    answerSpan.textContent = letter;
    answerSpan.style.color = '#4CAF50';
    answerSpan.style.fontWeight = 'bold';
    
    // After a brief moment, reset the Column B visual effect
    setTimeout(() => {
        if (clickedOption) {
            clickedOption.style.background = 'white';
            clickedOption.style.borderColor = '#dee2e6';
            clickedOption.style.transform = 'scale(1)';
        }
    }, 500);
    
    window.selectedMatchRow = null;
}

function submitMatchingTest(event) {
    const submitBtn = event.target;
    if (submitBtn.disabled) return;
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.5';
    submitBtn.textContent = 'âœ“ Test Submitted';
    
    if (Object.keys(currentTest.userMatches).length < currentTest.data.columnA.length) {
        alert('âš ï¸ Please match all items!');
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.textContent = 'ğŸ“Š Submit';
        return;
    }
    
    let correctAnswers = 0;
    
    currentTest.data.columnA.forEach((item, i) => {
        const userAnswer = currentTest.userMatches[i];
        const correctAnswer = currentTest.data.correct_matches[i];
        const isCorrect = userAnswer === correctAnswer;
        
        if (isCorrect) correctAnswers++;
        
        const rowElement = document.getElementById(`match-row-${i}`);
        const answerSpan = document.getElementById(`match-answer-${i}`);
        
        if (isCorrect) {
            rowElement.style.background = 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)';
            answerSpan.style.color = '#2e7d32';
        } else {
            rowElement.style.background = 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)';
            answerSpan.innerHTML = `${String.fromCharCode(65 + userAnswer)} âœ— (Correct: ${String.fromCharCode(65 + correctAnswer)})`;
        }
    });
    
    // âœ… Store score
    currentTest.finalScore = correctAnswers;
    
    const percentage = (correctAnswers / currentTest.data.columnA.length * 100).toFixed(1);
    setTimeout(() => {
        showCertificate(correctAnswers, currentTest.data.columnA.length, percentage, 'Matching Exercise');
    }, 1000);
}

function renderWordArrangementTest() {
    const wa = currentTest.data;
    currentTest.selectedWords = [];
    currentTest.availableWords = [...wa.jumbled];
    
    // âœ… Calculate exercise number
    const exerciseNum = currentTest.currentExerciseIndex + 1;
    const totalExercises = currentTest.totalExercises || 1;
    
    let html = `
        <div style="background: white; border-radius: 0; padding: 0; margin: 0;">
            <div style="text-align: center; padding: 20px 15px; border-bottom: 3px solid #667eea;">
                <h2 style="color: #667eea; font-size: 22px; font-weight: 900; margin-bottom: 10px;">ğŸ”¤ WORD ARRANGEMENT</h2>
                
                <!-- âœ… NEW: Exercise counter -->
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; margin: 10px 0; font-weight: 700; font-size: 14px;">
                    Exercise ${exerciseNum} of ${totalExercises}
                </div>
                
                <p style="color: #666; font-size: 14px; margin: 0;">Click words in correct order</p>
            </div>
            
            <div style="padding: 20px 15px;">
                <div style="background: #e3f2fd; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <strong style="color: #1976D2;">ğŸ’¡ Hint:</strong>
                    <p style="color: #333; margin: 8px 0 0 0; font-size: 14px;">${wa.hint}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f2ff 100%); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 12px; font-size: 16px; text-align: center;">âœï¸ Your Sentence:</h4>
                    <div id="selectedWordsDisplay" style="background: white; border-radius: 8px; padding: 15px; min-height: 80px; border: 2px dashed #667eea; text-align: center; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center;">
                        <span style="color: #999; font-style: italic; font-size: 14px;" id="emptyMessage">Click words below...</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button onclick="clearWordSelection()" style="background: #f44336; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-size: 13px; cursor: pointer; font-weight: 600;">
                            ğŸ”„ Clear All
                        </button>
                    </div>
                </div>
                
                <div style="background: #fff3cd; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #856404; margin-bottom: 12px; font-size: 16px; text-align: center;">ğŸ“ Available Words:</h4>
                    <div id="availableWordsDisplay" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
    `;
    
    wa.jumbled.forEach((word, index) => {
        html += `
            <button 
                class="word-btn" 
                data-index="${index}"
                onclick="selectWord(${index})"
                style="background: white; border: 2px solid #667eea; color: #667eea; padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer;">
                ${word}
            </button>
        `;
    });
    
    html += `
                    </div>
                </div>
                
                <!-- âœ… NEW: Navigation Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
    `;
    
    // Previous button
    if (exerciseNum > 1) {
        html += `
                    <button onclick="goToPreviousExercise()" style="flex: 1; background: linear-gradient(135deg, #FFA726, #FB8C00); color: white; border: none; padding: 12px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        â† Previous Exercise
                    </button>
        `;
    }
    
    // Next button (only if not last exercise)
    if (exerciseNum < totalExercises) {
        html += `
                    <button onclick="goToNextExercise()" style="flex: 1; background: linear-gradient(135deg, #66BB6A, #43A047); color: white; border: none; padding: 12px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        Next Exercise â†’
                    </button>
        `;
    }
    
    html += `
                </div>
                
                <button class="submit-test-btn" onclick="submitWordArrangement(event)" style="margin: 0;">
                    âœ… Check My Answer
                </button>
                
                <div id="wordArrangementResult" style="display: none; margin-top: 20px;"></div>
            </div>
        </div>
    `;
    
    document.getElementById('responseContainer').innerHTML = html;
}

function selectWord(index) {
    const wordBtn = document.querySelector(`[data-index="${index}"]`);
    
    if (wordBtn.style.display === 'none') return;
    
    currentTest.selectedWords.push({
        index: index,
        word: currentTest.availableWords[index]
    });
    
    wordBtn.style.display = 'none';
    updateSelectedWordsDisplay();
}

function updateSelectedWordsDisplay() {
    const display = document.getElementById('selectedWordsDisplay');
    const emptyMessage = document.getElementById('emptyMessage');
    
    if (currentTest.selectedWords.length === 0) {
        if (emptyMessage) emptyMessage.style.display = 'block';
        return;
    }
    
    if (emptyMessage) emptyMessage.style.display = 'none';
    
    let html = '';
    currentTest.selectedWords.forEach((item, i) => {
        html += `
            <div onclick="removeWord(${i})" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; position: relative;">
                ${item.word}
                <span style="position: absolute; top: -5px; right: -5px; background: #f44336; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">Ã—</span>
            </div>
        `;
    });
    
    display.innerHTML = html;
}

function removeWord(selectedIndex) {
    const removedWord = currentTest.selectedWords[selectedIndex];
    currentTest.selectedWords.splice(selectedIndex, 1);
    
    const wordBtn = document.querySelector(`[data-index="${removedWord.index}"]`);
    if (wordBtn) {
        wordBtn.style.display = 'inline-block';
    }
    
    updateSelectedWordsDisplay();
}

function clearWordSelection() {
    currentTest.selectedWords.forEach(item => {
        const wordBtn = document.querySelector(`[data-index="${item.index}"]`);
        if (wordBtn) {
            wordBtn.style.display = 'inline-block';
        }
    });
    
    currentTest.selectedWords = [];
    
    const display = document.getElementById('selectedWordsDisplay');
    display.innerHTML = '<span style="color: #999; font-style: italic; font-size: 14px;" id="emptyMessage">Click words below...</span>';
}

function submitWordArrangement(event) {
    const submitBtn = event.target;
    if (submitBtn.disabled) return;
    
    if (currentTest.selectedWords.length !== currentTest.availableWords.length) {
        alert('âš ï¸ Please select all words!');
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.5';
    submitBtn.textContent = 'âœ“ Checked';
    
    const userSentence = currentTest.selectedWords.map(item => item.word).join(' ');
    const correctSentence = currentTest.data.correct;
    
    // âœ… Strip punctuation before comparing
    const stripPunctuation = (str) => str.toLowerCase().trim()
        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '')
        .replace(/\s+/g, ' ');
    
    const normalizedUser = stripPunctuation(userSentence);
    const normalizedCorrect = stripPunctuation(correctSentence);
    
    const isCorrect = normalizedUser === normalizedCorrect;
    
    // âœ… Store score
    currentTest.finalScore = isCorrect ? 1 : 0;
    
    const resultDiv = document.getElementById('wordArrangementResult');
    resultDiv.style.display = 'block';
    
    if (isCorrect) {
        resultDiv.innerHTML = `
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 3px solid #4CAF50; border-radius: 15px; padding: 25px; text-align: center;">
                <div style="font-size: 60px; margin-bottom: 15px;">ğŸ‰</div>
                <h3 style="color: #2e7d32; font-size: 24px; font-weight: 900; margin-bottom: 15px;">CORRECT!</h3>
                <div style="background: white; border-radius: 10px; padding: 15px; margin: 15px 0;">
                    <p style="color: #333; font-size: 16px; font-weight: 600; margin: 0;">"${userSentence}"</p>
                </div>
            </div>
        `;
        setTimeout(() => showCertificate(1, 1, 100, 'Word Arrangement'), 1500);
    } else {
        resultDiv.innerHTML = `
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border: 3px solid #ffc107; border-radius: 15px; padding: 25px;">
                <h3 style="color: #856404; font-size: 22px; font-weight: 900; margin-bottom: 15px; text-align: center;">Not Quite Right</h3>
                <div style="background: white; border-radius: 10px; padding: 15px; margin: 15px 0;">
                    <strong>Your Answer:</strong>
                    <p style="color: #333; font-size: 15px; margin: 8px 0 0 0;">"${userSentence}"</p>
                </div>
                <div style="background: white; border-radius: 10px; padding: 15px; margin: 15px 0;">
                    <strong style="color: #2e7d32;">Correct Answer:</strong>
                    <p style="color: #333; font-size: 15px; font-weight: 600; margin: 8px 0 0 0;">"${correctSentence}"</p>
                </div>
            </div>
        `;
        setTimeout(() => showCertificate(0, 1, 0, 'Word Arrangement'), 1500);
    }
}

function goToNextExercise() {
    if (!currentTest || !currentTest.allExercises) {
        console.error('âŒ No current test or exercises');
        return;
    }
    
    // âœ… Save score BEFORE moving to next
    if (currentTest.finalScore !== undefined) {
        cumulativeScore += currentTest.finalScore;
        cumulativeTotalMarks += currentTest.totalMarks;
    }
    
    const nextIndex = currentTest.currentExerciseIndex + 1;
    
    if (nextIndex >= currentTest.allExercises.length) {
        alert('ğŸ‰ You have completed all exercises!');
        return;
    }
    
    // Reset for next exercise
    currentTest.currentExerciseIndex = nextIndex;
    currentTest.data = currentTest.allExercises[nextIndex];
    currentTest.totalMarks = currentTest.type === 'matching' 
        ? currentTest.data.columnA.length 
        : 1;
    currentTest.userMatches = {};
    userAnswers = {};
    delete currentTest.finalScore; // âœ… Reset for new exercise
    
    // Re-render
    if (currentTest.type === 'matching') {
        renderMatchingTest();
    } else {
        renderWordArrangementTest();
    }
}

function goToPreviousExercise() {
    if (!currentTest || !currentTest.allExercises) {
        console.error('âŒ No current test or exercises');
        return;
    }
    
    const prevIndex = currentTest.currentExerciseIndex - 1;
    
    if (prevIndex < 0) {
        alert('âš ï¸ You are already at the first exercise!');
        return;
    }
    
    // âœ… Don't save score when going backward - just navigate
    // Reset for previous exercise
    currentTest.currentExerciseIndex = prevIndex;
    currentTest.data = currentTest.allExercises[prevIndex];
    currentTest.totalMarks = currentTest.type === 'matching' 
        ? currentTest.data.columnA.length 
        : 1;
    currentTest.userMatches = {};
    userAnswers = {};
    delete currentTest.finalScore;
    
    // Re-render
    if (currentTest.type === 'matching') {
        renderMatchingTest();
    } else {
        renderWordArrangementTest();
    }
}

function showCertificate(score, totalMarks, percentage, testType) {
    // âœ… Calculate cumulative totals
    const finalScore = cumulativeScore + score;
    const finalTotal = cumulativeTotalMarks + totalMarks;
    const finalPercentage = finalTotal > 0 ? ((finalScore / finalTotal) * 100).toFixed(1) : percentage;
    
    let performanceLevel = '';
    let message = '';
    
    // Use cumulative percentage if multiple exercises, otherwise current percentage
    const perfPercent = finalTotal > totalMarks ? finalPercentage : percentage;
    
    if (perfPercent >= 90) {
        performanceLevel = 'ğŸ† EXCELLENT';
        message = 'Outstanding performance!';
    } else if (perfPercent >= 75) {
        performanceLevel = 'â­ VERY GOOD';
        message = 'Great job!';
    } else if (perfPercent >= 60) {
        performanceLevel = 'ğŸ‘ GOOD';
        message = 'Good effort!';
    } else {
        performanceLevel = 'ğŸ“– NEEDS IMPROVEMENT';
        message = 'Keep practicing!';
    }
    
    // âœ… Check if there's a next exercise
    const hasNextExercise = currentTest && currentTest.allExercises && 
                           (currentTest.currentExerciseIndex + 1) < currentTest.totalExercises;
    
    const certificateHTML = `
        <div class="certificate-container" style="background: white; border-radius: 15px; padding: 30px; margin-top: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 24px; font-weight: 900; color: #667eea; margin-bottom: 20px;">ğŸ“ CERTIFICATE</div>
            
            ${finalTotal > totalMarks ? `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <div style="font-size: 14px; color: #2e7d32; margin-bottom: 5px; font-weight: 600;">ğŸ“Š TOTAL SCORE (All Exercises)</div>
                    <div style="font-size: 36px; font-weight: 900; color: #4CAF50; margin: 10px 0;">${finalScore} / ${finalTotal}</div>
                    <div style="font-size: 28px; font-weight: 700; color: #2e7d32;">${finalPercentage}%</div>
                </div>
                <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; margin: 10px 0;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 3px;">This Exercise:</div>
                    <div style="font-size: 20px; font-weight: 700; color: #667eea;">${score} / ${totalMarks} (${percentage}%)</div>
                </div>
            ` : `
                <div style="font-size: 32px; font-weight: 900; color: #667eea; margin: 20px 0;">${score} / ${totalMarks}</div>
                <div style="font-size: 24px; font-weight: 700; color: #764ba2; margin: 10px 0;">${percentage}%</div>
            `}
            
            <div style="font-size: 20px; font-weight: 700; color: #4CAF50; margin: 20px 0; padding: 15px; background: #e8f5e9; border-radius: 10px;">${performanceLevel}</div>
            <div style="color: #666; font-size: 16px; margin: 20px 0;">${message}</div>
            <div style="color: #999; font-size: 14px; margin-top: 30px;">
                ${new Date().toLocaleDateString('en-IN')}<br>
                ${testType}
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin: 20px 15px;">
            ${hasNextExercise ? `
                <button class="submit-test-btn" onclick="goToNextExercise()" style="flex: 1; margin: 0; background: linear-gradient(135deg, #66BB6A, #43A047);">
                    Next Exercise â†’
                </button>
            ` : ''}
            <button class="submit-test-btn" onclick="resetTest()" style="flex: 1; margin: 0;">
                ğŸ”„ ${hasNextExercise ? 'Start Over' : 'Take Another Test'}
            </button>
        </div>
    `;
    
    document.getElementById('responseContainer').innerHTML += certificateHTML;
}

function resetTest() {
    document.getElementById('assistantInput').value = '';
    document.getElementById('responseContainer').innerHTML = '';
    document.getElementById('responseContainer').classList.remove('show');
    
    currentTest = null;
    userAnswers = {};
    cumulativeScore = 0;
    cumulativeTotalMarks = 0;
    
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    
    const actionSection = document.querySelector('.quick-actions');
    if (actionSection) {
        actionSection.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    const mainActionBtn = document.getElementById('mainActionBtn');
    if (mainActionBtn) {
        const actionGrid = document.getElementById('actionGrid');
        if (actionGrid && actionGrid.classList.contains('hidden')) {
            actionGrid.classList.remove('hidden');
            mainActionBtn.querySelector('span').textContent = 'â–²';
        }
        
        mainActionBtn.style.animation = 'pulse 1s ease-in-out 2';
        setTimeout(() => {
            mainActionBtn.style.animation = '';
        }, 2000);
    }
}

// NEW: Toggle BNSS Section Text
function toggleBNSSText() {
    const content = document.getElementById('bnssTextContent');
    const arrow = document.getElementById('bnssArrow');
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        arrow.textContent = 'â–²';
    } else {
        content.style.display = 'none';
        arrow.textContent = 'â–¼';
    }
}

// NEW: Back to Roll Number Page
function backToRollPage() {
    const confirmed = confirm('âš ï¸ Are you sure you want to go back to the Roll Number page?\n\nYour current session will be reset.');
    
    if (!confirmed) return;
    
    // Reset all session data
    userRollNumber = null;
    userDeviceId = null;
    sessionStartTime = null;
    consentChecked = false;
    currentTest = null;
    userAnswers = {};
    cumulativeScore = 0;
    cumulativeTotalMarks = 0;
    
    // Stop any playing audio
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    
    // Reset UI elements
    const rollInput = document.getElementById('rollInput');
    const assistantInput = document.getElementById('assistantInput');
    const responseContainer = document.getElementById('responseContainer');
    const checkbox = document.getElementById('consentCheckbox');
    const enterBtn = document.getElementById('enterBtn');
    const mainApp = document.getElementById('mainApp');
    const welcomePage = document.getElementById('welcomePage');
    
    // Clear inputs
    if (rollInput) rollInput.value = '';
    if (assistantInput) assistantInput.value = '';
    if (responseContainer) {
        responseContainer.innerHTML = '';
        responseContainer.classList.remove('show');
    }
    
    // Reset consent checkbox
    if (checkbox) {
        checkbox.style.background = 'white';
        checkbox.style.borderColor = '#667eea';
        checkbox.innerHTML = '';
    }
    
    // Reset enter button
    if (enterBtn) {
        enterBtn.style.opacity = '0.6';
        enterBtn.disabled = false;
        enterBtn.textContent = 'ğŸš€ Start Learning';
    }
    
    // CRITICAL: Hide main app completely
    if (mainApp) {
        mainApp.style.display = 'none';
        mainApp.classList.remove('show');
        mainApp.classList.add('hidden');
    }
    
    // CRITICAL: Show welcome page
    if (welcomePage) {
        welcomePage.style.display = 'flex';
        welcomePage.classList.add('active');
        welcomePage.style.zIndex = '99999';
        welcomePage.style.position = 'fixed';
    }
    
    // Force scroll to top
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
    window.scrollTo(0, 0);
    
    // Double-check after a tiny delay
    setTimeout(() => {
        if (mainApp) mainApp.style.display = 'none';
        if (welcomePage) {
            welcomePage.style.display = 'flex';
            welcomePage.style.visibility = 'visible';
        }
        window.scrollTo(0, 0);
    }, 50);
    
    console.log('âœ… Returned to roll page');
}
// Disable right-click
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    alert('Right-click is disabled! This content is protected.');
    return false;
});

</script>

</body>
</html>
