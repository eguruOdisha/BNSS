<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - Odisha e-Guru</title>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
    mermaid.initialize({ startOnLoad: true, theme: 'default' });
</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>


    <style>
* {
    box-sizing: border-box;
}

/* Base Styles - Mobile First */
body, h1, h2, h3, h4, p, ul, li {
    margin: 0;
    padding: 0;
}

html, body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    width: 100%;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Welcome Page - Mobile Optimized */
.welcome-page {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    min-height: 100vh;
    padding: 0;
    padding-top: 30px;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 9999;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    overflow: hidden;
}

.welcome-page-inner {
    height: 100%;
    overflow-y: auto;
    padding: 30px 15px 15px 15px;
}

.welcome-page::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    animation: backgroundMove 15s ease-in-out infinite;
}


.welcome-card {
    background: rgba(255, 255, 255, 0.98);
    border-radius: 20px;
    padding: 30px 20px;
    max-width: 420px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 1;
    animation: slideUp 0.6s ease-out;
}

.welcome-logo {
    width: 120px;
    height: 120px;
    margin: 0 auto 20px;
    display: block;
    border-radius: 50%;
    border: 4px solid #667eea;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    animation: bounce 2s ease-in-out infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.welcome-title {
    text-align: center;
    color: #667eea;
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 8px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
}

.welcome-subtitle {
    text-align: center;
    color: #764ba2;
    font-size: 15px;
    margin-bottom: 25px;
    font-weight: 600;
}

.roll-input-group {
    margin-bottom: 25px;
}

.roll-label {
    display: block;
    color: #667eea;
    font-weight: 700;
    margin-bottom: 12px;
    font-size: 16px;
    text-align: center;
}

.roll-input {
    width: 100%;
    padding: 18px 25px;
    border: 3px solid #667eea;
    border-radius: 50px;
    font-size: 20px;
    text-align: center;
    font-weight: 700;
    transition: all 0.3s ease;
    background: white;
    letter-spacing: 2px;
}

.roll-input:focus {
    outline: none;
    border-color: #764ba2;
    box-shadow: 0 0 0 5px rgba(118, 75, 162, 0.2);
    transform: scale(1.02);
}

.roll-input::placeholder {
    color: #aaa;
    font-weight: 500;
    letter-spacing: 1px;
}

.enter-btn {
    width: 100%;
    padding: 18px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 50px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.enter-btn:hover:not(:disabled) {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
}

.enter-btn:active:not(:disabled) {
    transform: translateY(-1px);
}

.enter-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.message {
    padding: 15px;
    border-radius: 15px;
    text-align: center;
    margin-top: 20px;
    font-weight: 600;
    display: none;
    animation: slideIn 0.3s ease-out;
    white-space: pre-line;
    line-height: 1.6;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.show {
    display: block;
}

.message.error {
    background: linear-gradient(135deg, #ff6b6b, #ff8e53);
    color: white;
    animation: shake 0.5s ease-in-out;
}

.message.success {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
}

.message.loading {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.info-text {
    text-align: center;
    color: #888;
    font-size: 14px;
    margin-top: 20px;
}

.security-badge {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    border: 2px solid #4CAF50;
    border-radius: 15px;
    padding: 15px;
    margin-top: 20px;
    text-align: center;
}

.security-badge-title {
    color: #2e7d32;
    font-weight: 700;
    font-size: 14px;
    margin-bottom: 8px;
}

.security-badge-text {
    color: #388e3c;
    font-size: 12px;
    line-height: 1.6;
}

/* Main Container */
.container {
    background: white;
    max-width: 100%;
    width: 100%;
    min-height: 100vh;
    overflow-x: hidden;
    padding: 0;
    margin: 0;
    display: none;
}

.container.show {
    display: block;
}

/* Header */
.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 15px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: pulse 4s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.05); opacity: 0.7; }
}

.header h1 {
    font-size: 20px;
    margin-bottom: 6px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    position: relative;
    z-index: 1;
}

.header p {
    font-size: 12px;
    opacity: 0.95;
    position: relative;
    z-index: 1;
}

.assistant-image {
    width: 110px;
    height: 110px;
    margin: 12px auto 0 !important;
    display: block;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
}

.assistant-section {
    padding: 15px 0 20px 0;
}

/* Quick Actions */
.quick-actions {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 15px 0;
    margin: 0;
}

.actions-title {
    color: #1e3c72;
    font-weight: bold;
    font-size: 15px;
    margin: 0 15px 12px 15px;
    text-align: center;
}

.main-action-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 14px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    margin: 0 15px;
    width: calc(100% - 30px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    -webkit-tap-highlight-color: transparent;
}

.main-action-btn:active {
    transform: scale(0.98);
}

.action-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin: 12px 15px 0 15px;
    width: calc(100% - 30px);
}

.action-grid.hidden {
    display: none !important;
}
.action-btn {
    background: white;
    border: 2px solid #667eea;
    color: #000000;
    padding: 12px 8px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    -webkit-tap-highlight-color: transparent;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-btn:active {
    background: #667eea;
    color: white;
    transform: scale(0.97);
}

/* Input Container */
.input-container {
    background: linear-gradient(135deg, #f0f8ff 0%, #e6f2ff 100%);
    padding: 15px 0;
    margin: 0;
}

.input-label {
    color: #667eea;
    font-weight: bold;
    margin: 0 15px 10px 15px;
    display: block;
    font-size: 14px;
}

.assistant-input {
    width: calc(100% - 30px);
    padding: 15px;
    border: 2px solid #667eea;
    border-radius: 10px;
    font-size: 15px;
    resize: vertical;
    min-height: 100px;
    font-family: inherit;
    transition: all 0.3s ease;
    margin: 0 15px;
    background: white;
    line-height: 1.5;
}

.assistant-input:focus {
    outline: none;
    border-color: #764ba2;
    box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.15);
}

/* Audio Controls - Compact Mobile Version */
.audio-control-section {
    background: transparent;
    padding: 0;
    margin: 0 15px 8px 15px;
}

.audio-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 0;
}

.audio-checkbox {
    width: 14px;
    height: 14px;
    cursor: pointer;
}

.audio-label {
    color: #667eea;
    font-weight: 500;
    font-size: 11px;
    cursor: pointer;
}

.play-stop-btn {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
    width: 100%;
    -webkit-tap-highlight-color: transparent;
}

.play-stop-btn:active {
    transform: scale(0.97);
}

.play-stop-btn.playing {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    box-shadow: 0 3px 12px rgba(244, 67, 54, 0.4);
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.75; }
}

.play-stop-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.send-btn {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 13px 30px;
    border-radius: 25px;
    font-size: 14px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s ease;
    width: calc(100% - 30px);
    margin: 12px 15px 0 15px;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    -webkit-tap-highlight-color: transparent;
}

.send-btn:active {
    transform: scale(0.98);
}

/* Response Container */
.response-container {
    background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
    padding: 5px 0;
    margin-top: 0;
    display: none;
    animation: fadeIn 0.5s ease;
}

.response-container.show {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(15px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Test Container */
.test-container {
    background: white;
    padding: 0;
    margin: 0;
}

.question-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-left: 4px solid #667eea;
    padding: 15px 12px;
    margin: 0 0 12px 0;
}

.question-number {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 5px 12px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 11px;
    display: inline-block;
    margin-bottom: 8px;
}

.question-text {
    color: #333;
    font-size: 14px;
    font-weight: 600;
    margin: 8px 0;
    line-height: 1.6;
    text-align: left;
}

.option-btn {
    background: white;
    border: 2px solid #dee2e6;
    color: #333;
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
    margin: 0 0 8px 0;
    width: 100%;
    display: block;
    -webkit-tap-highlight-color: transparent;
    line-height: 1.4;
}

.option-btn:active {
    transform: scale(0.98);
}

.option-btn.selected {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-color: #667eea;
    color: white;
    font-weight: 600;
}

.option-btn.correct {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    border-color: #4CAF50;
    color: white;
}

.option-btn.wrong {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    border-color: #f44336;
    color: white;
}

.submit-test-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 14px 35px;
    border-radius: 25px;
    font-size: 15px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s ease;
    width: calc(100% - 30px);
    margin: 20px 15px 15px 15px;
    box-shadow: 0 5px 18px rgba(102, 126, 234, 0.4);
    -webkit-tap-highlight-color: transparent;
}

.submit-test-btn:active {
    transform: scale(0.98);
}

/* Certificate */
.certificate-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-top: 4px solid #667eea;
    border-bottom: 4px solid #667eea;
    padding: 25px 15px;
    margin: 0;
    text-align: center;
}

.certificate-header {
    font-size: 22px;
    color: #667eea;
    font-weight: 900;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
}

.certificate-body {
    font-size: 14px;
    color: #333;
    margin: 12px 0;
    line-height: 1.7;
}

.score-big {
    font-size: 40px;
    font-weight: 900;
    color: #4CAF50;
    margin: 15px 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.performance-badge {
    display: inline-block;
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
    margin: 12px 0;
}

.badge-excellent {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #fff;
}

.badge-good {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
}

.badge-average {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
}

.badge-needs-work {
    background: linear-gradient(135deg, #FF9800, #F57C00);
    color: white;
}

/* Welcome Modal */
.welcome-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    z-index: 1000;
    padding: 15px;
    overflow-y: auto;
}

.welcome-content {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 20px;
    padding: 25px 20px;
    max-width: 420px;
    width: 100%;
    text-align: center;
    animation: modalSlideIn 0.5s ease;
    box-shadow: 0 15px 50px rgba(0,0,0,0.5);
    margin: 15px auto;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.welcome-icon {
    font-size: 50px;
    margin-bottom: 12px;
    animation: iconBounce 2s infinite;
}

@keyframes iconBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.welcome-title {
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 22px;
    font-weight: 900;
    margin-bottom: 12px;
}

.welcome-text {
    color: #555;
    font-size: 13px;
    line-height: 1.6;
    margin-bottom: 20px;
}


.permission-item.checked .permission-checkbox {
    background: #4CAF50;
    border-color: #4CAF50;
}

.permission-checkbox::after {
    content: '‚úì';
    color: white;
    font-size: 14px;
    font-weight: bold;
    display: none;
}

.permission-item.checked .permission-checkbox::after {
    display: block;
}

.permission-text {
    flex: 1;
    font-size: 12px;
    color: #333;
    font-weight: 500;
    line-height: 1.4;
    text-align: justify;
    text-justify: inter-word;
    hyphens: auto;  /* Optional: for better word breaks */
}
.start-btn {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 14px 40px;
    border-radius: 30px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 18px rgba(76, 175, 80, 0.4);
    width: 100%;
    margin: 0;
    opacity: 0.5;
    pointer-events: none;
    -webkit-tap-highlight-color: transparent;
}

.start-btn.enabled {
    opacity: 1;
    pointer-events: auto;
}

.start-btn.enabled:active {
    transform: scale(0.98);
}

/* Matching Exercise */
.match-option {
    transition: all 0.3s ease;
    -webkit-tap-highlight-color: transparent;
}

.match-option:active {
    transform: scale(0.98);
}

.matching-columns-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 0 8px;
}

[id^="match-row-"] {
    transition: all 0.3s ease;
    cursor: pointer;
}

[id^="match-answer-"] {
    transition: all 0.3s ease;
}

.column-header {
    position: sticky;
    top: 0;
    z-index: 10;
}

.scroll-hint {
    text-align: center;
    padding: 8px;
    background: #fff3cd;
    color: #856404;
    font-size: 11px;
    border-radius: 4px;
    margin: 10px 15px;
}

/* Tablet Styles (481px - 768px) */
@media (min-width: 481px) and (max-width: 768px) {
    .welcome-card {
        padding: 40px 30px;
        max-width: 480px;
    }
    
    .welcome-logo {
        width: 140px;
        height: 140px;
    }
    
    .welcome-title {
        font-size: 26px;
    }
    
    .header h1 {
        font-size: 24px;
    }
    
    .assistant-image {
        width: 130px;
        height: 130px;
    }
    
    .action-btn {
        font-size: 14px;
        padding: 14px 10px;
    }
    
    .assistant-input {
        font-size: 16px;
        min-height: 120px;
    }
}

/* Desktop Styles (769px and above) */
@media (min-width: 769px) {
    .welcome-card {
        padding: 50px 40px;
        max-width: 500px;
    }
    
    .welcome-logo {
        width: 160px;
        height: 160px;
    }
    
    .welcome-title {
        font-size: 32px;
    }
    
    .watermark {
        font-size: 11px;
        padding: 8px 15px;
        bottom: 10px;
        right: 10px;
    }
    
    .container {
        max-width: 100%;
        margin: 0 auto;
    }
    
    .header {
        padding: 35px 30px;
    }
    
    .header h1 {
        font-size: 32px;
    }
    
    .assistant-section {
        padding: 30px 30px 40px;
        max-width: 900px;
        margin: 0 auto;
    }
    
    .assistant-image {
        width: 180px;
        height: 180px;
    }
    
    .action-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        max-width: 800px;
        margin: 15px auto 0;
    }
    
    .action-btn {
        font-size: 15px;
        padding: 14px 12px;
        min-height: 55px;
    }
    
    .action-btn:hover {
        border-color: #667eea;
        background: #f0f4ff;
        transform: translateX(3px);
    }
    
    .main-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }
    
    .assistant-input {
        max-width: 800px;
        margin: 0 auto;
        display: block;
        font-size: 16px;
        padding: 18px;
    }
    
    .send-btn {
        max-width: 800px;
        margin: 15px auto 0;
        display: block;
    }
    
    .send-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
    }
    
    .input-container {
        padding: 25px 30px;
    }
    
    .quick-actions {
        padding: 25px 30px;
    }
    
    .question-card {
        max-width: 800px;
        margin: 0 auto 15px;
        padding: 20px 18px;
    }
    
    .question-text {
        font-size: 15px;
    }
    
    .option-btn {
        font-size: 14px;
        padding: 12px 15px;
    }
    
    .option-btn:hover {
        border-color: #667eea;
        background: #f0f4ff;
        transform: translateX(5px);
    }
    
    .submit-test-btn {
        max-width: 400px;
        margin: 25px auto 15px;
    }
    
    .submit-test-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }
    
    .certificate-container {
        padding: 40px 30px;
        max-width: 900px;
        margin: 0 auto;
    }
    
    .certificate-header {
        font-size: 32px;
    }
    
    .certificate-body {
        font-size: 16px;
    }
    
    .score-big {
        font-size: 52px;
    }
    
    .performance-badge {
        font-size: 16px;
        padding: 10px 25px;
    }
    
    .welcome-content {
        padding: 35px 30px;
        max-width: 380px;
    }
    
    .welcome-icon {
        font-size: 70px;
    }
    
    .welcome-title {
        font-size: 26px;
    }
    
    .welcome-text {
        font-size: 15px;
    }
    
  .permission-text {
        font-size: 13px;
        text-align: justify; /* Add here too */
    }
}
    
    .start-btn {
        max-width: 350px;
        margin: 0 auto;
    }
    
    .start-btn.enabled:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 22px rgba(76, 175, 80, 0.6);
    }
    
    .audio-control-section {
        max-width: 800px;
        margin: 0 auto 10px;
    }
    
    .play-stop-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.5);
    }
}

/* Extra Small Mobile (max 400px) */
@media (max-width: 400px) {
    .welcome-card {
        padding: 25px 15px;
    }
    
    .welcome-logo {
        width: 100px;
        height: 100px;
    }
    
    .welcome-title {
        font-size: 20px;
    }
    
    .welcome-subtitle {
        font-size: 13px;
    }
    
    .roll-input {
        font-size: 16px;
        padding: 12px 18px;
    }
    
    .enter-btn {
        font-size: 14px;
        padding: 13px;
    }
    
    .header h1 {
        font-size: 18px;
    }
    
    .header p {
        font-size: 11px;
    }
    
    .assistant-image {
        width: 95px;
        height: 95px;
    }
    
    .actions-title {
        font-size: 14px;
    }
    
    .main-action-btn {
        font-size: 14px;
        padding: 12px;
    }
    
    .action-btn {
        font-size: 12px;
        padding: 10px 6px;
        min-height: 48px;
    }
    
    .assistant-input {
        font-size: 14px;
        padding: 13px;
        min-height: 90px;
    }
    
    .send-btn {
        font-size: 13px;
        padding: 12px 25px;
    }
    
    .question-text {
        font-size: 13px;
    }
    
    .option-btn {
        font-size: 12px;
        padding: 9px 10px;
    }
    
    .certificate-header {
        font-size: 20px;
    }
    
    .certificate-body {
        font-size: 13px;
    }
    
    .score-big {
        font-size: 36px;
    }
    
    .performance-badge {
        font-size: 13px;
        padding: 7px 18px;
    }
    
    .welcome-content {
        padding: 20px 15px;
    }
    
    .welcome-icon {
        font-size: 45px;
    }
    
    .welcome-title {
        font-size: 20px;
    }
    
    .welcome-text {
        font-size: 12px;
    }
    
    .permission-item {
        padding: 10px;
        gap: 8px;
    }
    
    .permission-text {
         font-size: 11px;
        text-align: justify; /* Add here too */
    }
    
    .start-btn {
        font-size: 14px;
        padding: 12px 35px;
    }
    
    .match-option {
        font-size: 11px;
        padding: 8px !important;
    }
    
    .matching-columns-grid {
        gap: 6px;
        padding: 0 5px;
    }
}

/* Landscape Orientation Optimization */
@media (max-height: 600px) and (orientation: landscape) {
    .welcome-page {
        padding-top: 15px;
    }
    
    .welcome-card {
        padding: 20px 25px;
    }
    
    .welcome-logo {
        width: 90px;
        height: 90px;
        margin-bottom: 15px;
    }
    
    .welcome-title {
        font-size: 20px;
        margin-bottom: 6px;
    }
    
    .welcome-subtitle {
        font-size: 13px;
        margin-bottom: 20px;
    }
    
    .roll-input-group {
        margin-bottom: 15px;
    }
    
    .assistant-image {
        width: 90px;
        height: 90px;
    }
    
    .header {
        padding: 15px;
    }
    
    .welcome-content {
        padding: 20px;
        margin: 10px auto;
    }
    
    .welcome-icon {
        font-size: 40px;
        margin-bottom: 8px;
    }
}

/* Print Styles */
@media print {
    .welcome-page,
    .watermark,
    .main-action-btn,
    .action-grid,
    .send-btn,
    .audio-control-section {
        display: none !important;
    }
    
    .container {
        display: block !important;
    }
    
    .header {
        background: white !important;
        color: black !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .certificate-container {
        page-break-inside: avoid;
    }
}

/* Accessibility Improvements */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
    .action-btn,
    .option-btn {
        border-width: 3px;
    }
    
    .roll-input,
    .assistant-input {
        border-width: 3px;
    }
}

/* Dark Mode Support (if needed in future) */
@media (prefers-color-scheme: dark) {
    /* Currently using fixed color scheme, but structure ready for dark mode */
}

/* Settings Panel Styles */
#settingsPanel {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    padding: 20px;
    overflow-y: auto;
}

.settings-modal {
    background: white;
    max-width: 500px;
    margin: 50px auto;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.settings-title {
    font-size: 20px;
    font-weight: 700;
    color: #667eea;
}

.close-settings {
    background: #f44336;
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
}

.settings-steps {
    margin-bottom: 20px;
    padding-left: 20px;
    line-height: 1.8;
}

.settings-steps li {
    margin-bottom: 8px;
}

.settings-link {
    color: #667eea;
    text-decoration: underline;
}

.api-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #667eea;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 14px;
    box-sizing: border-box;
}

.save-api-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
}

.save-api-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.5);
}

.settings-note {
    font-size: 12px;
    color: #999;
    margin-top: 10px;
    text-align: center;
}



  @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .pulse-ring {
            animation: pulse-ring 1.5s ease-out infinite;
        }
        .message-text {
            font-weight: 600;
            text-align: justify;
            line-height: 1.6;
        }
        @media (max-width: 640px) {
    body {
        font-size: 14px;
    }
    
    h1 {
        font-size: 1.25rem !important;
    }
    
    .message-text {
        font-size: 0.95rem;
        line-height: 1.5;
    }
    
    /* Improve input area spacing on mobile */
    #messageInput {
        font-size: 16px !important; /* Prevents zoom on iOS */
    }
    
    /* Make buttons more touch-friendly */
    button {
        min-height: 44px;
    }
    
    /* Adjust header padding */
    .bg-gradient-to-r.from-orange-600 {
        padding: 0.75rem 1rem;
    }
    
    /* Improve quick action buttons on mobile */
    #quickActions button {
        font-size: 0.8rem;
        padding: 0.5rem;
    }
}
    </style>
</head>
<body>

   <!-- Welcome Page with Roll Number -->
<div class="welcome-page" id="welcomePage">
    <div class="welcome-card">
        <h1 class="welcome-title">Welcome to</h1>
        <p class="welcome-subtitle">Odisha e-Guru Learning Platform</p>
        
        <div class="roll-input-group">
            <label class="roll-label">üéì Enter Your Roll Number</label>
            <input type="number" 
                   id="rollInput" 
                   class="roll-input" 
                   placeholder="Enter Roll Number">
        </div>
        
<!-- Single Consolidated Consent Checkbox -->
<div style="background: linear-gradient(135deg, #f8f9ff 0%, #e8eeff 100%); border: 2px solid #667eea; border-radius: 16px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15); transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.25)'" onmouseout="this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.15)'">
    <div style="display: flex; align-items: flex-start; gap: 15px; cursor: pointer;" onclick="toggleConsentCheckbox()">
        <div id="consentCheckbox" class="permission-checkbox" style="width: 28px; height: 28px; border: 3px solid #667eea; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.3s ease; margin-top: 3px; background: white;">
        </div>
        <div style="flex: 1; color: #2d3748;">
            <span style="font-size: 15px; line-height: 1.7; text-align: justify; display: block;">
                <strong style="color: #667eea;">I consent to</strong> automatic audio playback, internet access for translations, external search when needed, data storage access, and agree to all <a href="https://sites.google.com/view/eguruodishastp/terms-and-conditions" style="color: #667eea; text-decoration: none; font-weight: 600; border-bottom: 2px solid #667eea; transition: all 0.2s;" onmouseover="this.style.borderBottomColor='#764ba2'" onmouseout="this.style.borderBottomColor='#667eea'">terms and conditions</a> of Odisha e-Guru including collection of device information for security purposes.
            </span>
        </div>
    </div>
</div>
        
        <button class="enter-btn" id="enterBtn" onclick="validateAndEnter()">
            üöÄ Start Learning
        </button>
        
        <div class="message" id="messageBox"></div>
        
        <div class="security-badge">
            <div class="security-badge-title">üîí Secure Access</div>
            <div class="security-badge-text">
                Your roll number is linked to this device only.<br>
                Sharing is not allowed and will be detected.
            </div>
        </div>
        
        <p class="info-text">
            üìö Your gateway to BNSS Section-1 learning
        </p>
    </div>
</div>
    <div class="container" id="mainApp">
        <div class="header">
    <div class="user-info" id="userInfo">Roll: --</div>
    <h1>üéì Odisha e-Guru Assistant</h1>
          
            <img src="https://raw.githubusercontent.com/eguruOdisha/legal-support-services/main/Gif%2BGB%20(2).gif" 
                 alt="AI Assistant" 
                 class="assistant-image">
        </div>

        <div class="assistant-section">
            <div class="quick-actions">
                <button class="main-action-btn" id="mainActionBtn" onclick="toggleActions()">
                    ‚ÑπÔ∏è What Can I Do? <span style="margin-left: auto;">‚ñº</span>
                </button>

                <div class="action-grid hidden" id="actionGrid">
   <button class="action-btn" onclick="quickAction('concept')">
                        üí° Concept & Example
                    </button>
                    <button class="action-btn" onclick="quickAction('mcq')">
                        üìù MCQ Test
                    </button>
                    <button class="action-btn" onclick="quickAction('truefalse')">
                        ‚úì‚úó True/False
                    </button>
                    <button class="action-btn" onclick="quickAction('fillblanks')">
                        üìã Fill Blanks
                    </button>
                    <button class="action-btn" onclick="quickAction('matching')">
                        üîó Matching
                    </button>
                    <button class="action-btn" onclick="quickAction('arrange')">
                        üî§ Arrange Words
                    </button>
               </div>

<!-- NEW: BNSS Section Toggle Button -->
<button class="main-action-btn" id="bnssTextBtn" onclick="toggleBNSSText()" 
        style="margin-top: 12px; background: linear-gradient(135deg, #4CAF50, #45a049);">
    üìú View BNSS Section-1 Text <span style="margin-left: auto;" id="bnssArrow">‚ñº</span>
</button>

<!-- NEW: BNSS Text Content (Hidden by default) -->
<div id="bnssTextContent" style="display: none; background: white; border: 3px solid #4CAF50; border-radius: 12px; padding: 20px; margin: 12px 15px 0 15px; box-shadow: 0 3px 15px rgba(0,0,0,0.1);">
    <h3 style="color: #4CAF50; font-size: 18px; font-weight: 900; margin-bottom: 15px; text-align: center;">
        BNSS, 2023: Section-1
    </h3>
    <h4 style="color: #667eea; font-size: 16px; font-weight: 700; margin-bottom: 12px; text-align: center;">
        Short title, extent and commencement.
    </h4>
    
    <div style="background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <p style="text-align: justify; line-height: 1.6;">
            <strong style="color: #667eea;">(1)</strong> This Act may be called the <strong>Bharatiya Nagarik Suraksha Sanhita, 2023</strong>.
        </p>
    </div>
    
    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <p style="text-align: justify; line-height: 1.6;">
            <strong style="color: #856404;">(2)</strong> The provisions of this Sanhita, other than those relating to Chapters IX, XI and XII thereof, shall not apply---
        </p>
        <div style="margin-top: 10px; padding-left: 20px;">
            <div style="margin-bottom: 8px; text-align: justify;"><strong>(a)</strong> to the State of Nagaland;</div>
            <div style="text-align: justify;"><strong>(b)</strong> to the tribal areas,</div>
        </div>
        <p style="margin-top: 10px; text-align: justify; line-height: 1.6;">but the concerned State Government may, by notification, apply such provisions or any of them to the whole or part of the State of Nagaland or such tribal areas, as the case may be, with such supplemental, incidental or consequential modifications, as may be specified in the notification.</p>
    </div>
    
    <div style="background: #e3f2fd; border-left: 4px solid #2196F3; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <p style="text-align: justify; line-height: 1.6;">
            <strong style="color: #1976D2;">Explanation.</strong>---In this section, "tribal areas" means the territories which immediately before the 21st day of January, 1972, were included in the tribal areas of Assam, as referred to in paragraph 20 of the Sixth Schedule to the Constitution, other than those within the local limits of the municipality of Shillong.
        </p>
    </div>
    
    <div style="background: #e8f5e9; border-left: 4px solid #4CAF50; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <p style="text-align: justify; line-height: 1.6;">
            <strong style="color: #2e7d32;">(3)</strong> It shall come into force on such date<sup>1</sup> as the Central Government may, by notification in the Official Gazette, appoint.
        </p>
    </div>
    
    <div style="background: #f5f5f5; border-left: 4px solid #9e9e9e; padding: 15px; border-radius: 8px;">
        <strong style="color: #666;">FOOTNOTE:</strong> 
        <p style="margin-top: 8px; font-size: 13px; line-height: 1.6; text-align: justify;">
            <sup>1</sup> 1st July, 2024, [except the provisions of the entry relation to Section 106(2) in the first Schedule], vide notification No. S.O. 848(E), dated, 23rd day of February, 2024, see Gazette of India, Extraordinary, Part II, sec. 3(ii).
        </p>
    </div>
</div>


         <div class="input-container">
                <label class="input-label">üí¨ Ask Your Question (Hindi/English):</label>
                
                <!-- Mode Toggle -->
                <div style="display: flex; gap: 10px; margin: 0 15px 15px 15px; justify-content: center;">
                    <button id="teacherModeBtn" onclick="switchMode('teacher')" style="flex: 1; padding: 12px; border-radius: 25px; font-size: 14px; font-weight: 700; cursor: pointer; border: 2px solid #667eea; background: linear-gradient(135deg, #667eea, #764ba2); color: white; transition: all 0.3s ease;">
                        üë®‚Äçüè´ Teacher Mode
                    </button>
                    <button id="aiModeBtn" onclick="switchMode('ai')" style="flex: 1; padding: 12px; border-radius: 25px; font-size: 14px; font-weight: 700; cursor: pointer; border: 2px solid #ddd; background: white; color: #666; transition: all 0.3s ease;">
                        ü§ñ AI Mode
                    </button>
                </div>
                
                <div class="audio-control-section" id="teacherControls">
                    <div class="audio-toggle">
                        <input type="checkbox" id="autoplayCheckbox" class="audio-checkbox" checked onchange="toggleAutoplay()">
                        <label for="autoplayCheckbox" class="audio-label">üîä Auto-play audio answers</label>
                    </div>
                </div>
                
                <!-- AI Mode Controls (Hidden by default) -->
                <div id="aiControls" style="display: none; margin: 0 15px 15px 15px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <select id="languageSelect" style="flex: 1; padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; font-weight: 600;">
                            <option value="or">‡¨ì‡¨°‡¨º‡¨ø‡¨Ü (Odia)</option>
                            <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                            <option value="en">English</option>
                            <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                            <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                        </select>
                        <select id="answerMode" style="flex: 1; padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; font-weight: 600;">
                            <option value="quick">‡¨∑‡≠ç‡¨ü‡≠á‡¨™‡≠ç‡¨∏ (Steps)</option>
                            <option value="steps" selected>‡¨∂‡≠Ä‡¨ò‡≠ç‡¨∞ (Quick)</option>
                            <option value="table">‡¨ü‡≠á‡¨¨‡≠Å‡¨≤‡≠ç (Table)</option>
                            <option value="verify">‡¨Ø‡¨æ‡¨û‡≠ç‡¨ö (Verify)</option>
                        </select>
                    </div>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f0f8ff; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: #667eea;">
                        <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <span>üìÑ Upload Document (PDF/Image)</span>
                        <input type="file" id="pdfInput" accept=".pdf,image/*" style="display: none;" onchange="handleFileUpload(event)">
                    </label>
                    <div id="pdfStatus" style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">üìä Ready for questions</div>
                    <button id="apiKeyBtn" onclick="toggleSettings()" style="width: 100%; margin-top: 10px; padding: 10px; background: linear-gradient(135deg, #FFA726, #FB8C00); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">
                        ‚öôÔ∏è Set API Key (Required for AI Mode)
                    </button>
                </div>
                
                <textarea class="assistant-input" 
                          id="assistantInput" 
                          placeholder="Please write here....."
                          onkeypress="if(event.key === 'Enter' && event.shiftKey) { event.preventDefault(); handleSendMessage(); }"></textarea>
                
                <button class="send-btn" id="sendBtnMain" onclick="handleSendMessage()">
                    Send Question ‚û§
                </button>
                
                <!-- AI Mode Quick Actions -->
                <div id="aiQuickActions" style="display: none; margin-top: 15px; padding: 0 15px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button onclick="askQuickQuestion('summary')" style="padding: 12px; background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer;">
                            üìù ‡¨∏‡¨æ‡¨∞‡¨æ‡¨Ç‡¨∂<br><span style="font-size: 11px; opacity: 0.9;">Summary</span>
                        </button>
                        <button onclick="askQuickQuestion('keypoints')" style="padding: 12px; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer;">
                            üéØ ‡¨Æ‡≠Å‡¨ñ‡≠ç‡≠ü ‡¨¨‡¨ø‡¨®‡≠ç‡¨¶‡≠Å<br><span style="font-size: 11px; opacity: 0.9;">Key Points</span>
                        </button>
                        <button onclick="askQuickQuestion('explain')" style="padding: 12px; background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer;">
                            üí° ‡¨¨‡≠Å‡¨ù‡¨æ‡¨Ö<br><span style="font-size: 11px; opacity: 0.9;">Explain</span>
                        </button>
                        <button onclick="generatePracticeQuestions()" style="padding: 12px; background: linear-gradient(135deg, #FF9800, #F57C00); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer;">
                            üìö ‡¨Ö‡¨≠‡≠ç‡≠ü‡¨æ‡¨∏<br><span style="font-size: 11px; opacity: 0.9;">Practice</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="response-container" id="responseContainer"></div>
        </div>

<!-- Hidden container for AI mode messages -->
<div id="aiMessagesContainer" style="display: none; padding: 0; margin: 0; background: white;">
    <div id="chatContainer" style="flex: 1; overflow-y: auto; padding: 15px; max-height: 500px;">
        <div style="max-width: 100%; margin: 0 auto;" id="messages"></div>
    </div>
    
    <div id="speakingStatus" style="display: none; background: #e8f5e9; border-top: 2px solid #4CAF50; padding: 12px 15px;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 8px; color: #2e7d32;">
                <svg style="width: 20px; height: 20px; animation: pulse 1s infinite;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                </svg>
                <span style="font-size: 13px; font-weight: 600;">‡¨ï‡¨π‡≠Å‡¨õ‡¨ø... (Speaking...)</span>
            </div>
            <button onclick="stopSpeaking()" style="padding: 6px 15px; background: #f44336; color: white; border: none; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer;">
                ‡¨¨‡¨®‡≠ç‡¨¶ ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å (Stop)
            </button>
        </div>
    </div>
</div>

<!-- Settings Panel (Hidden, accessible via button in AI mode) -->
<div id="settingsPanel" onclick="closeSettingsOnOverlay(event)">
    <div class="settings-modal" onclick="event.stopPropagation();">
        <div class="settings-header">
            <h3 class="settings-title">‚öôÔ∏è API Settings</h3>
            <button class="close-settings" onclick="toggleSettings()">√ó</button>
        </div>
        
        <ol class="settings-steps">
            <li>Visit: <a href="https://aistudio.google.com/app/apikey" target="_blank" class="settings-link">Google AI Studio</a></li>
            <li>Click "Create API Key"</li>
            <li>Copy and paste below:</li>
        </ol>

        <input type="password" id="apiKeyInput" class="api-input" placeholder="Paste your API Key here">
        <button onclick="saveApiKey()" class="save-api-btn">
            üíæ Save API Key
        </button>
        <p class="settings-note">‚ö†Ô∏è Your API Key is stored locally in your browser only.</p>
    </div>
</div>

<!-- Watermark -->
<div class="watermark" id="watermark"></div>
    </div>

<style>
#loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
}
</style>

<div id="loading-screen">
    <div style="text-align: center; color: white;">
        <div style="font-size: 50px; margin-bottom: 20px;">‚è≥</div>
        <h2>Loading...</h2>
    </div>
</div>

<script>
window.addEventListener('load', () => {
    document.getElementById('loading-screen').style.display = 'none';
});
</script>

<script>
let assistantQAData = null;
let userRollNumber = null;
let userDeviceId = null;
let sessionStartTime = null;
let consentChecked = false;
let currentMode = 'teacher'; // 'teacher' or 'ai'


// Mode Switching
function switchMode(mode) {
    currentMode = mode;
    
    const teacherBtn = document.getElementById('teacherModeBtn');
    const aiBtn = document.getElementById('aiModeBtn');
    const teacherControls = document.getElementById('teacherControls');
    const aiControls = document.getElementById('aiControls');
    const aiQuickActions = document.getElementById('aiQuickActions');
    const responseContainer = document.getElementById('responseContainer');
    const aiMessagesContainer = document.getElementById('aiMessagesContainer');
    const assistantInput = document.getElementById('assistantInput');
    
    if (mode === 'teacher') {
        // Style buttons
        teacherBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
        teacherBtn.style.color = 'white';
        teacherBtn.style.borderColor = '#667eea';
        
        aiBtn.style.background = 'white';
        aiBtn.style.color = '#666';
        aiBtn.style.borderColor = '#ddd';
        
        // Show/hide controls
        teacherControls.style.display = 'block';
        aiControls.style.display = 'none';
        aiQuickActions.style.display = 'none';
        responseContainer.style.display = 'block';
        aiMessagesContainer.style.display = 'none';
        
        // Update placeholder
        assistantInput.placeholder = 'Please write here.....';
        
    } else { // AI mode

// Check if API key is already set
        const apiKeyBtn = document.getElementById('apiKeyBtn');
        if (apiKeyBtn && apiKey && apiKey.length > 20) {
            apiKeyBtn.innerHTML = '‚úÖ API Key Set (Click to Change)';
            apiKeyBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
        }
        // Style buttons
        aiBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
        aiBtn.style.color = 'white';
        aiBtn.style.borderColor = '#667eea';
        
        teacherBtn.style.background = 'white';
        teacherBtn.style.color = '#666';
        teacherBtn.style.borderColor = '#ddd';
        
        // Show/hide controls
        teacherControls.style.display = 'none';
        aiControls.style.display = 'block';
        aiQuickActions.style.display = 'block';
        responseContainer.style.display = 'none';
        aiMessagesContainer.style.display = 'block';
        
        // Update placeholder
        assistantInput.placeholder = '‡¨Ø‡≠á‡¨ï‡≠å‡¨£‡¨∏‡¨ø ‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨® ‡¨™‡¨ö‡¨æ‡¨∞‡¨®‡≠ç‡¨§‡≠Å... (Ask any question...)';
        
        // Load JSON if not already loaded (for AI mode)
        if (!jsonContent && !pdfContent) {
            loadJsonFromGithub();
        }
    }
}

// Unified send handler
function handleSendMessage() {
    if (currentMode === 'teacher') {
        sendQuery(); // Original teacher mode function
    } else {
        sendMessage(); // AI mode function
    }
}

// Configuration


// Configuration
const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSV_NiKHXWdgB75gy-qNFLeeVUzTEM5ysWxeZqQ3Fj0MjvTTBr2EAaQe5hqz1Wd8xd/exec';
let currentTest = null;
let userAnswers = {};
let currentAudio = null;
let autoplayEnabled = true;
let cumulativeScore = 0;              // ‚úÖ ADD THIS
let cumulativeTotalMarks = 0;         // ‚úÖ ADD THIS

// Device Fingerprinting
function generateDeviceFingerprint() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('fingerprint', 2, 2);
    const canvasData = canvas.toDataURL();
    
    const fingerprint = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        screenRes: `${screen.width}x${screen.height}x${screen.colorDepth}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        canvas: hashString(canvasData),
        webGL: getWebGLFingerprint(),
        cpuCores: navigator.hardwareConcurrency || 'unknown',
        deviceMemory: navigator.deviceMemory || 'unknown',
        touchSupport: 'ontouchstart' in window
    };
    
    return hashString(JSON.stringify(fingerprint));
}

function getWebGLFingerprint() {
    try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) return 'no-webgl';
        
        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
        if (!debugInfo) return 'no-debug-info';
        
        const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
        return hashString(renderer);
    } catch (e) {
        return 'error';
    }
}

function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return Math.abs(hash).toString(36);
}

// Message Display Helper
function showMessage(message, type = 'error') {
    const messageBox = document.getElementById('messageBox');
    messageBox.textContent = message;
    messageBox.className = `message ${type} show`;
    
    if (type !== 'loading') {
        setTimeout(() => {
            messageBox.classList.remove('show');
        }, 8000);
    }
}

// Consent Checkbox Toggle
function toggleConsentCheckbox() {
    consentChecked = !consentChecked;
    const checkbox = document.getElementById('consentCheckbox');
    const enterBtn = document.getElementById('enterBtn');
    
    if (consentChecked) {
        checkbox.style.background = '#4CAF50';
        checkbox.style.borderColor = '#4CAF50';
        checkbox.innerHTML = '<span style="color: white; font-size: 16px; font-weight: bold;">‚úì</span>';
        enterBtn.style.opacity = '1';
    } else {
        checkbox.style.background = 'transparent';
        checkbox.style.borderColor = '#666';
        checkbox.innerHTML = '';
        enterBtn.style.opacity = '0.6';
    }
}

// Roll Number Validation
async function validateAndEnter() {
    if (!assistantQAData) {
        await loadAssistantData();
    }
    const rollInput = document.getElementById('rollInput');
    const rollNumber = parseInt(rollInput.value);
    const enterBtn = document.getElementById('enterBtn');
    
    // Check consent first
    if (!consentChecked) {
        showMessage('‚ö†Ô∏è Please accept the consent to continue', 'error');
        return;
    }
    
    // Validate input
    if (isNaN(rollNumber) || rollNumber <= 0) {
        showMessage('‚ö†Ô∏è Please enter a valid roll number', 'error');
        rollInput.style.borderColor = '#ff6b6b';
        setTimeout(() => {
            rollInput.style.borderColor = '#667eea';
        }, 3000);
        return;
    }
    
    // Disable button and show loading
    enterBtn.disabled = true;
    enterBtn.textContent = '‚è≥ Verifying...';
    showMessage('üîç Verifying your roll number with server...', 'loading');
    
    // Generate device fingerprint
    userDeviceId = generateDeviceFingerprint();
    console.log('Device ID:', userDeviceId);
    
    // Browser info
    const getBrowserType = () => {
        const ua = navigator.userAgent.toLowerCase();
        if (ua.includes('chrome')) return 'Chrome';
        if (ua.includes('firefox')) return 'Firefox';
        if (ua.includes('safari')) return 'Safari';
        if (ua.includes('edge')) return 'Edge';
        return 'Other';
    };
    
    const getDeviceType = () => {
        if (/mobile|android|iphone/i.test(navigator.userAgent)) return 'Mobile';
        if (/tablet|ipad/i.test(navigator.userAgent)) return 'Tablet';
        return 'Desktop';
    };
    
    const browserInfo = `${getBrowserType()} | ${getDeviceType()}`;
    
    try {
        // Send verification request
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain',
            },
          
body: JSON.stringify({
    rollNumber: rollNumber,
    deviceId: userDeviceId,
    browserInfo: browserInfo,
    timestamp: new Date().toISOString(),
    appType: 'learning-assistant' // ‚úÖ MAKE SURE THIS IS SET
})
        });
        
        const result = await response.json();
        console.log('Server response:', result);
        
        if (result.success) {
            // SUCCESS
            userRollNumber = rollNumber;
            sessionStartTime = new Date();
            
            showMessage(result.message || '‚úÖ Roll number verified successfully!', 'success');
            
            setTimeout(() => {
                document.getElementById('welcomePage').style.display = 'none';
                document.getElementById('mainApp').classList.add('show');
                document.getElementById('userInfo').textContent = `Roll: ${rollNumber}`;
                updateWatermark();
                loadAssistantData();
            }, 1500);
            
        } else {
            // FAILED
            showMessage(result.message || '‚ùå Verification failed', 'error');
            enterBtn.disabled = false;
            enterBtn.textContent = 'üöÄ Start Learning';
        }
        
    } catch (error) {
        console.error('Verification error:', error);
        showMessage('‚ùå Connection error. Please check your internet and try again.', 'error');
        enterBtn.disabled = false;
        enterBtn.textContent = 'üöÄ Start Learning';
    }
}

// Watermark Update
function updateWatermark() {
    const watermark = document.getElementById('watermark');
    if (watermark && userRollNumber) {
        const now = new Date();
        watermark.textContent = `Roll: ${userRollNumber} | ${now.toLocaleTimeString('en-IN')}`;
        
        setInterval(() => {
            const time = new Date().toLocaleTimeString('en-IN');
            watermark.textContent = `Roll: ${userRollNumber} | ${time}`;
        }, 60000);
    }
}

// Enter Key Support
window.addEventListener('DOMContentLoaded', function() {
    const rollInput = document.getElementById('rollInput');
    if (rollInput) {
        rollInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                validateAndEnter();
            }
        });
    }
});

// Session Monitoring
let inactivityTimer;
const INACTIVITY_LIMIT = 30 * 60 * 1000; // 30 minutes

function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        alert('‚è∞ Session expired due to inactivity. Please refresh the page.');
        location.reload();
    }, INACTIVITY_LIMIT);
}

['mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer);
});

resetInactivityTimer();



let shownQuestions = {
    mcq: [],
    truefalse: [],
    fillblank: [],
    fillblanks: [],
    matching: [],
    word_arrangement: []
};

const CATEGORIES = {
    'bare_act': 'üìú Bare Section',
    'subsection_1': 'üìã Subsection-1',
    'subsection_2': 'üìã Subsection-2',
    'explanation_subsection_2': 'üí° Explanation to Subsection-2',
    'subsection_3': 'üìã Subsection-3',
    'footnote': 'üìù Footnote'
};

const CONCEPT_CATEGORIES = {
    'bare_act': 'üìú Bare Section',
    'subsection_1': 'üìã Subsection-1',
    'subsection_2': 'üìã Subsection-2',
    'explanation_to_subsection_2': 'üí° Explanation to Subsection-2',
    'subsection_3': 'üìã Subsection-3',
    'footnote': 'üìù Footnote'              // ‚úÖ Only keep this one
};

async function loadAssistantData() {
    try {
        console.log('üîÑ Loading assistant data...');
        
        // ‚úÖ CHECK CACHE FIRST (avoids network request)
        const CACHE_KEY = 'assistantQAData';
        const CACHE_TIME_KEY = 'assistantQADataTime';
        const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        
        const cachedData = localStorage.getItem(CACHE_KEY);
        const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
        
        // If cache exists and is fresh, use it
        if (cachedData && cachedTime) {
            const age = Date.now() - parseInt(cachedTime);
            if (age < CACHE_DURATION) {
                console.log('‚úÖ Using cached data (age: ' + Math.round(age / 1000 / 60) + ' minutes)');
                assistantQAData = JSON.parse(cachedData);
                
                // Fix data structure if needed
                assistantQAData = Array.isArray(assistantQAData) ? assistantQAData[0] : assistantQAData;
                
                console.log('‚úÖ Assistant data loaded from cache');
                return;
            } else {
                console.log('‚è∞ Cache expired, fetching fresh data...');
            }
        }
        
        // ‚úÖ FETCH FROM NETWORK (only if cache miss or expired)
        console.log('üåê Fetching from network...');
        const timestamp = Date.now();
        const response = await fetch(`https://raw.githubusercontent.com/eguruOdisha/audio/main/assistant-qa.json?t=${timestamp}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            },
            cache: 'no-cache'  // Force fresh fetch when needed
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Fix data structure
        assistantQAData = Array.isArray(data) ? data[0] : data;
        
        // ‚úÖ SAVE TO CACHE for next time
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify(assistantQAData));
            localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
            console.log('üíæ Data cached successfully');
        } catch (cacheError) {
            console.warn('‚ö†Ô∏è Failed to cache data (storage full?):', cacheError);
            // Continue anyway - caching is optional
        }
        
        console.log('‚úÖ Assistant data loaded from network');
        console.log('üìä Data structure:', Object.keys(assistantQAData));
        console.log('üìä Section1 keys:', assistantQAData.section1 ? Object.keys(assistantQAData.section1) : 'section1 not found');
        
    } catch (error) {
        console.error('‚ùå Failed to load assistant data:', error);
        
        // ‚úÖ FALLBACK: Try to use old cache even if expired
        const oldCache = localStorage.getItem('assistantQAData');
        if (oldCache) {
            console.log('‚ö†Ô∏è Using expired cache as fallback');
            assistantQAData = JSON.parse(oldCache);
            assistantQAData = Array.isArray(assistantQAData) ? assistantQAData[0] : assistantQAData;
            return;
        }
        
        // No cache available - show error
        assistantQAData = null;
        alert('‚ö†Ô∏è Failed to load database. Please check your internet connection and refresh the page.');
    }
}


function getMermaidForCategory(category) {
    const mermaidGraphs = {
        'bare_act': `
graph TD
    A[BNSS Section 1] --> B[Short Title]
    A --> C[Extent]
    A --> D[Commencement]
    B --> E[Bharatiya Nagarik<br/>Suraksha Sanhita 2023]
    C --> F[Special Provisions<br/>for Nagaland]
    C --> G[Tribal Areas<br/>Exceptions]
    D --> H[Notified Date:<br/>1st July 2024]
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style E fill:#4CAF50,stroke:#45a049,color:#fff
`,
        'subsection_1': `
graph LR
    A[Subsection 1] --> B[Short Title]
    B --> C[Bharatiya Nagarik<br/>Suraksha Sanhita]
    B --> D[Year: 2023]
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style C fill:#4CAF50,stroke:#45a049,color:#fff
`,
        'subsection_2': `
graph TD
    A[Subsection 2:<br/>Extent] --> B[General Application]
    A --> C[Exceptions]
    C --> D[Nagaland State]
    C --> E[Tribal Areas]
    E --> F[Assam Tribal Areas<br/>pre-1972]
    E --> G[Excluding Shillong<br/>Municipality]
    D --> H[State Govt can<br/>notify application]
    E --> H
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style C fill:#FF6B6B,stroke:#FF8E53,color:#fff
`,
        'explanation_to_subsection_2': `
graph TD
    A[Explanation to<br/>Subsection 2] --> B[Defines 'Tribal Areas']
    B --> C[Territories before<br/>21st January 1972]
    C --> D[Included in Assam<br/>Tribal Areas]
    D --> E[As per Sixth Schedule<br/>to Constitution]
    E --> F[Paragraph 20]
    C --> G[Exclusion: Shillong<br/>Municipality]
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style B fill:#FFA726,stroke:#FB8C00,color:#fff
`,
        'subsection_3': `
graph LR
    A[Subsection 3:<br/>Commencement] --> B[Central Govt<br/>Notification]
    B --> C[Official Gazette]
    C --> D[Appointed Date:<br/>1st July 2024]
    D --> E[Except Section<br/>106 2]
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style D fill:#4CAF50,stroke:#45a049,color:#fff
`,
        'footnote': `
graph TD
    A[Footnote 1] --> B[Commencement Date]
    B --> C[1st July 2024]
    C --> D[Exception]
    D --> E[Section 106 2<br/>in First Schedule]
    B --> F[Notification Details]
    F --> G[S.O. 848 E]
    F --> H[Date: 23rd Feb 2024]
    F --> I[Gazette of India<br/>Extraordinary]
    style A fill:#667eea,stroke:#764ba2,color:#fff
    style C fill:#4CAF50,stroke:#45a049,color:#fff
    style E fill:#FF6B6B,stroke:#FF8E53,color:#fff
`
    };
    
    return mermaidGraphs[category] || null;
}

// UI FUNCTIONS
function toggleActions() {
    const actionGrid = document.getElementById('actionGrid');
    const mainBtn = document.getElementById('mainActionBtn');
    const arrow = mainBtn.querySelector('span');
    
    if (actionGrid.classList.contains('hidden')) {
        actionGrid.classList.remove('hidden');
        arrow.textContent = '‚ñ≤';
    } else {
        actionGrid.classList.add('hidden');
        arrow.textContent = '‚ñº';
    }
}


function toggleAutoplay() {
    autoplayEnabled = document.getElementById('autoplayCheckbox').checked;
    console.log('Autoplay:', autoplayEnabled ? 'Enabled' : 'Disabled');
}

// AUDIO FUNCTIONS
function playAudio(audioUrl) {
    if (!audioUrl) return;
    
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
    }
    
    currentAudio = new Audio(audioUrl);
    
    currentAudio.addEventListener('ended', () => {
        updatePlayButton(false);
    });
    
    currentAudio.addEventListener('play', () => {
        updatePlayButton(true);
    });
    
    currentAudio.play().catch(error => {
        console.error('Audio playback failed:', error);
        alert('‚ö†Ô∏è Audio playback failed. Please check your internet connection.');
    });
}

function togglePlayStop() {
    if (!currentAudio) return;
    
    if (currentAudio.paused) {
        currentAudio.play();
    } else {
        currentAudio.pause();
        updatePlayButton(false);
    }
}

function updatePlayButton(isPlaying) {
    const playBtn = document.getElementById('playStopBtn');
    if (!playBtn) return;
    
    if (isPlaying) {
        playBtn.innerHTML = '<span style="font-size: 18px;">‚è∏Ô∏è</span> Stop Audio';
        playBtn.classList.add('playing');
    } else {
        playBtn.innerHTML = '<span style="font-size: 18px;">‚ñ∂Ô∏è</span> Play Audio';
        playBtn.classList.remove('playing');
    }
}


function sendQuery() {
    try {
        const inputElement = document.getElementById('assistantInput');
        const query = (inputElement && inputElement.value) ? inputElement.value.trim() : '';
        if (!query) {
            alert('‚ö†Ô∏è Please write your question first.');
            return;
        }

        const normalizedQuery = query.toLowerCase().replace(/\s+/g, ' ').trim();
        console.log('üîç Query:', query);
        console.log('üîç Normalized:', normalizedQuery);

        // Extract all numbers from the query
        const numberMatches = normalizedQuery.match(/\d+/g);
        const extractedNumber = numberMatches ? parseInt(numberMatches[numberMatches.length - 1], 10) : null;
        
        console.log('üî¢ Extracted number:', extractedNumber);

        // Enhanced category patterns - MORE SPECIFIC MATCHING
        const CATEGORY_PATTERNS = [
            { 
                key: 'explanation_to_subsection_2', 
                patterns: [
                    'explanation to subsection 2',
                    'explanation subsection 2',
                    'explanation to subsection two',
                    'explanation subsection two',
                    'explanation to sub section 2',
                    'explanation sub section 2',
                    'explanation to subsection2',
                    'explanation subsection2'
                ]
            },
            { 
                key: 'subsection_1', 
                patterns: [
                    'subsection 1',
                    'subsection one',
                    'sub section 1',
                    'sub section one',
                    'subsection1',
                    'subsection-1'
                ]
            },
            { 
                key: 'subsection_2', 
                patterns: [
                    'subsection 2',
                    'subsection two',
                    'sub section 2',
                    'sub section two',
                    'subsection2',
                    'subsection-2'
                ]
            },
            { 
                key: 'subsection_3', 
                patterns: [
                    'subsection 3',
                    'subsection three',
                    'sub section 3',
                    'sub section three',
                    'subsection3',
                    'subsection-3'
                ]
            },
            { 
                key: 'footnote', 
                patterns: [
                    'footnote',
                    'foot note',
                    'foot notes',
                    'foot-note'
                ]
            },
            { 
                key: 'bare_act', 
                patterns: [
                    'bare act',
                    'bare section',
                    'section 1',
                    'section one',
                    'bareact',
                    'bare-act'
                ]
            }
        ];

        let detectedCategory = null;
        // Sort patterns by length (longest first) for better matching
        for (const catObj of CATEGORY_PATTERNS) {
            const sortedPatterns = catObj.patterns.sort((a, b) => b.length - a.length);
            for (const pattern of sortedPatterns) {
                if (normalizedQuery.includes(pattern)) {
                    detectedCategory = catObj.key;
                    break;
                }
            }
            if (detectedCategory) break;
        }

        console.log('üè∑Ô∏è Detected category:', detectedCategory);

        // ‚úÖ NEW: WH QUESTION HANDLER (RULE-1)
        const WH_WORDS = [
            { key: 'what', patterns: ['what is', 'what are', 'what'] },
            { key: 'why', patterns: ['why is', 'why are', 'why'] },
            { key: 'where', patterns: ['where is', 'where are', 'where'] },
            { key: 'when', patterns: ['when is', 'when are', 'when'] },
            { key: 'which', patterns: ['which is', 'which are', 'which'] },
            { key: 'how', patterns: ['how is', 'how are', 'how does', 'how'] }
        ];

        let detectedWhWord = null;
        
        // Check for WH words
        for (const whObj of WH_WORDS) {
            const sortedPatterns = whObj.patterns.sort((a, b) => b.length - a.length);
            for (const pattern of sortedPatterns) {
                if (normalizedQuery.includes(pattern)) {
                    detectedWhWord = whObj.key;
                    break;
                }
            }
            if (detectedWhWord) break;
        }

        console.log('‚ùì Detected WH word:', detectedWhWord);

        // ‚úÖ RULE-1: If WH word + Category detected, answer the WH question
        if (detectedWhWord && detectedCategory) {
            console.log('‚úÖ RULE-1: WH Question + Category detected');
            console.log(`   - WH: ${detectedWhWord}`);
            console.log(`   - Category: ${detectedCategory}`);
            
            // Clear input
            inputElement.value = '';
            
            // Show loading
            showLoadingMessage(`Finding ${detectedWhWord} about ${CATEGORIES[detectedCategory] || detectedCategory}...`);
            
            // Answer the WH question
            setTimeout(() => answerWhQuestion(detectedWhWord, detectedCategory), 500);
            return;
        }

        // ‚úÖ NEW: GENERAL DAY-TO-DAY QUERIES HANDLER
        const generalResponses = handleGeneralQuery(normalizedQuery);
        if (generalResponses) {
            inputElement.value = '';
            showGeneralResponse(generalResponses);
            return;
        }

        // Test type detection - IMPROVED ORDER (check specific patterns first)
        
        const TEST_TYPES = {
            mcq: ['mcq', 'multiple choice', 'multiple-choice', 'mcqs'],
            truefalse: ['true false', 'truefalse', 'true/false', 'true or false'],
            fillblanks: ['fill in blank', 'fill in blanks', 'fill blank', 'fill blanks', 'fill in the blank', 'fill in the blanks', 'fillinblank'],
            matching: ['matching', 'matches', 'match'],
            arrange: ['arrangement', 'arrange word', 'arrange words', 'arrange']
        };

        let detectedTestType = null;
        // Check in priority order (more specific first)
        for (const [key, patterns] of Object.entries(TEST_TYPES)) {
            const sortedPatterns = patterns.sort((a, b) => b.length - a.length);
            for (const pattern of sortedPatterns) {
                if (normalizedQuery.includes(pattern)) {
                    detectedTestType = key;
                    break;
                }
            }
            if (detectedTestType) break;
        }

        console.log('üßæ Detected test type:', detectedTestType);

        // Clear input
        inputElement.value = '';

        // RULE K: Category name only (no test type, no number) - Show concept & example
if (detectedCategory && !detectedTestType) {
    console.log('‚úÖ RULE K: Showing concept for category only (from prompt)');
    showLoadingMessage('Loading concept & example...');
    setTimeout(() => showConceptContent(detectedCategory, true), 500);  // true = from prompt
    return;
}
        // ========== MCQ RULES ==========
        if (detectedTestType === 'mcq') {
            if (extractedNumber) {
                if (detectedCategory) {
                    // RULE B: Direct start with category
                    const pool = getCategoryQuestionPool(detectedCategory, 'mcq_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No MCQ questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(extractedNumber, pool.length);
                    if (extractedNumber > pool.length) {
                        alert(`‚ö†Ô∏è Only ${pool.length} questions available. Starting test with ${pool.length} questions.`);
                    }
                    showLoadingMessage('Loading your MCQ test...');
                    setTimeout(() => startTestWithCategory('mcq', detectedCategory, count), 500);
                } else {
                    // RULE A: Show category selection with typewriting view
                    showNumberBasedTestSelection('mcq', extractedNumber);
                }
            } else {
                // No number provided - Use default (5 questions)
                const defaultCount = 5;
                if (detectedCategory) {
                    const pool = getCategoryQuestionPool(detectedCategory, 'mcq_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No MCQ questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(defaultCount, pool.length);
                    showLoadingMessage('Loading your MCQ test...');
                    setTimeout(() => startTestWithCategory('mcq', detectedCategory, count), 500);
                } else {
                    showNumberBasedTestSelection('mcq', defaultCount);
                }
            }
            return;
        }

        // ========== TRUE/FALSE RULES ==========
        if (detectedTestType === 'truefalse') {
            if (extractedNumber) {
                if (detectedCategory) {
                    // RULE D: Direct start with category
                    const pool = getCategoryQuestionPool(detectedCategory, 'truefalse_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No True/False questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(extractedNumber, pool.length);
                    if (extractedNumber > pool.length) {
                        alert(`‚ö†Ô∏è Only ${pool.length} questions available. Starting test with ${pool.length} questions.`);
                    }
                    showLoadingMessage('Loading your True/False test...');
                    setTimeout(() => startTestWithCategory('truefalse', detectedCategory, count), 500);
                } else {
                    // RULE C: Show category selection with typewriting view
                    showNumberBasedTestSelection('truefalse', extractedNumber);
                }
            } else {
                // No number provided - Use default (5 questions)
                const defaultCount = 5;
                if (detectedCategory) {
                    const pool = getCategoryQuestionPool(detectedCategory, 'truefalse_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No True/False questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(defaultCount, pool.length);
                    showLoadingMessage('Loading your True/False test...');
                    setTimeout(() => startTestWithCategory('truefalse', detectedCategory, count), 500);
                } else {
                    showNumberBasedTestSelection('truefalse', defaultCount);
                }
            }
            return;
        }

        // ========== FILL BLANKS RULES ==========
        if (detectedTestType === 'fillblanks') {
            if (extractedNumber) {
                if (detectedCategory) {
                    // RULE F: Direct start with category
                    const pool = getCategoryQuestionPool(detectedCategory, 'fillblank_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Fill in the Blanks questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(extractedNumber, pool.length);
                    if (extractedNumber > pool.length) {
                        alert(`‚ö†Ô∏è Only ${pool.length} questions available. Starting test with ${pool.length} questions.`);
                    }
                    showLoadingMessage('Loading your Fill in the Blanks test...');
                    setTimeout(() => startTestWithCategory('fillblanks', detectedCategory, count), 500);
                } else {
                    // RULE E: Show category selection with typewriting view
                    showNumberBasedTestSelection('fillblanks', extractedNumber);
                }
            } else {
                // No number provided - Use default (5 questions)
                const defaultCount = 5;
                if (detectedCategory) {
                    const pool = getCategoryQuestionPool(detectedCategory, 'fillblank_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Fill in the Blanks questions available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(defaultCount, pool.length);
                    showLoadingMessage('Loading your Fill in the Blanks test...');
                    setTimeout(() => startTestWithCategory('fillblanks', detectedCategory, count), 500);
                } else {
                    showNumberBasedTestSelection('fillblanks', defaultCount);
                }
            }
            return;
        }

        // ========== MATCHING RULES ==========
        if (detectedTestType === 'matching') {
            if (extractedNumber) {
                // RULE G: Number provided - show category selection
                if (detectedCategory) {
                    // RULE H: Direct start with category and number
                    const pool = getCategoryQuestionPool(detectedCategory, 'matching_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Matching exercises available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(extractedNumber, pool.length);
                    if (extractedNumber > pool.length) {
                        alert(`‚ö†Ô∏è Only ${pool.length} exercises available. Starting with ${pool.length} exercises.`);
                    }
                    showLoadingMessage('Loading your Matching exercises...');
                    setTimeout(() => startTestWithCategory('matching', detectedCategory, count), 500);
                } else {
                    // RULE G: Show category selection
                    showNumberBasedTestSelection('matching', extractedNumber);
                }
            } else {
                // No number - default behavior (all exercises)
                if (detectedCategory) {
                    const pool = getCategoryQuestionPool(detectedCategory, 'matching_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Matching exercises available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    showLoadingMessage('Loading your Matching exercises...');
                    setTimeout(() => startTestWithCategory('matching', detectedCategory, pool.length), 500);
                } else {
                    showNumberBasedTestSelection('matching', 1);
                }
            }
            return;
        }

        // ========== ARRANGE/WORDS RULES ==========
        if (detectedTestType === 'arrange') {
            if (extractedNumber) {
                // RULE I: Number provided - show category selection
                if (detectedCategory) {
                    // RULE J: Direct start with category and number
                    const pool = getCategoryQuestionPool(detectedCategory, 'word_arrangement_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Word Arrangement exercises available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    const count = Math.min(extractedNumber, pool.length);
                    if (extractedNumber > pool.length) {
                        alert(`‚ö†Ô∏è Only ${pool.length} exercises available. Starting with ${pool.length} exercises.`);
                    }
                    showLoadingMessage('Loading your Word Arrangement exercises...');
                    setTimeout(() => startTestWithCategory('arrange', detectedCategory, count), 500);
                } else {
                    // RULE I: Show category selection
                    showNumberBasedTestSelection('arrange', extractedNumber);
                }
            } else {
                // No number - default behavior (all exercises)
                if (detectedCategory) {
                    const pool = getCategoryQuestionPool(detectedCategory, 'word_arrangement_pool');
                    if (!pool || pool.length === 0) {
                        showErrorMessage(`No Word Arrangement exercises available in ${CATEGORIES?.[detectedCategory] || detectedCategory}.`);
                        return;
                    }
                    showLoadingMessage('Loading your Word Arrangement exercises...');
                    setTimeout(() => startTestWithCategory('arrange', detectedCategory, pool.length), 500);
                } else {
                    showNumberBasedTestSelection('arrange', 1);
                }
            }
            return;
        }

        // RULE M: If no match, search on Google
        const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}+BNSS`;
        window.open(googleSearchUrl, '_blank');
        showTestMessage('üîç Searching on Google...');

    } catch (error) {
        console.error('‚ùå Error in sendQuery:', error);
        alert('An unexpected error occurred while processing your query.');
    }
}

// ‚úÖ NEW FUNCTION: Answer WH Questions
function answerWhQuestion(whWord, category) {
    if (!assistantQAData || !assistantQAData.section1) {
        console.error('‚ùå assistantQAData not loaded');
        showErrorMessage('Database not loaded. Please refresh the page.');
        return;
    }
    
    console.log('üîç Searching for WH answer:', { whWord, category });
    
    let content = null;
    
    // Search in bare_act
    if (category === 'bare_act' && assistantQAData.section1.bare_act) {
        if (assistantQAData.section1.bare_act[whWord]) {
            content = assistantQAData.section1.bare_act[whWord].content;
        }
    }
    
    // Search in subsections (subsection_1, subsection_2, subsection_3)
    if (!content && assistantQAData.section1.subsections && assistantQAData.section1.subsections[category]) {
        const subsection = assistantQAData.section1.subsections[category];
        if (subsection[whWord]) {
            content = subsection[whWord].content;
        }
    }
    
    // Search in special categories (explanation_to_subsection_2, footnote)
    if (!content && assistantQAData.section1[category]) {
        const section = assistantQAData.section1[category];
        if (section[whWord]) {
            content = section[whWord].content;
        }
    }
    
    // If content found
    if (content && content.length > 0) {
        console.log('‚úÖ WH answer found');
        const answerData = content[0];
       displayAnswer(answerData.text, answerData.audioUrl, true);
    } else {
        // No answer found
        const categoryLabel = CATEGORIES[category] || category;
        const whLabel = whWord.charAt(0).toUpperCase() + whWord.slice(1);
        
        showErrorMessage(`No "${whLabel}" answer available for ${categoryLabel}.`);
        console.log('‚ùå No WH answer found for:', { whWord, category });
    }
}

// Helper function to show loading message
function showLoadingMessage(message) {
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #667eea;">
            <div style="font-size: 50px; margin-bottom: 20px;">‚è≥</div>
            <h3>${message}</h3>
        </div>
    `;
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}

// Helper function to show error message
function showErrorMessage(message) {
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = `
        <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px; margin: 15px;">
            <p style="color: #856404; font-size: 15px; margin: 0;">
                ‚ùå ${message}
            </p>
        </div>
    `;
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}




function showConceptForCategory(category) {
    closeDropdown();
    
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #667eea;"><h3>Loading concept content...</h3></div>';
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    
    const content = findConceptContent(category);
    
    if (!content) {
        const categoryLabel = CONCEPT_CATEGORIES[category] || CATEGORIES[category] || category;
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px; margin: 0;">
                <p style="color: #856404; font-size: 15px; margin: 0;">
                    ‚ùå No concept & example content available for ${categoryLabel}.
                </p>
            </div>
        `;
        return;
    }
    
    displayAnswer(content.text, content.audioUrl);
}

function showCategoryExplanation(category) {
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #667eea;"><h3>Loading content...</h3></div>';
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    
    // Find the explanation content in your JSON
    const content = findCategoryExplanation(category);
    
    if (!content) {
        const categoryLabel = CATEGORIES[category] || category;
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px; margin: 0;">
                <p style="color: #856404; font-size: 15px; margin: 0;">
                    ‚ùå No explanation content available for ${categoryLabel}.
                </p>
            </div>
        `;
        return;
    }
    
    displayAnswer(content.text, content.audioUrl);
}

function findCategoryExplanation(category) {
    if (!assistantQAData || !assistantQAData.section1) {
        console.error('‚ùå assistantQAData not loaded');
        return null;
    }
    
    console.log('üîç Searching for explanation:', category);
    
    // Check in subsections first
    if (assistantQAData.section1.subsections && assistantQAData.section1.subsections[category]) {
        const subsection = assistantQAData.section1.subsections[category];
        if (subsection.explanation && subsection.explanation.content && subsection.explanation.content.length > 0) {
            console.log('‚úÖ Found explanation in subsection');
            return subsection.explanation.content[0];
        }
    }
    
    // Check direct properties
    if (assistantQAData.section1[category]) {
        const section = assistantQAData.section1[category];
        if (section.explanation && section.explanation.content && section.explanation.content.length > 0) {
            console.log('‚úÖ Found explanation at section level');
            return section.explanation.content[0];
        }
    }
    
    console.error('‚ùå No explanation found for', category);
    return null;
}

function showNumberBasedTestSelection(testType, count) {
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    
    console.log('üîç showNumberBasedTestSelection called:', { testType, count });
    
    // ‚úÖ COMPLETE test labels for ALL types
    const testLabels = {
        'mcq': 'MCQ',
        'truefalse': 'True/False',
        'fillblanks': 'Fill in the Blanks',
        'matching': 'Matching',
        'arrange': 'Word Arrangement'
    };
    
    const testLabel = testLabels[testType] || testType;
    
    console.log('‚úÖ Test label resolved:', testLabel); // Debug log
    
    // Different wording for exercises vs questions
    const isExercise = (testType === 'matching' || testType === 'arrange');
    const itemType = isExercise ? 'Exercise' : 'Question';
    const itemTypePlural = isExercise ? 'Exercises' : 'Questions';
    
    const displayText = count > 1 ? itemTypePlural : itemType;
    
    console.log('‚úÖ Display text:', displayText); // Debug log
    
    // TYPEWRITING STYLE - Clean white background with blue category buttons
    let html = `
        <div style="background: white; border-radius: 12px; padding: 25px; margin: 15px; box-shadow: 0 3px 15px rgba(0,0,0,0.1);">
            <h3 style="color: #667eea; text-align: center; margin-bottom: 20px; font-size: 20px;">
                üìö Select Category for ${count} ${testLabel} ${displayText}
            </h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
    `;
    
    const poolMap = {
        'mcq': 'mcq_pool',
        'truefalse': 'truefalse_pool',
        'fillblanks': 'fillblank_pool',
        'matching': 'matching_pool',
        'arrange': 'word_arrangement_pool'
    };
    
    const poolName = poolMap[testType];
    console.log('üîç Pool name:', poolName);
    
    let hasCategories = false;
    
    for (const [key, label] of Object.entries(CATEGORIES)) {
        const pool = getCategoryQuestionPool(key, poolName);
        const availableCount = pool ? pool.length : 0;
        
        console.log(`üìä ${key}: ${availableCount} items in ${poolName}`);
        
        // Show button if enough items are available
        if (availableCount >= count) {
            hasCategories = true;
            html += `
                <button onclick="startTestWithCategory('${testType}', '${key}', ${count})"
                        style="width: 100%;
                               background: linear-gradient(135deg, #667eea, #764ba2); 
                               border: none; 
                               color: white; 
                               padding: 15px; 
                               border-radius: 10px; 
                               font-size: 15px; 
                               font-weight: 700; 
                               cursor: pointer; 
                               transition: all 0.3s ease;
                               text-align: left;
                               box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(102, 126, 234, 0.5)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(102, 126, 234, 0.3)';">
                    ${label}
                    <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">
                        ‚úì ${availableCount} ${isExercise ? 'exercises' : 'questions'} available
                    </div>
                </button>
            `;
        }
    }
    
    if (!hasCategories) {
        html += `
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px;">
                <p style="color: #856404; font-size: 15px; margin: 0;">
                    ‚ùå No categories have ${count} ${displayText.toLowerCase()} available for ${testLabel}.
                </p>
            </div>
        `;
    }
    
    html += `
            </div>
            <button onclick="resetTest()"
                    style="width: 100%;
                           background: #f44336; 
                           color: white; 
                           border: none; 
                           padding: 12px; 
                           border-radius: 25px; 
                           font-size: 14px; 
                           font-weight: 600; 
                           cursor: pointer;
                           margin-top: 15px;
                           transition: all 0.3s ease;"
                    onmouseover="this.style.background='#d32f2f'"
                    onmouseout="this.style.background='#f44336'">
                ‚úï Cancel
            </button>
        </div>
    `;
    
    container.innerHTML = html;
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}


// DISPLAY FUNCTIONS
function showTestMessage(message) {
    const container = document.getElementById('responseContainer');
    container.innerHTML = `
        <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px; margin: 0;">
            <p style="color: #856404; font-size: 15px; margin: 0;">${message}</p>
        </div>
    `;
}


function displayAnswer(answer, audioUrl, isWhQuestion = false, isConceptFromPrompt = false) {
    const container = document.getElementById('responseContainer');
    
    const hasValidAudio = audioUrl && 
                          audioUrl.trim() !== '' && 
                          (audioUrl.startsWith('http://') || audioUrl.startsWith('https://') || audioUrl.startsWith('blob:'));
    
    let audioControlHTML = '';
    if (hasValidAudio) {
        audioControlHTML = `
            <div style="margin-top: 15px; text-align: center;">
                <button id="playStopBtn" onclick="togglePlayStop()" class="play-stop-btn" style="width: auto; min-width: 180px;">
                    <span style="font-size: 18px;">‚ñ∂Ô∏è</span> Play Audio
                </button>
            </div>
        `;
    }
    
    const containsHTML = /<br>|<\/br>|<p>|<\/p>|<div>|<\/div>|<ul>|<\/ul>|<li>|<\/li>|<strong>|<\/strong>|<b>|<\/b>|<i>|<\/i>/i.test(answer);
    
    // Create unique ID for this answer
    const answerId = 'answer-text-' + Date.now();
    
    // Get category mermaid graph if displaying concept content
    let categoryImageHTML = '';
    if (currentTest && currentTest.displayingCategory) {
        const mermaidCode = getMermaidForCategory(currentTest.displayingCategory);
        if (mermaidCode) {
            const mermaidId = 'mermaid-' + Date.now();
            categoryImageHTML = `
                <div style="margin-bottom: 20px; text-align: center; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <div class="mermaid" id="${mermaidId}">${mermaidCode}</div>
                </div>
            `;
        }
    }
    
    container.innerHTML = `
        <div style="background: white; border-radius: 10px; padding: 20px; margin: 0; box-shadow: 0 3 15px rgba(0,0,0,0.1);">
            ${categoryImageHTML}
            <div style="color: #667eea; font-weight: bold; font-size: 16px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
                üìù Answer:
            </div>
            <div id="typewriterText" style="color: #000; font-size: 15px; line-height: 1.6; white-space: pre-wrap; text-align: justify;">
            </div>
            
            <!-- Hidden div for translation with full text -->
            <div id="${answerId}" style="display: none;">${answer.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '')}</div>
            
            <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; padding: 10px 0; border-top: 1px solid #e0e0e0;">
                <button onclick="translateTextInNewTab('${answerId}', 'or')" style="background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; border: none; padding: 10px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3); white-space: nowrap;">
                    üåê ‡¨ì‡¨°‡¨º‡¨ø‡¨Ü (Odia)
                </button>
                <button onclick="translateTextInNewTab('${answerId}', 'bn')" style="background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; border: none; padding: 10px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(78, 205, 196, 0.3); white-space: nowrap;">
                    üåê ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)
                </button>
                <button onclick="translateTextInNewTab('${answerId}', 'hi')" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); white-space: nowrap;">
                    üåê ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)
                </button>
            </div>
            
            ${audioControlHTML}
        </div>
    `;
    
    window.currentAudioUrl = audioUrl;

    // Only autoplay if enabled AND it's from a prompt (WH question or concept from prompt)
    if (autoplayEnabled && hasValidAudio && audioUrl && (isWhQuestion || isConceptFromPrompt)) {
        playAudio(audioUrl);
    }
    
    const textElement = document.getElementById('typewriterText');
    
    // ‚úÖ FIXED: Always use typewriter for prompts, strip HTML if needed
    if (isWhQuestion || isConceptFromPrompt) {
        // Strip HTML tags for typewriter display
        const plainText = answer.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '').trim();
        typewriterEffect(plainText, textElement, isConceptFromPrompt ? 90 : 20);
    } else {
        // For non-WH questions (manual category selection), display immediately
        if (containsHTML) {
            textElement.innerHTML = answer;
        } else {
            textElement.textContent = answer;
        }
    }
    
// Reinitialize mermaid for dynamically added diagrams
if (typeof mermaid !== 'undefined') {
    setTimeout(() => {
        mermaid.init(undefined, document.querySelectorAll('.mermaid'));
    }, 100);
}
}

// ‚úÖ Typewriter function remains the same
function typewriterEffect(text, element, speed = 20) {
    let index = 0;
    
    element.textContent = ''; // Clear existing content
    
    function type() {
        if (index < text.length) {
            element.textContent += text.charAt(index);
            index++;
            setTimeout(type, speed);
        }
    }
    
    type();
}

// QUICK ACTION FUNCTIONS
function quickAction(action) {
    if (action === 'concept') {
        showConceptCategories();
        return;
    }
    
    selectedTestType = action;
    showInlineCategories(action);
}

function showConceptCategories() {
    document.querySelectorAll('.category-dropdown').forEach(dd => dd.remove());
    
    const buttons = document.querySelectorAll('.action-btn');
    let targetButton = null;
    
    buttons.forEach(btn => {
        if (btn.textContent.includes('Concept & Example')) {
            targetButton = btn;
        }
    });
    
    if (!targetButton) return;
    
    const dropdown = document.createElement('div');
    dropdown.className = 'category-dropdown';
    dropdown.style.cssText = `
        position: fixed;
        background: white;
        border: 3px solid #667eea;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 300px;
        max-width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        padding: 15px;
    `;
    
    let html = `
        <div style="color: #667eea; font-weight: 900; font-size: 14px; margin-bottom: 12px; text-align: center; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
            üí° Select Category for Concept & Example
        </div>
    `;
    
    for (const [key, label] of Object.entries(CONCEPT_CATEGORIES)) {
        html += `
            <button onclick="showConceptContent('${key}')" 
                    style="width: 100%;
                           background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                           border: 2px solid #dee2e6; 
                           color: #333; 
                           padding: 12px; 
                           border-radius: 8px; 
                           font-size: 13px; 
                           font-weight: 700; 
                           cursor: pointer; 
                           transition: all 0.3s ease;
                           text-align: left;
                           margin-bottom: 8px;"
                    onmouseover="this.style.background='linear-gradient(135deg, #667eea, #764ba2)'; this.style.color='white'; this.style.borderColor='#667eea'; this.style.transform='translateX(3px)';"
                    onmouseout="this.style.background='linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)'; this.style.color='#333'; this.style.borderColor='#dee2e6'; this.style.transform='translateX(0)';">
                ${label}
            </button>
        `;
    }
    
    html += `
        <button onclick="closeDropdown()" 
                style="width: 100%;
                       background: #f44336; 
                       color: white; 
                       border: none; 
                       padding: 10px; 
                       border-radius: 20px; 
                       font-size: 12px; 
                       font-weight: 600; 
                       cursor: pointer;
                       margin-top: 8px;
                       transition: all 0.3s ease;"
                onmouseover="this.style.background='#d32f2f'"
                onmouseout="this.style.background='#f44336'">
            ‚úï Close
        </button>
    `;
    
    dropdown.innerHTML = html;
    
    const rect = targetButton.getBoundingClientRect();
    dropdown.style.left = `${Math.min(rect.left, window.innerWidth - 320)}px`;
    dropdown.style.top = `${rect.bottom + 5}px`;
    
    document.body.appendChild(dropdown);
    
    const dropdownRect = dropdown.getBoundingClientRect();
    if (dropdownRect.bottom > window.innerHeight) {
        dropdown.style.top = `${rect.top - dropdownRect.height - 5}px`;
    }
    
    setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
    }, 100);
}

function showConceptContent(category, fromPrompt = false) {
    closeDropdown();
    
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #667eea;"><h3>Loading content...</h3></div>';
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    
    const content = findConceptContent(category);
    
    if (!content) {
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-left: 5px solid #ffc107; border-radius: 12px; padding: 20px; margin: 0;">
                <p style="color: #856404; font-size: 15px; margin: 0;">
                    ‚ùå No concept & example content available for ${CONCEPT_CATEGORIES[category]}.
                </p>
            </div>
        `;
        return;
    }
    
    // Store category for image display
    if (!currentTest) currentTest = {};
    currentTest.displayingCategory = category;
    
    // If from prompt: use typewriter + autoplay audio
    // If from button: no typewriter, no autoplay
    if (fromPrompt) {
        displayAnswer(content.text, content.audioUrl, false, true);  // true = isConceptFromPrompt
    } else {
        displayAnswer(content.text, null, false, false);  // null = no audio
    }
}

function findConceptContent(category) {
    if (!assistantQAData || !assistantQAData.section1) {
        console.error('‚ùå assistantQAData not loaded');
        return null;
    }
    
    console.log('üîç Searching for concept content:', category);
    console.log('üìä Full section1 keys:', Object.keys(assistantQAData.section1));
    
    // ‚úÖ Handle bare_act FIRST
    if (category === 'bare_act' && assistantQAData.section1.bare_act) {
        const bareAct = assistantQAData.section1.bare_act;
        
        if (bareAct.concept_with_example && 
            bareAct.concept_with_example.content && 
            bareAct.concept_with_example.content.length > 0) {
            
            console.log('‚úÖ Found concept content in bare_act');
            return bareAct.concept_with_example.content[0];
        }
    }
    
    // ‚úÖ Check subsections FIRST (this is where footnote lives!)
    if (assistantQAData.section1.subsections) {
        console.log('üìä Subsections keys:', Object.keys(assistantQAData.section1.subsections));
        
        // Try direct category match
        if (assistantQAData.section1.subsections[category]) {
            const subsection = assistantQAData.section1.subsections[category];
            
            if (subsection.concept_with_example && 
                subsection.concept_with_example.content && 
                subsection.concept_with_example.content.length > 0) {
                
                console.log('‚úÖ Found concept content in subsections.' + category);
                return subsection.concept_with_example.content[0];
            }
        }
        
        // ‚úÖ Special case: if category is 'footnote', try 'footnote_1'
        if (category === 'footnote' && assistantQAData.section1.subsections.footnote_1) {
            const footnote = assistantQAData.section1.subsections.footnote_1;
            
            if (footnote.concept_with_example && 
                footnote.concept_with_example.content && 
                footnote.concept_with_example.content.length > 0) {
                
                console.log('‚úÖ Found concept content in subsections.footnote_1');
                return footnote.concept_with_example.content[0];
            }
        }
    }
    
    // Special handling for explanation_to_subsection_2 (might be at section1 level)
    if (category === 'explanation_to_subsection_2') {
        // Try section1 level first
        if (assistantQAData.section1.explanation_to_subsection_2) {
            const explanation = assistantQAData.section1.explanation_to_subsection_2;
            
            if (explanation.concept_with_example && 
                explanation.concept_with_example.content && 
                explanation.concept_with_example.content.length > 0) {
                
                console.log('‚úÖ Found concept content in explanation_to_subsection_2');
                return explanation.concept_with_example.content[0];
            }
        }
        
        // Try subsections level
        if (assistantQAData.section1.subsections && 
            assistantQAData.section1.subsections.explanation_to_subsection_2) {
            
            const explanation = assistantQAData.section1.subsections.explanation_to_subsection_2;
            
            if (explanation.concept_with_example && 
                explanation.concept_with_example.content && 
                explanation.concept_with_example.content.length > 0) {
                
                console.log('‚úÖ Found concept content in subsections.explanation_to_subsection_2');
                return explanation.concept_with_example.content[0];
            }
        }
    }
    
    // Generic fallback check at section1 level
    if (assistantQAData.section1[category]) {
        const section = assistantQAData.section1[category];
        
        if (section.concept_with_example && 
            section.concept_with_example.content && 
            section.concept_with_example.content.length > 0) {
            
            console.log('‚úÖ Found concept content at section1.' + category);
            return section.concept_with_example.content[0];
        }
    }
    
    console.error('‚ùå No concept content found for', category);
    console.log('üìä Available section1 properties:', Object.keys(assistantQAData.section1));
    if (assistantQAData.section1.subsections) {
        console.log('üìä Available subsections:', Object.keys(assistantQAData.section1.subsections));
    }
    return null;
} 

function showInlineCategories(testType) {
    document.querySelectorAll('.category-dropdown').forEach(dd => dd.remove());
    
    const buttons = document.querySelectorAll('.action-btn');
    let targetButton = null;
    
    const testMap = {
        'mcq': 'MCQ Test',
        'truefalse': 'True/False',
        'fillblanks': 'Fill Blanks',
        'matching': 'Matching',
        'arrange': 'Arrange Words'
    };
    
    buttons.forEach(btn => {
        if (btn.textContent.includes(testMap[testType])) {
            targetButton = btn;
        }
    });
    
    if (!targetButton) return;
    
    const dropdown = document.createElement('div');
    dropdown.className = 'category-dropdown';
    dropdown.style.cssText = `
        position: fixed;
        background: white;
        border: 3px solid #667eea;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 300px;
        max-width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        padding: 15px;
    `;
    
    let html = `
        <div style="color: #667eea; font-weight: 900; font-size: 14px; margin-bottom: 12px; text-align: center; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
            üìö Select Category & Questions
        </div>
    `;
    
    for (const [key, label] of Object.entries(CATEGORIES)) {
        const poolMap = {
            'mcq': 'mcq_pool',
            'truefalse': 'truefalse_pool',
            'fillblanks': 'fillblank_pool',
            'matching': 'matching_pool',
            'arrange': 'word_arrangement_pool'
        };
        
        const poolName = poolMap[testType];
        const pool = getCategoryQuestionPool(key, poolName);
        const availableCount = pool ? pool.length : 0;
        
        if (availableCount === 0) {
            html += `
                <div style="background: #f5f5f5; 
                           border: 2px solid #e0e0e0; 
                           color: #999; 
                           padding: 12px; 
                           border-radius: 8px; 
                           font-size: 12px; 
                           text-align: left;
                           margin-bottom: 8px;
                           opacity: 0.6;">
                    ${label}
                    <div style="font-size: 10px; color: #f44336; margin-top: 4px;">
                        ‚ùå No questions available
                    </div>
                </div>
            `;
        } else {
            if (testType === 'matching' || testType === 'arrange') {
                html += `
                    <button onclick="startTestDirectly('${key}', '${testType}', 1)" 
                            style="width: 100%;
                                   background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                                   border: 2px solid #dee2e6; 
                                   color: #333; 
                                   padding: 12px; 
                                   border-radius: 8px; 
                                   font-size: 13px; 
                                   font-weight: 700; 
                                   cursor: pointer; 
                                   transition: all 0.3s ease;
                                   text-align: left;
                                   margin-bottom: 8px;"
                            onmouseover="this.style.background='linear-gradient(135deg, #667eea, #764ba2)'; this.style.color='white'; this.style.borderColor='#667eea'; this.style.transform='translateX(3px)';"
                            onmouseout="this.style.background='linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)'; this.style.color='#333'; this.style.borderColor='#dee2e6'; this.style.transform='translateX(0)';">
                        ${label}
                        <div style="font-size: 10px; color: #4CAF50; margin-top: 4px;">
                            ‚úì ${availableCount} exercise${availableCount > 1 ? 's' : ''} available
                        </div>
                    </button>
                `;
            } else {
                html += `
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                               border: 2px solid #dee2e6; 
                               border-radius: 8px; 
                               padding: 12px;
                               margin-bottom: 8px;">
                        <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 8px;">
                            ${label}
                        </div>
                        <div style="font-size: 10px; color: #4CAF50; margin-bottom: 10px;">
                            ‚úì ${availableCount} questions available
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <select id="count-${key}" 
                                   style="flex: 1;
                                          padding: 10px; 
                                          border: 2px solid #667eea; 
                                          border-radius: 8px; 
                                          font-size: 16px; 
                                          text-align: center; 
                                          font-weight: bold;
                                          background: white;
                                          color: #333;
                                          cursor: pointer;
                                          box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);">
                `;
                
                for (let i = 1; i <= availableCount; i++) {
                    const selected = i === Math.min(5, availableCount) ? 'selected' : '';
                    html += `<option value="${i}" ${selected}>${i} Question${i > 1 ? 's' : ''}</option>`;
                }
                
                html += `
                            </select>
                            <button onclick="startTestWithCount('${key}', '${testType}', ${availableCount})"
                                    style="background: linear-gradient(135deg, #4CAF50, #45a049); 
                                           color: white; 
                                           border: none; 
                                           padding: 10px 20px; 
                                           border-radius: 8px; 
                                           font-size: 14px; 
                                           font-weight: 700; 
                                           cursor: pointer;
                                           white-space: nowrap;
                                           box-shadow: 0 3px 10px rgba(76, 175, 80, 0.4);
                                           transition: all 0.3s ease;"
                                    onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(76, 175, 80, 0.6)'"
                                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 3px 10px rgba(76, 175, 80, 0.4)'">
                                Start ‚Üí
                            </button>
                        </div>
                    </div>
                `;
            }
        }
    }
    
    html += `
        <button onclick="closeDropdown()" 
                style="width: 100%;
                       background: #f44336; 
                       color: white; 
                       border: none; 
                       padding: 10px; 
                       border-radius: 20px; 
                       font-size: 12px; 
                       font-weight: 600; 
                       cursor: pointer;
                       margin-top: 8px;
                       transition: all 0.3s ease;"
                onmouseover="this.style.background='#d32f2f'"
                onmouseout="this.style.background='#f44336'">
            ‚úï Close
        </button>
    `;
    
    dropdown.innerHTML = html;
    
    const rect = targetButton.getBoundingClientRect();
    dropdown.style.left = `${Math.min(rect.left, window.innerWidth - 320)}px`;
    dropdown.style.top = `${rect.bottom + 5}px`;
    
    document.body.appendChild(dropdown);
    const dropdownRect = dropdown.getBoundingClientRect();
    if (dropdownRect.bottom > window.innerHeight) {
        dropdown.style.top = `${rect.top - dropdownRect.height - 5}px`;
    }
    
    setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
    }, 100);
}

function handleOutsideClick(e) {
    const dropdown = document.querySelector('.category-dropdown');
    if (dropdown && !dropdown.contains(e.target) && !e.target.classList.contains('action-btn')) {
        closeDropdown();
    }
}

function closeDropdown() {
    document.querySelectorAll('.category-dropdown').forEach(dd => dd.remove());
    document.removeEventListener('click', handleOutsideClick);
}

function startTestWithCount(category, testType, maxAllowed) {
    const input = document.getElementById(`count-${category}`);
    const count = parseInt(input.value) || 5;
    
    if (count < 1 || count > maxAllowed) {
        alert(`‚ö†Ô∏è Please enter a number between 1 and ${maxAllowed}`);
        return;
    }
    
    console.log('Starting test:', { category, testType, count });
    
    closeDropdown();
    
    setTimeout(() => {
        startTestWithCategory(testType, category, count);
    }, 100);
}

function startTestDirectly(category, testType, count) {
    console.log('Direct start:', { category, testType, count });
    
    closeDropdown();
    
    setTimeout(() => {
        startTestWithCategory(testType, category, count);
    }, 100);
}

// ‚úÖ FUNCTION 1: GENERAL QUERY HANDLER WITH HINDI SUPPORT (ROMANIZED)
function handleGeneralQuery(query) {
    // Greetings (English + Romanized Hindi)
    const greetings = ['hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening', 'namaste', 'namaskar', 'suprabhat', 'shubh sandhya', 'pranam'];
    for (const greeting of greetings) {
        if (query.includes(greeting)) {
            return {
                text: `üôè Hello! Welcome to Odisha e-Guru Learning Platform.\n\nI'm your BNSS Section-1 assistant. I can help you with:\n\nüìö Concepts & Examples\nüìù MCQ Tests\n‚úì‚úó True/False Tests\nüìã Fill in the Blanks\nüîó Matching Exercises\nüî§ Word Arrangement\n\nHow can I assist you today?`,
                type: 'greeting'
            };
        }
    }
    
    // Help queries (English + Romanized Hindi)
    const helpPatterns = ['help', 'what can you do', 'how to use', 'guide me', 'assist me', 'can you help', 'madad', 'sahayata', 'kaise use kare', 'use', 'meri madad karo', 'kaise upyog kare'];
    for (const pattern of helpPatterns) {
        if (query.includes(pattern)) {
            return {
                text: `üí° Here's how to use me:\n\n1Ô∏è‚É£ Ask for concepts: "Show me concept of Subsection-1"\n2Ô∏è‚É£ Take tests: "Give me 5 MCQ questions on Bare Act"\n3Ô∏è‚É£ Ask WH questions: "What is Subsection-2?"\n\nAvailable categories:\nüìú Bare Section\nüìã Subsection-1, 2, 3\nüí° Explanation to Subsection-2\nüìù Footnote\n\nJust type your question!`,
                type: 'help'
            };
        }
    }
    
    // Thank you (English + Romanized Hindi)
    const thankPatterns = ['thank you', 'thanks', 'thank u', 'thnx', 'appreciate', 'dhanyavaad', 'dhanyavad', 'shukriya', 'thanku'];
    for (const pattern of thankPatterns) {
        if (query.includes(pattern)) {
            return {
                text: `üòä You're welcome! Happy learning!\n\nFeel free to ask me anything about BNSS Section-1.`,
                type: 'thanks'
            };
        }
    }
    
    // About bot (English + Romanized Hindi)
    const aboutPatterns = ['who are you', 'what are you', 'your name', 'introduce yourself', 'tum kaun ho', 'kaun', 'aap kaun hai', 'aap kaun hain', 'apna parichay do', 'tumhara naam'];
    for (const pattern of aboutPatterns) {
        if (query.includes(pattern)) {
            return {
                text: `ü§ñ I'm Odisha e-Guru Assistant!\n\nI'm an AI-powered learning assistant designed to help you master BNSS Section-1.\n\nI can:\n‚úÖ Explain concepts with examples\n‚úÖ Generate practice tests\n‚úÖ Answer your questions\n‚úÖ Provide translations in Odia, Hindi, Bengali\n\nBuilt with ‚ù§Ô∏è for learners in Odisha.`,
                type: 'about'
            };
        }
    }
    
    // How are you (English + Romanized Hindi)
    const wellbeingPatterns = ['how are you', 'how r u', 'how do you do', 'whats up', "what's up", 'kaise ho', 'kaisi ho', 'kya haal hai', 'sab theek', 'kaise hain'];
    for (const pattern of wellbeingPatterns) {
        if (query.includes(pattern)) {
            return {
                text: `üòä I'm doing great, thank you for asking!\n\nI'm here and ready to help you learn BNSS Section-1.\n\nWhat would you like to explore today?`,
                type: 'wellbeing'
            };
        }
    }
    
    // Bye/Goodbye (English + Romanized Hindi)
    const byePatterns = ['bye', 'goodbye', 'see you', 'see ya', 'gotta go', 'take care', 'alvida', 'phir milenge', 'chalta hu', 'chalta hoon', 'jaata hu'];
    for (const pattern of byePatterns) {
        if (query.includes(pattern)) {
            return {
                text: `üëã Goodbye! Keep learning and stay motivated!\n\n"Education is the most powerful weapon which you can use to change the world." - Nelson Mandela\n\nCome back anytime! üìö`,
                type: 'goodbye'
            };
        }
    }
    
    // Jokes (English + Romanized Hindi)
    const jokePatterns = ['tell me a joke', 'joke', 'make me laugh', 'funny', 'joke sunao', 'chutkula', 'chutkula sunao', 'hansao', 'mazak', 'mazaak'];
    for (const pattern of jokePatterns) {
        if (query.includes(pattern)) {
            const jokes = [
                "Why did the law student fail his exam? Because he couldn't pass the bar! üòÑ",
                "Why don't lawyers go to the beach? Because cats keep trying to bury them in the sand! üèñÔ∏èüòÇ",
                "What's a lawyer's favorite drink? Just-ice! ‚öñÔ∏èüòÑ",
                "Why did the judge break up with the lawyer? Too many objections! üíîüòÇ"
            ];
            const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];
            return {
                text: `üòÑ Here's a legal joke for you:\n\n${randomJoke}\n\nNow, back to learning BNSS Section-1! üìö`,
                type: 'joke'
            };
        }
    }
    
    // Motivation (English + Romanized Hindi)
    const motivationPatterns = ['motivate me', 'inspire me', 'motivation', 'feeling low', 'tired', 'demotivated', 'prerna', 'prerana', 'motivation do', 'himmat do', 'utsahit karo', 'thak gaya', 'thak gayi'];
    for (const pattern of motivationPatterns) {
        if (query.includes(pattern)) {
            const quotes = [
                "üåü 'The only way to do great work is to love what you do.' - Steve Jobs",
                "üí™ 'Believe you can and you're halfway there.' - Theodore Roosevelt",
                "üéØ 'Success is not final, failure is not fatal: it is the courage to continue that counts.' - Winston Churchill",
                "üìö 'Education is the passport to the future, for tomorrow belongs to those who prepare for it today.' - Malcolm X"
            ];
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            return {
                text: `${randomQuote}\n\nKeep going! Every question you answer brings you closer to mastery. You've got this! üí™‚ú®`,
                type: 'motivation'
            };
        }
    }
    
    // Time/Date (English + Romanized Hindi)
    const timePatterns = ['date', 'samay', 'time', 'tarikh'];
    for (const pattern of timePatterns) {
        if (query.includes(pattern)) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-IN');
            const dateStr = now.toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            return {
                text: `üïê Current Time: ${timeStr}\nüìÖ Today's Date: ${dateStr}\n\nLet's make the most of today's learning! üìö`,
                type: 'time'
            };
        }
    }
    
    return null; // No general query matched
}

// ‚úÖ FUNCTION 2: DISPLAY GENERAL RESPONSE
function showGeneralResponse(response) {
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    
    const emojis = {
        greeting: 'üëã',
        help: 'üí°',
        thanks: 'üòä',
        about: 'ü§ñ',
        wellbeing: 'üòä',
        goodbye: 'üëã',
        joke: 'üòÑ',
        motivation: 'üåü',
        time: 'üïê'
    };
    
    const emoji = emojis[response.type] || 'üí¨';
    
    container.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 25px; margin: 15px; box-shadow: 0 3px 15px rgba(0,0,0,0.1);">
            <div style="text-align: center; font-size: 50px; margin-bottom: 20px;">${emoji}</div>
            <div id="generalResponseText" style="color: #333; font-size: 15px; line-height: 1.8; white-space: pre-wrap; text-align: justify;"></div>
        </div>
    `;
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    
    // Typewriter effect
    const textElement = document.getElementById('generalResponseText');
    typewriterEffect(response.text, textElement, 30);
}

function startTestWithCategory(testType, category, count) {
    const poolMap = {
        'mcq': 'mcq_pool',
        'truefalse': 'truefalse_pool',
        'fillblanks': 'fillblank_pool',
        'matching': 'matching_pool',
        'arrange': 'word_arrangement_pool'
    };
    
    const poolName = poolMap[testType];
    const pool = getCategoryQuestionPool(category, poolName);
    
    if (!pool || pool.length === 0) {
        alert(`‚ùå No questions available in ${CATEGORIES[category]} for this test type.`);
        return;
    }
    
    if (count > pool.length) {
        alert(`‚ö†Ô∏è Only ${pool.length} questions available in this category. Starting test with ${pool.length} questions.`);
        count = pool.length;
    }
    
    const container = document.getElementById('responseContainer');
    container.classList.add('show');
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #667eea;"><h3>Loading test...</h3></div>';
    
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    
    // ‚úÖ SPECIAL HANDLING for Matching and Word Arrangement
    if (testType === 'matching' || testType === 'arrange') {
        // Store all exercises with navigation support
        currentTest = {
            type: testType,
            category: category,
            allExercises: pool,              // ‚úÖ All exercises
            currentExerciseIndex: 0,         // ‚úÖ Start from first
            data: pool[0],                   // ‚úÖ Current exercise data
            totalMarks: testType === 'matching' ? pool[0].columnA.length : 1,
            totalExercises: pool.length      // ‚úÖ Total count
        };
        userAnswers = {};
        
        // Render appropriate test
        if (testType === 'matching') {
            renderMatchingTest();
        } else {
            renderWordArrangementTest();
        }
        return;
    }
    
    // ‚úÖ REGULAR HANDLING for MCQ, True/False, Fill Blanks
    console.log('üîç BEFORE getUniqueQuestions:', { poolSize: pool.length, count, testType });
    const questions = getUniqueQuestions(pool, count, testType);
    console.log('‚úÖ AFTER getUniqueQuestions:', { questionsCount: questions.length, questions });
    
    if (questions.length === 0) {
        console.error('‚ùå getUniqueQuestions returned empty array!');
        alert('‚ùå Could not load questions. Please try again.');
        return;
    }
    
    currentTest = {
        type: testType,
        category: category,
        questions: questions,
        data: null,
        totalMarks: questions.length
    };
    userAnswers = {};
    
    // Render appropriate test type
    switch(testType) {
        case 'mcq':
            renderMCQTest();
            break;
        case 'truefalse':
            renderTrueFalseTest();
            break;
        case 'fillblanks':
            renderFillBlanksTest();
            break;
        default:
            alert('‚ùå Unknown test type');
    }
}
function getCategoryQuestionPool(category, poolName) {
    if (!assistantQAData) {
        console.error('‚ùå assistantQAData not loaded');
        return [];
    }
    
    console.log('üîç Searching for:', { category, poolName });
    
    // ‚úÖ FIX: Handle bare_act FIRST (before subsections)
    if (category === 'bare_act' && assistantQAData.section1 && assistantQAData.section1.bare_act) {
        if (assistantQAData.section1.bare_act[poolName]) {
            const pool = assistantQAData.section1.bare_act[poolName];
            console.log('‚úÖ Found in section1.bare_act:', pool.length, 'items');
            return pool;
        }
    }
    
    // ‚úÖ Check subsections (for subsection_1, subsection_2, etc.)
    if (assistantQAData.section1 && assistantQAData.section1.subsections) {
        if (assistantQAData.section1.subsections[category]) {
            const subsection = assistantQAData.section1.subsections[category];
            if (subsection[poolName]) {
                const pool = subsection[poolName];
                console.log('‚úÖ Found in section1.subsections:', pool.length, 'items');
                return pool;
            }
        }
    }
    
    // ‚úÖ Check special categories (explanation_to_subsection_2, footnote_1)
    if (assistantQAData.section1 && assistantQAData.section1[category]) {
        const section = assistantQAData.section1[category];
        if (section[poolName]) {
            console.log('‚úÖ Found in section1.' + category + ':', section[poolName].length, 'items');
            return section[poolName];
        }
    }
    
    // ‚úÖ Last resort: Recursive search
    console.log('‚ö†Ô∏è Starting deep recursive search...');
    let foundPool = null;
    
    function searchRecursively(obj, path = '', depth = 0) {
        if (depth > 15 || foundPool !== null) return;
        if (!obj || typeof obj !== 'object') return;
        
        if (obj[poolName] && Array.isArray(obj[poolName]) && obj[poolName].length > 0) {
            console.log('‚úÖ Found via recursive search at path:', path);
            foundPool = obj[poolName];
            return;
        }
        
        for (let key in obj) {
            if (obj.hasOwnProperty(key) && typeof obj[key] === 'object') {
                searchRecursively(obj[key], path + '.' + key, depth + 1);
            }
        }
    }
    
    searchRecursively(assistantQAData, 'assistantQAData');
    
    if (foundPool && foundPool.length > 0) {
        console.log('‚úÖ Recursive search successful:', foundPool.length, 'items');
        return foundPool;
    }
    
    console.error('‚ùå No pool found for category:', category, 'poolName:', poolName);
    return [];
}

function getUniqueQuestions(pool, count, questionType) {
    if (!pool || pool.length === 0) {
        console.error('‚ùå getUniqueQuestions: pool is empty or null');
        return [];
    }
    
    console.log('üîç getUniqueQuestions called:', { poolLength: pool.length, count, questionType });
    
    if (!shownQuestions[questionType]) {
        shownQuestions[questionType] = [];
    }
    
    if (shownQuestions[questionType].length >= pool.length) {
        console.log('üîÑ Resetting shown questions for', questionType);
        shownQuestions[questionType] = [];
    }
    
    const availableQuestions = pool.filter(q => {
        if (!q.id) {
            console.warn('‚ö†Ô∏è Question missing ID:', q);
            return true;
        }
        return !shownQuestions[questionType].includes(q.id);
    });
    
    console.log('üìä Available questions:', availableQuestions.length);
    
    const shuffled = availableQuestions.sort(() => Math.random() - 0.5);
    const selected = shuffled.slice(0, Math.min(count, availableQuestions.length));
    
    selected.forEach(q => {
        if (q.id) {
            shownQuestions[questionType].push(q.id);
        }
    });
    
    console.log('‚úÖ Selected questions:', selected.length);
    return selected;
}

// TRANSLATION FUNCTIONS
function createTranslationButtons(text, elementId) {
    return `
        <div style="margin-top: 10px; display: flex; gap: 6px; justify-content: flex-start; flex-wrap: wrap;">
            <button onclick="translateTextInNewTab('${elementId}', 'or')" style="background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                üåê Odia
            </button>
            <button onclick="translateTextInNewTab('${elementId}', 'bn')" style="background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                üåê Bengali
            </button>
            <button onclick="translateTextInNewTab('${elementId}', 'hi')" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                üåê Hindi
            </button>
        </div>
    `;
}

function translateTextInNewTab(elementId, targetLanguage) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const text = element.textContent || element.innerText;
    if (!text || !text.trim()) return;
    
    const encodedText = encodeURIComponent(text.trim());
    const languageCodes = { 'or': 'or', 'bn': 'bn', 'hi': 'hi' };
    const langCode = languageCodes[targetLanguage];
    
    const googleTranslateUrl = `https://translate.google.com/?sl=en&tl=${langCode}&text=${encodedText}`;
    window.open(googleTranslateUrl, '_blank');
}

function translateCombinedText(elementId, targetLanguage) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const text = element.textContent || element.innerText;
    if (!text || !text.trim()) return;
    
    const encodedText = encodeURIComponent(text.trim());
    const languageCodes = { 'or': 'or', 'bn': 'bn', 'hi': 'hi' };
    const langCode = languageCodes[targetLanguage];
    
    const googleTranslateUrl = `https://translate.google.com/?sl=en&tl=${langCode}&text=${encodedText}`;
    window.open(googleTranslateUrl, '_blank');
}

// TEST RENDERING FUNCTIONS
function renderMCQTest() {
    const container = document.getElementById('responseContainer');
    
    let html = `
        <div class="test-container">
            <div style="text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 3px solid #667eea;">
                <h2 style="color: #667eea; font-size: 22px; font-weight: 900; margin-bottom: 10px;">üéØ MCQ TEST</h2>
                <p style="color: #666; font-size: 14px; margin: 0;">Total Questions: ${currentTest.questions.length} | Total Marks: ${currentTest.totalMarks}</p>
            </div>
    `;
    
    currentTest.questions.forEach((q, index) => {
        const combinedText = q.question + '\n\n' + q.options.map((opt, i) => `${String.fromCharCode(65 + i)}) ${opt}`).join('\n');
        const combinedId = `mcq-combined-${index}`;
        
        html += `
            <div class="question-card" id="question-${index}">
                <span class="question-number">Question ${index + 1}</span>
                <div class="question-text">${q.question}</div>
                
                <div style="margin-top: 12px; display: flex; gap: 6px; justify-content: flex-start; flex-wrap: wrap;">
                    <button onclick="translateCombinedText('${combinedId}', 'or')" style="background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                        üåê Odia
                    </button>
                    <button onclick="translateCombinedText('${combinedId}', 'bn')" style="background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                        üåê Bengali
                    </button>
                    <button onclick="translateCombinedText('${combinedId}', 'hi')" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer;">
                        üåê Hindi
                    </button>
                </div>
                
                <div id="${combinedId}" style="display: none;">${combinedText}</div>
                
                <div style="margin-top: 15px;">
        `;
        
        q.options.forEach((opt, i) => {
            html += `
                <button class="option-btn" onclick="selectOption(${index}, ${i})">
                    ${String.fromCharCode(65 + i)}) ${opt}
                </button>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += `
            <button class="submit-test-btn" onclick="submitTest(event)">
                üìä Submit Test & Get Certificate
            </button>
        </div>
    `;
    
    container.innerHTML = html;
}

function selectOption(questionIndex, optionIndex) {
    userAnswers[questionIndex] = optionIndex;
    
    const questionCard = document.getElementById(`question-${questionIndex}`);
    const buttons = questionCard.querySelectorAll('.option-btn');
    
    buttons.forEach((btn, i) => {
        if (i === optionIndex) {
            btn.classList.add('selected');
        } else {
            btn.classList.remove('selected');
        }
    });
}

function submitTest(event) {
    const submitBtn = event.target;
    if (submitBtn.disabled) return;
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.5';
    submitBtn.textContent = '‚úì Test Submitted';
    
    if (Object.keys(userAnswers).length < currentTest.questions.length) {
        alert('‚ö†Ô∏è Please answer all questions!');
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.textContent = 'üìä Submit Test';
        return;
    }
    
    let correctAnswers = 0;
    
    currentTest.questions.forEach((q, index) => {
        const questionCard = document.getElementById(`question-${index}`);
        const buttons = questionCard.querySelectorAll('.option-btn');
        
        buttons.forEach((btn, i) => {
            btn.style.pointerEvents = 'none';
            
            if (i === q.correct) {
                btn.classList.add('correct');
            }
            
            if (userAnswers[index] === i && i !== q.correct) {
                btn.classList.add('wrong');
            }
        });
        
        if (userAnswers[index] === q.correct) {
            correctAnswers++;
        }
        
        const explanation = document.createElement('div');
        explanation.style.cssText = 'background: #e8f5e9; border-left: 4px solid #4CAF50; border-radius: 8px; padding: 12px; margin-top: 15px; font-size: 13px; color: #2e7d32;';
        explanation.innerHTML = `<strong>üí° Explanation:</strong> ${q.explanation}`;
        questionCard.appendChild(explanation);
    });
    
    const percentage = (correctAnswers / currentTest.totalMarks * 100).toFixed(1);
    showCertificate(correctAnswers, currentTest.totalMarks, percentage, 'MCQ Test');
}

function renderTrueFalseTest() {
    const container = document.getElementById('responseContainer');
    
    let html = `
        <div class="test-container">
            <div style="text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 3px solid #667eea;">
                <h2 style="color: #667eea; font-size: 22px; font-weight: 900; margin-bottom: 10px;">‚úì‚úó TRUE/FALSE TEST</h2>
                <p style="color: #666; font-size: 14px; margin: 0;">Total Questions: ${currentTest.questions.length} | Total Marks: ${currentTest.totalMarks}</p>
            </div>
    `;
    
    currentTest.questions.forEach((q, index) => {
        const questionId = `tf-q-${index}`;
        html += `
            <div class="question-card" id="question-${index}">
                <span class="question-number">Question ${index + 1}</span>
                <div class="question-text" id="${questionId}">${q.statement}</div>
                ${createTranslationButtons(q.statement, questionId)}
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="option-btn" onclick="selectTFOption(${index}, true)" style="flex: 1;">
                        ‚úì TRUE
                    </button>
                    <button class="option-btn" onclick="selectTFOption(${index}, false)" style="flex: 1;">
                        ‚úó FALSE
                    </button>
                </div>
            </div>
        `;
    });
    
    html += `
            <button class="submit-test-btn" onclick="submitTFTest(event)">
                üìä Submit Test & Get Certificate
            </button>
        </div>
    `;
    
    container.innerHTML = html;
}

function selectTFOption(questionIndex, value) {
    userAnswers[questionIndex] = value;
    
    const questionCard = document.getElementById(`question-${questionIndex}`);
    const buttons = questionCard.querySelectorAll('.option-btn');
    
    buttons.forEach((btn, i) => {
        if ((i === 0 && value === true) || (i === 1 && value === false)) {
            btn.classList.add('selected');
        } else {
            btn.classList.remove('selected');
        }
    });
}

function submitTFTest(event) {
    const submitBtn = event.target;
    if (submitBtn.disabled) return;
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.5';
    submitBtn.textContent = '‚úì Test Submitted';
    
    if (Object.keys(userAnswers).length < currentTest.questions.length) {
        alert('‚ö†Ô∏è Please answer all questions!');
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.textContent = 'üìä Submit Test';
        return;
    }
    
    let correctAnswers = 0;
    
    currentTest.questions.forEach((q, index) => {
        const questionCard = document.getElementById(`question-${index}`);
        const buttons = questionCard.querySelectorAll('.option-btn');
        
        buttons.forEach((btn, i) => {
            btn.style.pointerEvents = 'none';
            
            if ((i === 0 && q.correct === true) || (i === 1 && q.correct === false)) {
                btn.classList.add('correct');
            }
            
            if (userAnswers[index] === (i === 0) && userAnswers[index] !== q.correct) {
                btn.classList.add('wrong');
            }
        });
        
        if (userAnswers[index] === q.correct) {
            correctAnswers++;
        }
        
        const explanation = document.createElement('div');
        explanation.style.cssText = 'background: #e8f5e9; border-left: 4px solid #4CAF50; border-radius: 8px; padding: 12px; margin-top: 15px; font-size: 13px; color: #2e7d32;';
        explanation.innerHTML = `<strong>üí° Explanation:</strong> ${q.explanation}`;
        questionCard.appendChild(explanation);
    });
    
    const percentage = (correctAnswers / currentTest.totalMarks * 100).toFixed(1);
    showCertificate(correctAnswers, currentTest.totalMarks, percentage, 'True/False Test');
}

function renderFillBlanksTest() {
    const container = document.getElementById('responseContainer');
    
    let html = `
        <div class="test-container">
            <div style="text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 3px solid #667eea;">
                <h2 style="color: #667eea; font-size: 22px; font-weight: 900; margin-bottom: 10px;">üìã FILL IN THE BLANKS</h2>
                <p style="color: #666; font-size: 14px; margin: 0;">Total Questions: ${currentTest.questions.length} | Total Marks: ${currentTest.totalMarks}</p>
            </div>
    `;
    
    currentTest.questions.forEach((q, index) => {
        const questionId = `fb-q-${index}`;
        html += `
            <div class="question-card" id="question-${index}">
                <span class="question-number">Question ${index + 1}</span>
                <div class="question-text" id="${questionId}">${q.question}</div>
                ${createTranslationButtons(q.question, questionId)}
                <div style="margin-top: 15px;">
                    <input type="text" 
                           class="assistant-input" 
                           id="answer-${index}"
                           placeholder="Type your answer here..."
                           style="min-height: 45px; font-size: 14px;"
                           onchange="saveFillBlankAnswer(${index}, this.value)">
                </div>
            </div>
        `;
    });
    
    html += `
            <button class="submit-test-btn" onclick="submitFillBlankTest(event)">
                üìä Submit Test & Get Certificate
            </button>
        </div>
    `;
    
    container.innerHTML = html;
}

function saveFillBlankAnswer(questionIndex, value) {
    userAnswers[questionIndex] = value.trim();
}

function submitFillBlankTest(event) {
    const submitBtn = event.target;
    if (submitBtn.disabled) return;
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.5';
    submitBtn.textContent = '‚úì Test Submitted';
    
    if (Object.keys(userAnswers).length < currentTest.questions.length) {
        alert('‚ö†Ô∏è Please answer all questions!');
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.textContent = 'üìä Submit Test';
        return;
    }
    
    let correctAnswers = 0;
    
    currentTest.questions.forEach((q, index) => {
        const questionCard = document.getElementById(`question-${index}`);
        const input = document.getElementById(`answer-${index}`);
        input.disabled = true;
        
        const userAns = (userAnswers[index] || '').toLowerCase().trim();
        const correctAns = q.answer.toLowerCase().trim();
        
        const isCorrect = userAns === correctAns;
        
        if (isCorrect) {
            correctAnswers++;
            input.style.borderColor = '#4CAF50';
            input.style.background = '#e8f5e9';
        } else {
            input.style.borderColor = '#f44336';
            input.style.background = '#ffebee';
        }
        
        const result = document.createElement('div');
        result.style.cssText = `background: ${isCorrect ? '#e8f5e9' : '#fff3cd'}; border-left: 4px solid ${isCorrect ? '#4CAF50' : '#ffc107'}; border-radius: 8px; padding: 12px; margin-top: 15px; font-size: 13px; color: ${isCorrect ? '#2e7d32' : '#856404'};`;
        result.innerHTML = `<strong>‚úÖ Correct Answer:</strong> ${q.answer}`;
        questionCard.appendChild(result);
    });
    
    const percentage = (correctAnswers / currentTest.totalMarks * 100).toFixed(1);
    showCertificate(correctAnswers, currentTest.totalMarks, percentage, 'Fill in the Blanks Test');
}

function renderMatchingTest() {
    const match = currentTest.data;
    currentTest.userMatches = {};
    
    // ‚úÖ Calculate exercise number
    const exerciseNum = currentTest.currentExerciseIndex + 1;
    const totalExercises = currentTest.totalExercises || 1;
    
    let html = `
        <div style="background: white; border-radius: 0; padding: 0; margin: 0;">
            <div style="text-align: center; padding: 20px 15px; border-bottom: 3px solid #667eea;">
                <h2 style="color: #667eea; font-size: 22px; font-weight: 900; margin-bottom: 10px;">üîó MATCHING EXERCISE</h2>
                <p style="color: #666; font-size: 14px; margin: 0;">Total Questions: ${match.columnA.length} | Total Marks: ${match.columnA.length}</p>
                
                <!-- ‚úÖ NEW: Exercise counter -->
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; margin-top: 10px; font-weight: 700; font-size: 14px;">
                    Exercise ${exerciseNum} of ${totalExercises}
                </div>
                
                <p style="color: #764ba2; font-size: 13px; margin-top: 8px; font-weight: 600;">Match Column A with Column B</p>
            </div>
            
            <div style="padding: 15px 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 10px;">
                    <div>
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 10px;">
                            üìå COLUMN A
                        </div>
    `;
    
    match.columnA.forEach((item, i) => {
        html += `
            <div onclick="selectMatchRow(${i})" style="background: #f8f9fa; padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid #667eea; cursor: pointer;">
                <div style="font-weight: bold; color: #667eea; margin-bottom: 4px;">${i + 1}.</div>
                <div style="font-size: 13px; color: #333;">${item}</div>
            </div>
        `;
    });
    
    html += `
                    </div>
                    <div>
                        <div style="background: linear-gradient(135deg, #764ba2, #667eea); color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 10px;">
                            üìå COLUMN B
                        </div>
    `;
    
  match.columnB.forEach((item, i) => {
        html += `
            <div class="match-option" id="colB-option-${i}" data-index="${i}" onclick="selectMatchOption(${i})" 
                 style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 2px solid #dee2e6; cursor: pointer; transition: all 0.3s ease;">
                <div style="font-weight: bold; color: #764ba2; margin-bottom: 4px;">${String.fromCharCode(65 + i)}.</div>
                <div style="font-size: 13px; color: #333;">${item}</div>
            </div>
        `;
    });
    
    html += `
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f2ff 100%); padding: 15px; margin: 15px 0 0 0;">
                    <h3 style="color: #667eea; text-align: center; margin-bottom: 15px; font-size: 16px;">‚úçÔ∏è Your Matches</h3>
                    <div id="userMatchesDisplay" style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 15px; min-height: 100px;">
    `;
    
    match.columnA.forEach((item, i) => {
        html += `
            <div id="match-row-${i}" style="padding: 8px; margin-bottom: 6px; border-bottom: 1px dashed #ddd; display: flex; align-items: center; gap: 10px;">
                <span style="font-weight: bold; color: #667eea; min-width: 30px;">${i + 1}.</span>
                <span style="color: #999; font-size: 13px;">‚Üí</span>
                <span id="match-answer-${i}" style="color: #999; font-style: italic; font-size: 13px;">Click Column B to match</span>
            </div>
        `;
    });
    
    html += `
                    </div>
                    
                    <!-- ‚úÖ NEW: Navigation Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
    `;
    
    // Previous button
    if (exerciseNum > 1) {
        html += `
                        <button onclick="goToPreviousExercise()" style="flex: 1; background: linear-gradient(135deg, #FFA726, #FB8C00); color: white; border: none; padding: 12px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            ‚Üê Previous Exercise
                        </button>
        `;
    }
    
    // Next button (only if not last exercise)
    if (exerciseNum < totalExercises) {
        html += `
                        <button onclick="goToNextExercise()" style="flex: 1; background: linear-gradient(135deg, #66BB6A, #43A047); color: white; border: none; padding: 12px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            Next Exercise ‚Üí
                        </button>
        `;
    }
    
    html += `
                    </div>
                    
                    <button class="submit-test-btn" onclick="submitMatchingTest(event)" style="margin: 0 15px;">
                        üìä Submit & Check Answers
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('responseContainer').innerHTML = html;
    window.selectedMatchRow = null;
}

function selectMatchRow(rowIndex) {
    for (let i = 0; i < currentTest.data.columnA.length; i++) {
        const colAItem = document.querySelector(`[onclick="selectMatchRow(${i})"]`);
        if (colAItem) {
            colAItem.style.background = '#f8f9fa';
            colAItem.style.borderLeft = '4px solid #667eea';
        }
    }
    
    const selectedColAItem = document.querySelector(`[onclick="selectMatchRow(${rowIndex})"]`);
    if (selectedColAItem) {
        selectedColAItem.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
        selectedColAItem.style.borderLeft = '4px solid #2196F3';
    }
    
    window.selectedMatchRow = rowIndex;
}

function selectMatchOption(optionIndex) {
    // Reset all Column B options to default style
    for (let i = 0; i < currentTest.data.columnB.length; i++) {
        const colBOption = document.getElementById(`colB-option-${i}`);
        if (colBOption) {
            colBOption.style.background = 'white';
            colBOption.style.borderColor = '#dee2e6';
            colBOption.style.transform = 'scale(1)';
        }
    }
    
    // Highlight clicked Column B option
    const clickedOption = document.getElementById(`colB-option-${optionIndex}`);
    if (clickedOption) {
        clickedOption.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
        clickedOption.style.borderColor = '#2196F3';
        clickedOption.style.transform = 'scale(1.02)';
    }
    
    if (window.selectedMatchRow === null || window.selectedMatchRow === undefined) {
        for (let i = 0; i < currentTest.data.columnA.length; i++) {
            if (!currentTest.userMatches[i]) {
                window.selectedMatchRow = i;
                selectMatchRow(i);
                break;
            }
        }
    }
    
    const rowIndex = window.selectedMatchRow;
    const letter = String.fromCharCode(65 + optionIndex);
    
    currentTest.userMatches[rowIndex] = optionIndex;
    
    const answerSpan = document.getElementById(`match-answer-${rowIndex}`);
    answerSpan.textContent = letter;
    answerSpan.style.color = '#4CAF50';
    answerSpan.style.fontWeight = 'bold';
    
    // After a brief moment, reset the Column B visual effect
    setTimeout(() => {
        if (clickedOption) {
            clickedOption.style.background = 'white';
            clickedOption.style.borderColor = '#dee2e6';
            clickedOption.style.transform = 'scale(1)';
        }
    }, 500);
    
    window.selectedMatchRow = null;
}

function submitMatchingTest(event) {
    const submitBtn = event.target;
    if (submitBtn.disabled) return;
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.5';
    submitBtn.textContent = '‚úì Test Submitted';
    
    if (Object.keys(currentTest.userMatches).length < currentTest.data.columnA.length) {
        alert('‚ö†Ô∏è Please match all items!');
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.textContent = 'üìä Submit';
        return;
    }
    
    let correctAnswers = 0;
    
    currentTest.data.columnA.forEach((item, i) => {
        const userAnswer = currentTest.userMatches[i];
        const correctAnswer = currentTest.data.correct_matches[i];
        const isCorrect = userAnswer === correctAnswer;
        
        if (isCorrect) correctAnswers++;
        
        const rowElement = document.getElementById(`match-row-${i}`);
        const answerSpan = document.getElementById(`match-answer-${i}`);
        
        if (isCorrect) {
            rowElement.style.background = 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)';
            answerSpan.style.color = '#2e7d32';
        } else {
            rowElement.style.background = 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)';
            answerSpan.innerHTML = `${String.fromCharCode(65 + userAnswer)} ‚úó (Correct: ${String.fromCharCode(65 + correctAnswer)})`;
        }
    });
    
    // ‚úÖ Store score
    currentTest.finalScore = correctAnswers;
    
    const percentage = (correctAnswers / currentTest.data.columnA.length * 100).toFixed(1);
    setTimeout(() => {
        showCertificate(correctAnswers, currentTest.data.columnA.length, percentage, 'Matching Exercise');
    }, 1000);
}

function renderWordArrangementTest() {
    const wa = currentTest.data;
    currentTest.selectedWords = [];
    currentTest.availableWords = [...wa.jumbled];
    
    // ‚úÖ Calculate exercise number
    const exerciseNum = currentTest.currentExerciseIndex + 1;
    const totalExercises = currentTest.totalExercises || 1;
    
    let html = `
        <div style="background: white; border-radius: 0; padding: 0; margin: 0;">
            <div style="text-align: center; padding: 20px 15px; border-bottom: 3px solid #667eea;">
                <h2 style="color: #667eea; font-size: 22px; font-weight: 900; margin-bottom: 10px;">üî§ WORD ARRANGEMENT</h2>
                
                <!-- ‚úÖ NEW: Exercise counter -->
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; margin: 10px 0; font-weight: 700; font-size: 14px;">
                    Exercise ${exerciseNum} of ${totalExercises}
                </div>
                
                <p style="color: #666; font-size: 14px; margin: 0;">Click words in correct order</p>
            </div>
            
            <div style="padding: 20px 15px;">
                <div style="background: #e3f2fd; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <strong style="color: #1976D2;">üí° Hint:</strong>
                    <p style="color: #333; margin: 8px 0 0 0; font-size: 14px;">${wa.hint}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f2ff 100%); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 12px; font-size: 16px; text-align: center;">‚úçÔ∏è Your Sentence:</h4>
                    <div id="selectedWordsDisplay" style="background: white; border-radius: 8px; padding: 15px; min-height: 80px; border: 2px dashed #667eea; text-align: center; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center;">
                        <span style="color: #999; font-style: italic; font-size: 14px;" id="emptyMessage">Click words below...</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button onclick="clearWordSelection()" style="background: #f44336; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-size: 13px; cursor: pointer; font-weight: 600;">
                            üîÑ Clear All
                        </button>
                    </div>
                </div>
                
                <div style="background: #fff3cd; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #856404; margin-bottom: 12px; font-size: 16px; text-align: center;">üìù Available Words:</h4>
                    <div id="availableWordsDisplay" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
    `;
    
    wa.jumbled.forEach((word, index) => {
        html += `
            <button 
                class="word-btn" 
                data-index="${index}"
                onclick="selectWord(${index})"
                style="background: white; border: 2px solid #667eea; color: #667eea; padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer;">
                ${word}
            </button>
        `;
    });
    
    html += `
                    </div>
                </div>
                
                <!-- ‚úÖ NEW: Navigation Buttons -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
    `;
    
    // Previous button
    if (exerciseNum > 1) {
        html += `
                    <button onclick="goToPreviousExercise()" style="flex: 1; background: linear-gradient(135deg, #FFA726, #FB8C00); color: white; border: none; padding: 12px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        ‚Üê Previous Exercise
                    </button>
        `;
    }
    
    // Next button (only if not last exercise)
    if (exerciseNum < totalExercises) {
        html += `
                    <button onclick="goToNextExercise()" style="flex: 1; background: linear-gradient(135deg, #66BB6A, #43A047); color: white; border: none; padding: 12px; border-radius: 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        Next Exercise ‚Üí
                    </button>
        `;
    }
    
    html += `
                </div>
                
                <button class="submit-test-btn" onclick="submitWordArrangement(event)" style="margin: 0;">
                    ‚úÖ Check My Answer
                </button>
                
                <div id="wordArrangementResult" style="display: none; margin-top: 20px;"></div>
            </div>
        </div>
    `;
    
    document.getElementById('responseContainer').innerHTML = html;
}

function selectWord(index) {
    const wordBtn = document.querySelector(`[data-index="${index}"]`);
    
    if (wordBtn.style.display === 'none') return;
    
    currentTest.selectedWords.push({
        index: index,
        word: currentTest.availableWords[index]
    });
    
    wordBtn.style.display = 'none';
    updateSelectedWordsDisplay();
}

function updateSelectedWordsDisplay() {
    const display = document.getElementById('selectedWordsDisplay');
    const emptyMessage = document.getElementById('emptyMessage');
    
    if (currentTest.selectedWords.length === 0) {
        if (emptyMessage) emptyMessage.style.display = 'block';
        return;
    }
    
    if (emptyMessage) emptyMessage.style.display = 'none';
    
    let html = '';
    currentTest.selectedWords.forEach((item, i) => {
        html += `
            <div onclick="removeWord(${i})" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; position: relative;">
                ${item.word}
                <span style="position: absolute; top: -5px; right: -5px; background: #f44336; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">√ó</span>
            </div>
        `;
    });
    
    display.innerHTML = html;
}

function removeWord(selectedIndex) {
    const removedWord = currentTest.selectedWords[selectedIndex];
    currentTest.selectedWords.splice(selectedIndex, 1);
    
    const wordBtn = document.querySelector(`[data-index="${removedWord.index}"]`);
    if (wordBtn) {
        wordBtn.style.display = 'inline-block';
    }
    
    updateSelectedWordsDisplay();
}

function clearWordSelection() {
    currentTest.selectedWords.forEach(item => {
        const wordBtn = document.querySelector(`[data-index="${item.index}"]`);
        if (wordBtn) {
            wordBtn.style.display = 'inline-block';
        }
    });
    
    currentTest.selectedWords = [];
    
    const display = document.getElementById('selectedWordsDisplay');
    display.innerHTML = '<span style="color: #999; font-style: italic; font-size: 14px;" id="emptyMessage">Click words below...</span>';
}

function submitWordArrangement(event) {
    const submitBtn = event.target;
    if (submitBtn.disabled) return;
    
    if (currentTest.selectedWords.length !== currentTest.availableWords.length) {
        alert('‚ö†Ô∏è Please select all words!');
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.5';
    submitBtn.textContent = '‚úì Checked';
    
    const userSentence = currentTest.selectedWords.map(item => item.word).join(' ');
    const correctSentence = currentTest.data.correct;
    
    // ‚úÖ Strip punctuation before comparing
    const stripPunctuation = (str) => str.toLowerCase().trim()
        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '')
        .replace(/\s+/g, ' ');
    
    const normalizedUser = stripPunctuation(userSentence);
    const normalizedCorrect = stripPunctuation(correctSentence);
    
    const isCorrect = normalizedUser === normalizedCorrect;
    
    // ‚úÖ Store score
    currentTest.finalScore = isCorrect ? 1 : 0;
    
    const resultDiv = document.getElementById('wordArrangementResult');
    resultDiv.style.display = 'block';
    
    if (isCorrect) {
        resultDiv.innerHTML = `
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 3px solid #4CAF50; border-radius: 15px; padding: 25px; text-align: center;">
                <div style="font-size: 60px; margin-bottom: 15px;">üéâ</div>
                <h3 style="color: #2e7d32; font-size: 24px; font-weight: 900; margin-bottom: 15px;">CORRECT!</h3>
                <div style="background: white; border-radius: 10px; padding: 15px; margin: 15px 0;">
                    <p style="color: #333; font-size: 16px; font-weight: 600; margin: 0;">"${userSentence}"</p>
                </div>
            </div>
        `;
        setTimeout(() => showCertificate(1, 1, 100, 'Word Arrangement'), 1500);
    } else {
        resultDiv.innerHTML = `
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border: 3px solid #ffc107; border-radius: 15px; padding: 25px;">
                <h3 style="color: #856404; font-size: 22px; font-weight: 900; margin-bottom: 15px; text-align: center;">Not Quite Right</h3>
                <div style="background: white; border-radius: 10px; padding: 15px; margin: 15px 0;">
                    <strong>Your Answer:</strong>
                    <p style="color: #333; font-size: 15px; margin: 8px 0 0 0;">"${userSentence}"</p>
                </div>
                <div style="background: white; border-radius: 10px; padding: 15px; margin: 15px 0;">
                    <strong style="color: #2e7d32;">Correct Answer:</strong>
                    <p style="color: #333; font-size: 15px; font-weight: 600; margin: 8px 0 0 0;">"${correctSentence}"</p>
                </div>
            </div>
        `;
        setTimeout(() => showCertificate(0, 1, 0, 'Word Arrangement'), 1500);
    }
}

function goToNextExercise() {
    if (!currentTest || !currentTest.allExercises) {
        console.error('‚ùå No current test or exercises');
        return;
    }
    
    // ‚úÖ Save score BEFORE moving to next
    if (currentTest.finalScore !== undefined) {
        cumulativeScore += currentTest.finalScore;
        cumulativeTotalMarks += currentTest.totalMarks;
    }
    
    const nextIndex = currentTest.currentExerciseIndex + 1;
    
    if (nextIndex >= currentTest.allExercises.length) {
        alert('üéâ You have completed all exercises!');
        return;
    }
    
    // Reset for next exercise
    currentTest.currentExerciseIndex = nextIndex;
    currentTest.data = currentTest.allExercises[nextIndex];
    currentTest.totalMarks = currentTest.type === 'matching' 
        ? currentTest.data.columnA.length 
        : 1;
    currentTest.userMatches = {};
    userAnswers = {};
    delete currentTest.finalScore; // ‚úÖ Reset for new exercise
    
    // Re-render
    if (currentTest.type === 'matching') {
        renderMatchingTest();
    } else {
        renderWordArrangementTest();
    }
}

function goToPreviousExercise() {
    if (!currentTest || !currentTest.allExercises) {
        console.error('‚ùå No current test or exercises');
        return;
    }
    
    const prevIndex = currentTest.currentExerciseIndex - 1;
    
    if (prevIndex < 0) {
        alert('‚ö†Ô∏è You are already at the first exercise!');
        return;
    }
    
    // ‚úÖ Don't save score when going backward - just navigate
    // Reset for previous exercise
    currentTest.currentExerciseIndex = prevIndex;
    currentTest.data = currentTest.allExercises[prevIndex];
    currentTest.totalMarks = currentTest.type === 'matching' 
        ? currentTest.data.columnA.length 
        : 1;
    currentTest.userMatches = {};
    userAnswers = {};
    delete currentTest.finalScore;
    
    // Re-render
    if (currentTest.type === 'matching') {
        renderMatchingTest();
    } else {
        renderWordArrangementTest();
    }
}

function showCertificate(score, totalMarks, percentage, testType) {
    // ‚úÖ Calculate cumulative totals
    const finalScore = cumulativeScore + score;
    const finalTotal = cumulativeTotalMarks + totalMarks;
    const finalPercentage = finalTotal > 0 ? ((finalScore / finalTotal) * 100).toFixed(1) : percentage;
    
    let performanceLevel = '';
    let message = '';
    
    // Use cumulative percentage if multiple exercises, otherwise current percentage
    const perfPercent = finalTotal > totalMarks ? finalPercentage : percentage;
    
    if (perfPercent >= 90) {
        performanceLevel = 'üèÜ EXCELLENT';
        message = 'Outstanding performance!';
    } else if (perfPercent >= 75) {
        performanceLevel = '‚≠ê VERY GOOD';
        message = 'Great job!';
    } else if (perfPercent >= 60) {
        performanceLevel = 'üëç GOOD';
        message = 'Good effort!';
    } else {
        performanceLevel = 'üìñ NEEDS IMPROVEMENT';
        message = 'Keep practicing!';
    }
    
    // ‚úÖ Check if there's a next exercise
    const hasNextExercise = currentTest && currentTest.allExercises && 
                           (currentTest.currentExerciseIndex + 1) < currentTest.totalExercises;
    
    const certificateHTML = `
        <div class="certificate-container" style="background: white; border-radius: 15px; padding: 30px; margin-top: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 24px; font-weight: 900; color: #667eea; margin-bottom: 20px;">üéì CERTIFICATE</div>
            
            ${finalTotal > totalMarks ? `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <div style="font-size: 14px; color: #2e7d32; margin-bottom: 5px; font-weight: 600;">üìä TOTAL SCORE (All Exercises)</div>
                    <div style="font-size: 36px; font-weight: 900; color: #4CAF50; margin: 10px 0;">${finalScore} / ${finalTotal}</div>
                    <div style="font-size: 28px; font-weight: 700; color: #2e7d32;">${finalPercentage}%</div>
                </div>
                <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; margin: 10px 0;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 3px;">This Exercise:</div>
                    <div style="font-size: 20px; font-weight: 700; color: #667eea;">${score} / ${totalMarks} (${percentage}%)</div>
                </div>
            ` : `
                <div style="font-size: 32px; font-weight: 900; color: #667eea; margin: 20px 0;">${score} / ${totalMarks}</div>
                <div style="font-size: 24px; font-weight: 700; color: #764ba2; margin: 10px 0;">${percentage}%</div>
            `}
            
            <div style="font-size: 20px; font-weight: 700; color: #4CAF50; margin: 20px 0; padding: 15px; background: #e8f5e9; border-radius: 10px;">${performanceLevel}</div>
            <div style="color: #666; font-size: 16px; margin: 20px 0;">${message}</div>
            <div style="color: #999; font-size: 14px; margin-top: 30px;">
                ${new Date().toLocaleDateString('en-IN')}<br>
                ${testType}
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin: 20px 15px;">
            ${hasNextExercise ? `
                <button class="submit-test-btn" onclick="goToNextExercise()" style="flex: 1; margin: 0; background: linear-gradient(135deg, #66BB6A, #43A047);">
                    Next Exercise ‚Üí
                </button>
            ` : ''}
            <button class="submit-test-btn" onclick="resetTest()" style="flex: 1; margin: 0;">
                üîÑ ${hasNextExercise ? 'Start Over' : 'Take Another Test'}
            </button>
        </div>
    `;
    
    document.getElementById('responseContainer').innerHTML += certificateHTML;
}

function resetTest() {
    document.getElementById('assistantInput').value = '';
    document.getElementById('responseContainer').innerHTML = '';
    document.getElementById('responseContainer').classList.remove('show');
    
    currentTest = null;
    userAnswers = {};
    cumulativeScore = 0;
    cumulativeTotalMarks = 0;
    
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    
    const actionSection = document.querySelector('.quick-actions');
    if (actionSection) {
        actionSection.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    const mainActionBtn = document.getElementById('mainActionBtn');
    if (mainActionBtn) {
        const actionGrid = document.getElementById('actionGrid');
        if (actionGrid && actionGrid.classList.contains('hidden')) {
            actionGrid.classList.remove('hidden');
            mainActionBtn.querySelector('span').textContent = '‚ñ≤';
        }
        
        mainActionBtn.style.animation = 'pulse 1s ease-in-out 2';
        setTimeout(() => {
            mainActionBtn.style.animation = '';
        }, 2000);
    }
}

// NEW: Toggle BNSS Section Text
function toggleBNSSText() {
    const content = document.getElementById('bnssTextContent');
    const arrow = document.getElementById('bnssArrow');
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        arrow.textContent = '‚ñ≤';
    } else {
        content.style.display = 'none';
        arrow.textContent = '‚ñº';
    }
}



function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            if (!panel) {
                console.error('Settings panel not found!');
                return;
            }
            
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            } else {
                panel.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
        }

        function closeSettingsOnOverlay(event) {
            // Close if clicking on the dark overlay (not the modal content)
            if (event.target.id === 'settingsPanel') {
                toggleSettings();
            }
        }
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            if (!input) {
                console.error('API Key input not found!');
                alert('Error: Could not find API Key input field!');
                return;
            }
            
            const key = input.value.trim();
            
            if (!key) {
                alert('‚ö†Ô∏è Please enter an API Key!');
                input.focus();
                return;
            }
            
            if (key.length < 20) {
                alert('‚ö†Ô∏è API Key seems too short. Please check and try again.');
                input.focus();
                return;
            }
            
            apiKey = key;
            
            try {
                localStorage.setItem('gemini_api_key', key);
            } catch (e) {
                console.warn('Could not save to localStorage:', e);
            }
            
            toggleSettings();
            
            alert('‚úÖ API Key saved successfully!\n\nYou can now use AI Mode features.');
            
            input.value = '';
            
            // Update button text
            const apiKeyBtn = document.getElementById('apiKeyBtn');
            if (apiKeyBtn) {
                apiKeyBtn.innerHTML = '‚úÖ API Key Set (Click to Change)';
                apiKeyBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            }
            
            console.log('API Key saved successfully');
        }
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type.startsWith('image/')) {
                await handleImageUpload(file);
            } else if (file.type === 'application/pdf') {
                await handlePdfUpload(file);
            } else {
                alert('Please upload PDF or Image');
            }
        }

        async function handleImageUpload(file) {
            pdfName = file.name;
            const statusEl = document.getElementById('pdfStatus');
            if (statusEl) {
                statusEl.textContent = `üñºÔ∏è ${pdfName} Processing...`;
            }

            try {
                addMessage('assistant', 'üì∏ Extracting text from image... please wait', false);
                
                const result = await Tesseract.recognize(file, 'eng+hin+ori', {
                    logger: m => {
                        if (m.status === 'recognizing text' && statusEl) {
                            statusEl.textContent = `üñºÔ∏è Processing: ${Math.round(m.progress * 100)}%`;
                        }
                    }
                });

                pdfContent = result.data.text;
                if (statusEl) {
                    statusEl.textContent = `‚úÖ ${pdfName} - Ask about the image`;
                }
                addMessage('assistant', `‚úÖ Image loaded: ${pdfName}\n\nNow ask me questions about it!`, false);
            } catch (error) {
                console.error('Image processing error:', error);
                if (statusEl) {
                    statusEl.textContent = '‚ùå Failed to load image';
                }
                addMessage('assistant', `‚ùå Error processing image: ${error.message}`, false);
            }
        }

        async function handlePdfUpload(file) {
            pdfName = file.name;
            const statusEl = document.getElementById('pdfStatus');
            if (statusEl) {
                statusEl.textContent = `üìÑ ${pdfName} Loading...`;
            }

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const numPages = Math.min(pdf.numPages, 50);
                
                let fullText = '';
                for (let i = 1; i <= numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `\n--- Page ${i} ---\n${pageText}\n`;
                }

                pdfContent = fullText;
                if (statusEl) {
                    statusEl.textContent = `‚úÖ ${pdfName} (${numPages} pages) - Ask about PDF`;
                }
                addMessage('assistant', `‚úÖ PDF loaded: ${pdfName}\nüìÑ ${numPages} pages\n\nNow ask me about the PDF!`, false);
            } catch (error) {
                console.error('PDF processing error:', error);
                if (statusEl) {
                    statusEl.textContent = '‚ùå Failed to load PDF';
                }
                addMessage('assistant', `‚ùå Error loading PDF: ${error.message}`, false);
            }
        }

        async function loadJsonFromGithub() {
            if (!GITHUB_JSON_URL) {
                const statusEl = document.getElementById('pdfStatus');
                if (statusEl) {
                    statusEl.textContent = 'Ready for questions';
                }
                addMessage('assistant', 'Hello! Ask me any question.', false);
                return;
            }

            try {
                const response = await fetch(GITHUB_JSON_URL);
                if (!response.ok) throw new Error('Failed to fetch JSON');
                
                const jsonData = await response.json();
                jsonContent = JSON.stringify(jsonData, null, 2);
                jsonName = GITHUB_JSON_URL.split('/').pop();
                
                const statusEl = document.getElementById('pdfStatus');
                if (statusEl) {
                    statusEl.textContent = `‚úÖ Database loaded`;
                }
                
                addMessage('assistant', `‚úÖ Database loaded!\n\nAsk me:\nüìä About database\nüìÑ Upload document\nüåç General questions\n`, false);
            } catch (error) {
                console.error('JSON loading error:', error);
                const statusEl = document.getElementById('pdfStatus');
                if (statusEl) {
                    statusEl.textContent = '‚ö†Ô∏è Database load failed';
                }
                addMessage('assistant', `‚ö†Ô∏è Database failed to load. You can still ask me questions!\n`, false);
            }
        }

        function speakText(text) {
            if (!voiceSupported || !synthesis) return;

            synthesis.cancel();

            const lang = document.getElementById('languageSelect').value;
            
            let chunks = [];
            const sentences = text.split(/([‡•§!?.\n]+)/);
            
            for (let i = 0; i < sentences.length; i++) {
                const sentence = sentences[i].trim();
                if (!sentence) continue;
                
                const words = sentence.split(/\s+/);
                
                if (words.length > 15) {
                    for (let j = 0; j < words.length; j += 12) {
                        const chunk = words.slice(j, j + 12).join(' ');
                        if (chunk.trim()) {
                            chunks.push(chunk.trim());
                        }
                    }
                } else {
                    chunks.push(sentence);
                }
            }
            
            if (chunks.length === 0) {
                const words = text.split(/\s+/);
                for (let i = 0; i < words.length; i += 12) {
                    const chunk = words.slice(i, i + 12).join(' ');
                    if (chunk.trim()) {
                        chunks.push(chunk.trim());
                    }
                }
            }
            
            let currentIndex = 0;
            
            function speakNextChunk() {
                if (currentIndex >= chunks.length) {
                    isSpeaking = false;
                    document.getElementById('speakingStatus').style.display = 'none';
                    return;
                }
                
                const utterance = new SpeechSynthesisUtterance(chunks[currentIndex]);
                utterance.lang = `${lang}-IN`;
                utterance.rate = 0.85;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                if (currentIndex === 0) {
                    utterance.onstart = () => {
                        isSpeaking = true;
                        document.getElementById('speakingStatus').style.display = 'block';
                    };
                }
                
                utterance.onend = () => {
                    currentIndex++;
                    setTimeout(speakNextChunk, 500);
                };
                
                utterance.onerror = (event) => {
                    console.error('Speech error:', event);
                    currentIndex++;
                    setTimeout(speakNextChunk, 300);
                };
                
                synthesis.speak(utterance);
            }
            
            speakNextChunk();
        }

        function stopSpeaking() {
            if (synthesis) {
                synthesis.cancel();
                isSpeaking = false;
                document.getElementById('speakingStatus').style.display = 'none';
            }
        }

        function toggleListening() {
            if (!voiceSupported || !recognition) {
                alert('Voice not supported in this browser. Use Chrome.');
                return;
            }

            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            try {
                const lang = document.getElementById('languageSelect').value;
                recognition.lang = `${lang}-IN`;
                isListening = true;
                document.getElementById('listeningIndicator').classList.remove('hidden');
                document.getElementById('micButton').classList.add('bg-red-500', 'animate-pulse');
                document.getElementById('micButton').classList.remove('bg-blue-500');
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
                stopListening();
            }
        }

        function stopListening() {
            isListening = false;
            document.getElementById('listeningIndicator').classList.add('hidden');
            document.getElementById('micButton').classList.remove('bg-red-500', 'animate-pulse');
            document.getElementById('micButton').classList.add('bg-blue-500');
            if (recognition) {
                try { recognition.stop(); } catch (e) {}
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (currentMode === 'teacher') {
                    sendQuery();
                } else {
                    sendMessage();
                }
            }
        }

        function startCooldownTimer() {
            const sendButton = document.getElementById('sendBtnMain');
            const assistantInput = document.getElementById('assistantInput');
            
            sendButton.disabled = true;
            sendButton.style.opacity = '0.5';
            sendButton.style.cursor = 'not-allowed';
            assistantInput.disabled = true;
            assistantInput.style.opacity = '0.5';
            assistantInput.style.cursor = 'not-allowed';
            
            let remainingTime = Math.ceil(MIN_REQUEST_INTERVAL / 1000);
            sendButton.textContent = `‚è≥ Wait ${remainingTime}s`;
            
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                remainingTime--;
                if (remainingTime > 0) {
                    sendButton.textContent = `‚è≥ Wait ${remainingTime}s`;
                } else {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    
                    sendButton.disabled = false;
                    sendButton.style.opacity = '1';
                    sendButton.style.cursor = 'pointer';
                    assistantInput.disabled = false;
                    assistantInput.style.opacity = '1';
                    assistantInput.style.cursor = 'text';
                    sendButton.textContent = 'Send Question ‚û§';
                }
            }, 1000);
        }

        function addMessage(role, content, withSpeaker = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const cleanContent = content.replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/\n/g, '<br>');
            
            const speakerButton = withSpeaker ? `
                <button onclick="speakText(\`${content.replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/\n/g, ' ')}\`)" style="background: none; border: none; cursor: pointer; padding: 4px;">
                    <svg style="width: 16px; height: 16px; color: #FF6B6B;" fill="none" stroke="currentColor" viewBox="0 0

24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                    </svg>
                </button>
            ` : '';
            
            messageDiv.innerHTML = `
                <div style="max-width: 85%; border-radius: 15px; padding: 12px 15px; ${
                    role === 'user' 
                        ? 'background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white;' 
                        : 'background: white; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1);'
                }">
                    <div style="display: flex; align-items: start; gap: 8px;">
                        <p style="flex: 1; margin: 0; line-height: 1.6;">${cleanContent}</p>
                        ${speakerButton}
                    </div>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
        }

        function showLoading() {
            const messagesDiv = document.getElementById('messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div style="background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 15px; padding: 12px 15px;">
                    <svg style="width: 20px; height: 20px; animation: spin 1s linear infinite;" fill="none" viewBox="0 0 24 24">
                        <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="#FF6B6B" stroke-width="4"></circle>
                        <path style="opacity: 0.75;" fill="#FF6B6B" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            `;
            messagesDiv.appendChild(loadingDiv);
            document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('assistantInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!apiKey) {
                alert('Please set API Key first!\n\nClick the ‚öôÔ∏è button to set your API key.');
                toggleSettings();
                return;
            }

            const now = Date.now();
            if (now - lastRequestTime < MIN_REQUEST_INTERVAL) {
                return;
            }

            addMessage('user', message);
            input.value = '';
            showLoading();
            
            lastRequestTime = now;
            startCooldownTimer();

            try {
                const language = document.getElementById('languageSelect').value;
                const mode = document.getElementById('answerMode').value;
                
                const languageNames = {
                    'or': 'Odia (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü)',
                    'hi': 'Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)',
                    'en': 'English',
                    'bn': 'Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)',
                    'te': 'Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)'
                };

                let modeInstruction = '';
                if (mode === 'steps') {
                    modeInstruction = 'Provide a detailed step-by-step solution with clear explanations.';
                } else if (mode === 'table') {
                    modeInstruction = 'Answer with calculation tables where appropriate. Provide detailed explanations.';
                } else if (mode === 'verify') {
                    modeInstruction = 'Solve and verify the answer with detailed reasoning.';
                } else {
                    modeInstruction = 'Provide a clear, comprehensive, and well-explained answer.';
                }
           
                let prompt;
                if (pdfContent || jsonContent) {
                    let contextParts = [];
                    
                    if (pdfContent) {
                        const pdfExcerpt = pdfContent.substring(0, 20000);
                        contextParts.push(`PDF CONTENT:\n${pdfExcerpt}`);
                    }
                    
                    if (jsonContent) {
                        const jsonExcerpt = jsonContent.substring(0, 15000);
                        contextParts.push(`JSON DATABASE:\n${jsonExcerpt}`);
                    }
                    
                    const combinedContext = contextParts.join('\n\n---\n\n');
                    
                    prompt = `You are a helpful AI assistant. Answer in ${languageNames[language]} language.

${modeInstruction}

${combinedContext}

USER QUESTION: ${message}

INSTRUCTIONS:
- FIRST, check if the question relates to the PDF content (if provided). If yes, answer from PDF.
- SECOND, if not related to PDF, check if it relates to the JSON database (if provided). If yes, answer from JSON and add note: "üìä (From Database)".
- THIRD, if not related to either PDF or JSON, answer from general knowledge and add note: "üåç (General knowledge - not from documents)".
- Always provide helpful answers regardless of the source.

ANSWER:`;
                } else {
                    prompt = `You are a helpful AI assistant. Answer in ${languageNames[language]} language.

${modeInstruction}

USER QUESTION: ${message}

ANSWER:`;
                }

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 2048,
                            }
                        })
                    }
                );

                hideLoading();

                const data = await response.json();
                
                if (data.error) {
                    if (data.error.message.includes('quota') || data.error.message.includes('limit')) {
                        throw new Error('API Quota exhausted. Please try tomorrow.');
                    } else if (data.error.message.includes('API key')) {
                        throw new Error('Invalid API Key. Check Settings.');
                    }
                    throw new Error(data.error.message || 'API Error');
                }

                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I could not understand.';
                
                addMessage('assistant', aiResponse, true);
                
                setTimeout(() => speakText(aiResponse), 500);
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                
                let errorMessage = '';
                if (error.message.includes('quota') || error.message.includes('Quota')) {
                    errorMessage = '‚ùå API Quota exhausted. Please try tomorrow.';
                } else if (error.message.includes('API Key') || error.message.includes('API_KEY')) {
                    errorMessage = '‚ùå Invalid API Key.\n\n‚öôÔ∏è Check Settings.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = '‚ùå Network error.\n\nüîÑ Please try again.';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                addMessage('assistant', errorMessage, false);
            }
        }

        window.generatePracticeQuestions = async function() {
            if (!apiKey) {
                alert('Please set API Key first.');
                toggleSettings();
                return;
            }

            if (!pdfContent && !jsonContent) {
                addMessage('assistant', '‚ö†Ô∏è Please upload a PDF first for practice questions.', false);
                return;
            }

            const now = Date.now();
            if (now - lastRequestTime < MIN_REQUEST_INTERVAL) {
                return;
            }

            showLoading();
            
            lastRequestTime = now;
            startCooldownTimer();

            try {
                const language = document.getElementById('languageSelect').value;
                const languageNames = {
                    'or': 'Odia (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü)',
                    'hi': 'Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)',
                    'en': 'English',
                    'bn': 'Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)',
                    'te': 'Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)'
                };

                const pdfExcerpt = pdfContent.substring(0, 8000);
                
                const prompt = `Generate 5 practice questions based on the following content. Generate in ${languageNames[language]} language.

Provide detailed, well-formed questions that thoroughly test understanding.

Difficulty: Medium

CONTENT:
${pdfExcerpt}

Create 5 meaningful practice questions that test understanding of this content. Number them 1-5.`;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            generationConfig: {
                                temperature: 0.9,
                                maxOutputTokens: 1024,
                            }
                        })
                    }
                );

                hideLoading();

                const data = await response.json();
                
                if (data.error) {
                    if (data.error.message.includes('quota') || data.error.message.includes('limit')) {
                        throw new Error('API Quota exhausted');
                    }
                    throw new Error(data.error.message || 'API Error');
                }

                const questions = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Could not generate questions.';
                
                addMessage('assistant', `üìö Practice Questions:\n\n${questions}`, false);
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                
                let errorMessage = '';
                if (error.message.includes('quota') || error.message.includes('Quota')) {
                    errorMessage = '‚ùå API Quota exhausted. Please try tomorrow.';
                } else {
                    errorMessage = `‚ùå Error: ${error.message}`;
                }
                
                addMessage('assistant', errorMessage, false);
            }
        };

        window.askQuickQuestion = function(questionType) {
            if (!pdfContent) {
                addMessage('assistant', '‚ö†Ô∏è Please upload a PDF first.', false);
                return;
            }

            const questions = {
                'or': {
                    'summary': '‡¨è‡¨π‡¨ø PDF ‡¨∞ ‡¨∏‡¨æ‡¨∞‡¨æ‡¨Ç‡¨∂ ‡¨¶‡¨ø‡¨Ö',
                    'keypoints': '‡¨Æ‡≠Å‡¨ñ‡≠ç‡≠ü ‡¨¨‡¨ø‡¨®‡≠ç‡¨¶‡≠Å‡¨ó‡≠Å‡¨°‡¨º‡¨ø‡¨ï ‡¨ï\'‡¨£?',
                    'explain': '‡¨è‡¨π‡¨æ‡¨ï‡≠Å ‡¨∏‡¨∞‡¨≥ ‡¨≠‡¨æ‡¨¨‡¨∞‡≠á ‡¨¨‡≠Å‡¨ù‡¨æ‡¨Ö'
                },
                'hi': {
                    'summary': '‡§á‡§∏ PDF ‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§¶‡•á‡§Ç',
                    'keypoints': '‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡§ø‡§Ç‡§¶‡•Å ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à‡§Ç?',
                    'explain': '‡§á‡§∏‡•á ‡§∏‡§∞‡§≤ ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•á ‡§∏‡§Æ‡§ù‡§æ‡§è‡§Ç'
                },
                'en': {
                    'summary': 'Give a summary of this PDF',
                    'keypoints': 'What are the key points?',
                    'explain': 'Explain this simply'
                }
            };

            const lang = document.getElementById('languageSelect').value;
            const langGroup = lang === 'or' ? 'or' : (lang === 'hi' ? 'hi' : 'en');
            const question = questions[langGroup][questionType];
            
            document.getElementById('assistantInput').value = question;
            sendMessage();
        };

let apiKey = '';
        let isListening = false;
        let isSpeaking = false;

// Try to load saved API key from localStorage
        try {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                apiKey = savedKey;
                console.log('API Key loaded from localStorage');
            }
        } catch (e) {
            console.warn('Could not load API Key from localStorage:', e);
        }
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let pdfContent = '';
        let pdfName = '';
        let jsonContent = '';
        let jsonName = '';
        let lastRequestTime = 0;
        const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/eguruOdisha/audio/X/assistant-qa.json';
        const MIN_REQUEST_INTERVAL = 15000;
        let countdownInterval = null;
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const voiceSupported = !!(SpeechRecognition && synthesis);

        if (!voiceSupported) {
            const warning = document.getElementById('voiceWarning');
            if (warning) warning.classList.remove('hidden');
        }

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'or-IN';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('assistantInput').value = transcript;
                stopListening();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopListening();
                if (event.error === 'not-allowed') {
                    alert('Microphone permission needed!');
                }
            };

            recognition.onend = () => {
                stopListening();
            };
        }

     pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';



     // Auto-load JSON from GitHub on page load
loadJsonFromGithub();

      
       
        async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Check if it's an image
    if (file.type.startsWith('image/')) {
        await handleImageUpload(file);
    } else if (file.type === 'application/pdf') {
        await handlePdfUpload(file);
    } else {
        alert('‡¨¶‡≠ü‡¨æ‡¨ï‡¨∞‡¨ø PDF ‡¨ï‡¨ø‡¨Æ‡≠ç‡¨¨‡¨æ Image ‡¨Ö‡¨™‡¨≤‡≠ã‡¨°‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å (Please upload PDF or Image)');
    }
}

async function handleImageUpload(file) {
    pdfName = file.name;
    document.getElementById('pdfStatus').textContent = `üñºÔ∏è ${pdfName} ‡¨≤‡≠ã‡¨°‡≠ç ‡¨π‡≠á‡¨â‡¨õ‡¨ø... (Processing image...)`;

    try {
        addMessage('assistant', 'üì∏ ‡¨´‡¨ü‡≠ã‡¨∞‡≠Å ‡¨ü‡≠á‡¨ï‡≠ç‡¨∏‡¨ü‡≠ç ‡¨¨‡¨æ‡¨π‡¨æ‡¨∞ ‡¨ï‡¨∞‡≠Å‡¨õ‡¨ø... ‡¨¶‡≠ü‡¨æ‡¨ï‡¨∞‡¨ø ‡¨Ö‡¨™‡≠á‡¨ï‡≠ç‡¨∑‡¨æ ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å (Extracting text from image... please wait)', false);
        
        const result = await Tesseract.recognize(file, 'eng+hin+ori', {
            logger: m => {
                if (m.status === 'recognizing text') {
                    document.getElementById('pdfStatus').textContent = `üñºÔ∏è ‡¨™‡≠ç‡¨∞‡≠ã‡¨∏‡≠á‡¨∏‡¨ø‡¨Ç: ${Math.round(m.progress * 100)}%`;
                }
            }
        });

        pdfContent = result.data.text;
        document.getElementById('pdfStatus').textContent = `‚úÖ ${pdfName} - ‡¨´‡¨ü‡≠ã ‡¨¨‡¨ø‡¨∑‡≠ü‡¨∞‡≠á ‡¨™‡¨ö‡¨æ‡¨∞‡¨®‡≠ç‡¨§‡≠Å`;
        addMessage('assistant', `‚úÖ ‡¨´‡¨ü‡≠ã ‡¨∏‡¨´‡¨≥‡¨§‡¨æ‡¨∞ ‡¨∏‡¨π ‡¨≤‡≠ã‡¨°‡≠ç ‡¨π‡≠ã‡¨á‡¨õ‡¨ø: ${pdfName}\n\nüìù ‡¨ü‡≠á‡¨ï‡≠ç‡¨∏‡¨ü‡≠ç ‡¨¨‡¨æ‡¨π‡¨æ‡¨∞ ‡¨π‡≠ã‡¨á‡¨∏‡¨æ‡¨∞‡¨ø‡¨õ‡¨ø!\n\n‡¨è‡¨¨‡≠á ‡¨Æ‡≠ã‡¨§‡≠á ‡¨´‡¨ü‡≠ã ‡¨¨‡¨ø‡¨∑‡≠ü‡¨∞‡≠á ‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨® ‡¨™‡¨ö‡¨æ‡¨∞‡¨®‡≠ç‡¨§‡≠Å!`, false);
    } catch (error) {
        console.error('Image processing error:', error);
        document.getElementById('pdfStatus').textContent = '‚ùå ‡¨´‡¨ü‡≠ã ‡¨≤‡≠ã‡¨°‡≠ç ‡¨π‡≠á‡¨≤‡¨æ ‡¨®‡¨æ‡¨π‡¨ø‡¨Å (Failed to load)';
        addMessage('assistant', `‚ùå ‡¨´‡¨ü‡≠ã ‡¨™‡≠ç‡¨∞‡≠ã‡¨∏‡≠á‡¨∏‡≠ç ‡¨ï‡¨∞‡¨ø‡¨¨‡¨æ‡¨∞‡≠á ‡¨§‡≠ç‡¨∞‡≠Å‡¨ü‡¨ø: ${error.message}`, false);
    }
}

async function handlePdfUpload(file) {
    pdfName = file.name;
    document.getElementById('pdfStatus').textContent = `üìÑ ${pdfName} ‡¨≤‡≠ã‡¨°‡≠ç ‡¨π‡≠á‡¨â‡¨õ‡¨ø... (Loading...)`;

    try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        const numPages = Math.min(pdf.numPages, 50);
        
        let fullText = '';
        for (let i = 1; i <= numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += `\n--- Page ${i} ---\n${pageText}\n`;
        }

        pdfContent = fullText;
        document.getElementById('pdfStatus').textContent = `‚úÖ ${pdfName} (${numPages} ‡¨™‡≠É‡¨∑‡≠ç‡¨†‡¨æ) - PDF ‡¨¨‡¨ø‡¨∑‡≠ü‡¨∞‡≠á ‡¨™‡¨ö‡¨æ‡¨∞‡¨®‡≠ç‡¨§‡≠Å`;
        addMessage('assistant', `‚úÖ PDF ‡¨∏‡¨´‡¨≥‡¨§‡¨æ‡¨∞ ‡¨∏‡¨π ‡¨≤‡≠ã‡¨°‡≠ç ‡¨π‡≠ã‡¨á‡¨õ‡¨ø: ${pdfName}\nüìÑ ${numPages} ‡¨™‡≠É‡¨∑‡≠ç‡¨†‡¨æ\n\n‡¨è‡¨¨‡≠á ‡¨Æ‡≠ã‡¨§‡≠á PDF ‡¨¨‡¨ø‡¨∑‡≠ü‡¨∞‡≠á ‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨® ‡¨™‡¨ö‡¨æ‡¨∞‡¨®‡≠ç‡¨§‡≠Å!`, false);
    } catch (error) {
        console.error('PDF processing error:', error);
        document.getElementById('pdfStatus').textContent = '‚ùå PDF ‡¨≤‡≠ã‡¨°‡≠ç ‡¨π‡≠á‡¨≤‡¨æ ‡¨®‡¨æ‡¨π‡¨ø‡¨Å (Failed to load)';
        addMessage('assistant', `‚ùå PDF ‡¨≤‡≠ã‡¨°‡≠ç ‡¨ï‡¨∞‡¨ø‡¨¨‡¨æ‡¨∞‡≠á ‡¨§‡≠ç‡¨∞‡≠Å‡¨ü‡¨ø: ${error.message}`, false);
    }
}

async function loadJsonFromGithub() {
    if (!GITHUB_JSON_URL) {
        addMessage('assistant', '‡¨®‡¨Æ‡¨∏‡≠ç‡¨ï‡¨æ‡¨∞ ‡¨Ü‡¨ú‡≠ç‡¨û‡¨æ ! ‡¨Æ‡≠ã‡¨§‡≠á ‡¨Ø‡≠á‡¨ï‡≠å‡¨£‡¨∏‡¨ø ‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨® ‡¨™‡¨ö‡¨æ‡¨∞‡¨®‡≠ç‡¨§‡≠Å ‡•§', false);
        document.getElementById('pdfStatus').textContent = '‡¨°‡¨ï‡≠Å‡¨Æ‡≠á‡¨£‡≠ç‡¨ü ‡¨Ö‡¨™‡¨≤‡≠ã‡¨°‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å - ‡¨¨‡¨æ ‡¨∏‡¨ø‡¨ß‡¨æ ‡¨™‡¨ö‡¨æ‡¨∞‡¨®‡≠ç‡¨§‡≠Å';
        return;
    }

    try {
        const response = await fetch(GITHUB_JSON_URL);
        if (!response.ok) throw new Error('Failed to fetch JSON from GitHub');
        
        const jsonData = await response.json();
        jsonContent = JSON.stringify(jsonData, null, 2);
        jsonName = GITHUB_JSON_URL.split('/').pop();
        
        const statusText = `‚úÖ üìä JSON Loaded | PDF ‡¨Ö‡¨™‡¨≤‡≠ã‡¨°‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å`;
        document.getElementById('pdfStatus').textContent = statusText;
        
        addMessage('assistant', `‚úÖ ‡¨°‡¨æ‡¨ü‡¨æ‡¨¨‡≠á‡¨∏‡≠ç ‡¨≤‡≠ã‡¨°‡≠ç ‡¨π‡≠ã‡¨á‡¨∏‡¨æ‡¨∞‡¨ø‡¨õ‡¨ø!\n\n‡¨®‡¨Æ‡¨∏‡≠ç‡¨ï‡¨æ‡¨∞ ‡¨Ü‡¨ú‡≠ç‡¨û‡¨æ ! ‡¨Æ‡≠ã‡¨§‡≠á ‡¨Ø‡≠á‡¨ï‡≠å‡¨£‡¨∏‡¨ø ‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨® ‡¨™‡¨ö‡¨æ‡¨∞‡¨®‡≠ç‡¨§‡≠Å:\nüìä ‡¨°‡¨æ‡¨ü‡¨æ‡¨¨‡≠á‡¨∏‡≠ç ‡¨¨‡¨ø‡¨∑‡≠ü‡¨∞‡≠á\nüìÑ ‡¨°‡¨ï‡≠Å‡¨Æ‡≠á‡¨£‡≠ç‡¨ü ‡¨Ö‡¨™‡¨≤‡≠ã‡¨°‡≠ç ‡¨ï‡¨∞‡¨ø ‡¨§‡¨æ' ‡¨¨‡¨ø‡¨∑‡≠ü‡¨∞‡≠á\nüåç ‡¨∏‡¨æ‡¨ß‡¨æ‡¨∞‡¨£ ‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨®\n\n`, false);
    } catch (error) {
        console.error('GitHub JSON loading error:', error);
        document.getElementById('pdfStatus').textContent = '‚ö†Ô∏è JSON Load Failed | PDF ‡¨Ö‡¨™‡¨≤‡≠ã‡¨°‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å';
        addMessage('assistant', `‚ö†Ô∏è ‡¨°‡¨æ‡¨ü‡¨æ‡¨¨‡≠á‡¨∏‡≠ç ‡¨≤‡≠ã‡¨°‡≠ç ‡¨π‡≠á‡¨≤‡¨æ ‡¨®‡¨æ‡¨π‡¨ø‡¨Å ‡•§ ‡¨§‡¨•‡¨æ‡¨™‡¨ø ‡¨Æ‡≠ã‡¨§‡≠á ‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨® ‡¨™‡¨ö‡¨æ‡¨∞‡¨®‡≠ç‡¨§‡≠Å!\n\n`, false);
    }
}


        function toggleListening() {
            if (!voiceSupported || !recognition) {
                alert('‡¨¶‡≠Å‡¨É‡¨ñ‡¨ø‡¨§, ‡¨è‡¨π‡¨ø ‡¨¨‡≠ç‡¨∞‡¨æ‡¨â‡¨ú‡¨∞‡≠ç‡¨∞‡≠á ‡¨≠‡¨è‡¨∏‡≠ç ‡¨∏‡¨™‡≠ã‡¨∞‡≠ç‡¨ü ‡¨®‡¨æ‡¨π‡¨ø‡¨Å ‡•§ Chrome ‡¨¨‡≠ç‡≠ü‡¨¨‡¨π‡¨æ‡¨∞ ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å ‡•§');
                return;
            }

            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            try {
                const lang = document.getElementById('languageSelect').value;
                recognition.lang = `${lang}-IN`;
                isListening = true;
                document.getElementById('listeningIndicator').classList.remove('hidden');
                document.getElementById('micButton').classList.add('bg-red-500', 'animate-pulse');
                document.getElementById('micButton').classList.remove('bg-blue-500');
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
                stopListening();
            }
        }

        function stopListening() {
            isListening = false;
            document.getElementById('listeningIndicator').classList.add('hidden');
            document.getElementById('micButton').classList.remove('bg-red-500', 'animate-pulse');
            document.getElementById('micButton').classList.add('bg-blue-500');
            if (recognition) {
                try { recognition.stop(); } catch (e) {}
            }
        }

     function speakText(text) {
    if (!voiceSupported || !synthesis) return;

    synthesis.cancel();

    const lang = document.getElementById('languageSelect').value;
    
    // Split text into chunks - first by sentences, then by word count
    let chunks = [];
    
    // Try to split by sentence markers first
    const sentences = text.split(/([‡•§!?.\n]+)/);
    
    for (let i = 0; i < sentences.length; i++) {
        const sentence = sentences[i].trim();
        if (!sentence) continue;
        
        // Split long sentences (more than 15 words) into smaller chunks
        const words = sentence.split(/\s+/);
        
        if (words.length > 15) {
            // Break into chunks of 12-15 words
            for (let j = 0; j < words.length; j += 12) {
                const chunk = words.slice(j, j + 12).join(' ');
                if (chunk.trim()) {
                    chunks.push(chunk.trim());
                }
            }
        } else {
            chunks.push(sentence);
        }
    }
    
    // If no chunks were created, split by word count anyway
    if (chunks.length === 0) {
        const words = text.split(/\s+/);
        for (let i = 0; i < words.length; i += 12) {
            const chunk = words.slice(i, i + 12).join(' ');
            if (chunk.trim()) {
                chunks.push(chunk.trim());
            }
        }
    }
    
    let currentIndex = 0;
    
    function speakNextChunk() {
        if (currentIndex >= chunks.length) {
            isSpeaking = false;
            document.getElementById('speakingStatus').classList.add('hidden');
            return;
        }
        
        const utterance = new SpeechSynthesisUtterance(chunks[currentIndex]);
        utterance.lang = `${lang}-IN`;
        utterance.rate = 0.85; // Slower for better clarity
        utterance.pitch = 1;
        utterance.volume = 1;
        
        if (currentIndex === 0) {
            utterance.onstart = () => {
                isSpeaking = true;
                document.getElementById('speakingStatus').classList.remove('hidden');
            };
        }
        
        utterance.onend = () => {
            currentIndex++;
            // Add 500ms pause between chunks (adjust this for longer/shorter pauses)
            setTimeout(speakNextChunk, 500);
        };
        
        utterance.onerror = (event) => {
            console.error('Speech error:', event);
            currentIndex++;
            // Continue to next chunk even if there's an error
            setTimeout(speakNextChunk, 300);
        };
        
        synthesis.speak(utterance);
    }
    
    speakNextChunk();
}
        function stopSpeaking() {
            if (synthesis) {
                synthesis.cancel();
                isSpeaking = false;
                document.getElementById('speakingStatus').classList.add('hidden');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function startCooldownTimer() {
            const sendButton = document.getElementById('sendButton');
            const sendIcon = document.getElementById('sendIcon');
            const countdownText = document.getElementById('countdownText');
            const messageInput = document.getElementById('messageInput');
            
            // Disable button and input
            sendButton.disabled = true;
            sendButton.classList.add('opacity-50', 'cursor-not-allowed');
            sendButton.classList.remove('hover:from-orange-700', 'hover:to-red-700');
            messageInput.disabled = true;
            messageInput.classList.add('opacity-50', 'cursor-not-allowed');
            
            // Hide icon, show countdown
            sendIcon.classList.add('hidden');
            countdownText.classList.remove('hidden');
            
            let remainingTime = Math.ceil(MIN_REQUEST_INTERVAL / 1000);
            countdownText.textContent = remainingTime;
            
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                remainingTime--;
                if (remainingTime > 0) {
                    countdownText.textContent = remainingTime;
                } else {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    
                    // Re-enable button and input
                    sendButton.disabled = false;
                    sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    sendButton.classList.add('hover:from-orange-700', 'hover:to-red-700');
                    messageInput.disabled = false;
                    messageInput.classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    // Show icon, hide countdown
                    sendIcon.classList.remove('hidden');
                    countdownText.classList.add('hidden');
                }
            }, 1000);
        }

        function addMessage(role, content, withSpeaker = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const cleanContent = content.replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/\n/g, '<br>');
            
            const speakerButton = withSpeaker ? `
                <button onclick="speakText(\`${content.replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/\n/g, ' ')}\`)" class="p-1 hover:bg-gray-100 rounded transition flex-shrink-0" title="‡¨è‡¨π‡¨æ‡¨ï‡≠Å ‡¨¨‡≠ã‡¨≤ (Speak this)">
                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                    </svg>
                </button>
            ` : '';
            
            messageDiv.innerHTML = `
                <div class="max-w-[80%] rounded-2xl px-4 py-3 ${
                    role === 'user' 
                        ? 'bg-gradient-to-r from-orange-500 to-red-500 text-white' 
                        : 'bg-white shadow-md text-gray-800'
                }">
                    <div class="flex items-start gap-2">
                        <p class="message-text flex-1">${cleanContent}</p>
                        ${speakerButton}
                    </div>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
        }

        function showLoading() {
            const messagesDiv = document.getElementById('messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="bg-white shadow-md rounded-2xl px-4 py-3">
                    <svg class="w-5 h-5 animate-spin text-orange-600" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            `;
            messagesDiv.appendChild(loadingDiv);
            document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!apiKey) {
                alert('‡¨¶‡≠ü‡¨æ‡¨ï‡¨∞‡¨ø ‡¨™‡≠ç‡¨∞‡¨•‡¨Æ‡≠á API Key ‡¨∏‡≠á‡¨ü‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å ‡•§ Settings ‡¨¨‡¨ü‡¨®‡≠ç ‡¨ï‡≠ç‡¨≤‡¨ø‡¨ï‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å ‡•§\n');
                toggleSettings();
                return;
            }

            // Check if still in cooldown
            const now = Date.now();
            if (now - lastRequestTime < MIN_REQUEST_INTERVAL) {
                return; // Button should be disabled, but just in case
            }

            addMessage('user', message);
            input.value = '';
            showLoading();
            
            // Start cooldown immediately after sending
            lastRequestTime = now;
            startCooldownTimer();

            try {
                const language = document.getElementById('languageSelect').value;
                const mode = document.getElementById('answerMode').value;
                
                const languageNames = {
                    'or': 'Odia (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü)',
                    'hi': 'Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)',
                    'en': 'English',
                    'bn': 'Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)',
                    'te': 'Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)'
                };

               let modeInstruction = '';
if (mode === 'steps') {
    modeInstruction = 'Provide a detailed step-by-step solution with clear explanations.';
} else if (mode === 'table') {
    modeInstruction = 'Answer with calculation tables where appropriate. Provide detailed explanations.';
} else if (mode === 'verify') {
    modeInstruction = 'Solve and verify the answer with detailed reasoning.';
} else {
    modeInstruction = 'Provide a clear, comprehensive, and well-explained answer.';
}
           
let prompt;
if (pdfContent || jsonContent) {
    let contextParts = [];
    
    if (pdfContent) {
        const pdfExcerpt = pdfContent.substring(0, 20000);
        contextParts.push(`PDF CONTENT:\n${pdfExcerpt}`);
    }
    
    if (jsonContent) {
        const jsonExcerpt = jsonContent.substring(0, 15000);
        contextParts.push(`JSON DATABASE:\n${jsonExcerpt}`);
    }
    
    const combinedContext = contextParts.join('\n\n---\n\n');
    
    prompt = `You are a helpful AI assistant. Answer in ${languageNames[language]} language.

${modeInstruction}

${combinedContext}

USER QUESTION: ${message}

INSTRUCTIONS:
- FIRST, check if the question relates to the PDF content (if provided). If yes, answer from PDF.
- SECOND, if not related to PDF, check if it relates to the JSON database (if provided). If yes, answer from JSON and add note: "üìä (From Database)".
- THIRD, if not related to either PDF or JSON, answer from general knowledge and add note: "üåç (General knowledge - not from documents)".
- Always provide helpful answers regardless of the source.

ANSWER:`;
} else {
    // No PDF or JSON - answer general questions
    prompt = `You are a helpful AI assistant. Answer in ${languageNames[language]} language.

${modeInstruction}

USER QUESTION: ${message}

ANSWER :`;
}

           

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 2048,
                            }
                        })
                    }
                );

                hideLoading();

                const data = await response.json();
                
                if (data.error) {
                    // Handle specific API errors
                    if (data.error.message.includes('quota') || data.error.message.includes('limit')) {
                        throw new Error('‡¨Ü‡¨™‡¨£‡¨ô‡≠ç‡¨ï API Quota ‡¨∏‡¨Æ‡¨æ‡¨™‡≠ç‡¨§ ‡¨π‡≠ã‡¨á‡¨Ø‡¨æ‡¨á‡¨õ‡¨ø ‡•§ ‡¨¶‡≠ü‡¨æ‡¨ï‡¨∞‡¨ø ‡¨Ü‡¨∏‡¨®‡≠ç‡¨§‡¨æ ‡¨ï‡¨æ‡¨≤‡¨ø ‡¨Æ‡≠ã ‡¨™‡¨æ‡¨ñ‡¨ï‡≠Å ‡¨Ü‡¨∏‡¨®‡≠ç‡¨§‡≠Å ‡•§');
                    } else if (data.error.message.includes('API key')) {
                        throw new Error('API Key ‡¨≠‡≠Å‡¨≤‡≠ç ‡•§ Settings ‡¨∞‡≠á ‡¨∏‡¨†‡¨ø‡¨ï‡≠ç Key ‡¨¶‡¨ø‡¨Ö‡¨®‡≠ç‡¨§‡≠Å ‡•§ (Invalid API Key. Check Settings.)');
                    }
                    throw new Error(data.error.message || 'API Error');
                }

                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || '‡¨¶‡≠Å‡¨É‡¨ñ‡¨ø‡¨§, ‡¨Æ‡≠Å‡¨Å ‡¨¨‡≠Å‡¨ù‡¨ø‡¨™‡¨æ‡¨∞‡¨ø‡¨≤‡¨ø ‡¨®‡¨æ‡¨π‡¨ø‡¨Å ‡•§';
                
                addMessage('assistant', aiResponse, true);
                
                setTimeout(() => speakText(aiResponse), 500);
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                
                let errorMessage = '';
                if (error.message.includes('quota') || error.message.includes('Quota')) {
                    errorMessage = '‚ùå ‡¨Ü‡¨™‡¨£‡¨ô‡≠ç‡¨ï API Quota ‡¨∏‡¨Æ‡¨æ‡¨™‡≠ç‡¨§ ‡¨π‡≠ã‡¨á‡¨Ø‡¨æ‡¨á‡¨õ‡¨ø ‡•§ ‡¨¶‡≠ü‡¨æ‡¨ï‡¨∞‡¨ø ‡¨Ü‡¨∏‡¨®‡≠ç‡¨§‡¨æ ‡¨ï‡¨æ‡¨≤‡¨ø ‡¨Æ‡≠ã ‡¨™‡¨æ‡¨ñ‡¨ï‡≠Å ‡¨Ü‡¨∏‡¨®‡≠ç‡¨§‡≠Å ‡•§';
                } else if (error.message.includes('API Key') || error.message.includes('API_KEY')) {
                    errorMessage = '‚ùå API Key ‡¨≠‡≠Å‡¨≤‡≠ç ‡¨Ö‡¨õ‡¨ø ‡•§\n\n‚öôÔ∏è Settings ‡¨∞‡≠á ‡¨∏‡¨†‡¨ø‡¨ï‡≠ç API Key ‡¨¶‡¨ø‡¨Ö‡¨®‡≠ç‡¨§‡≠Å ‡•§';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = '‚ùå ‡¨®‡≠á‡¨ü‡≠±‡¨æ‡¨∞‡≠ç‡¨ï ‡¨∏‡¨Æ‡¨∏‡≠ç‡≠ü‡¨æ ‡•§ (Network error.)\n\nüîÑ ‡¨™‡≠Å‡¨®‡¨∞‡≠ç‡¨¨‡¨æ‡¨∞ ‡¨ö‡≠á‡¨∑‡≠ç‡¨ü‡¨æ ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å ‡•§ (Please try again.)';
                } else {
                    errorMessage = `‚ùå ‡¨§‡≠ç‡¨∞‡≠Å‡¨ü‡¨ø: ${error.message}`;
                }
                
                addMessage('assistant', errorMessage, false);
            }
        }

        // Generate practice questions
        window.generatePracticeQuestions = async function() {
            if (!apiKey) {
                alert('‡¨¶‡≠ü‡¨æ‡¨ï‡¨∞‡¨ø ‡¨™‡≠ç‡¨∞‡¨•‡¨Æ‡≠á API Key ‡¨∏‡≠á‡¨ü‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å ‡•§');
                toggleSettings();
                return;
            }

        if (!pdfContent && !jsonContent) {
    addMessage('assistant', '‚ö†Ô∏è ‡¨Ö‡¨≠‡≠ç‡≠ü‡¨æ‡¨∏ ‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨® ‡¨™‡¨æ‡¨á‡¨Å PDF ‡¨Ö‡¨™‡¨≤‡≠ã‡¨°‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å ‡•§', false);
    return;
}

            // Check if still in cooldown
            const now = Date.now();
            if (now - lastRequestTime < MIN_REQUEST_INTERVAL) {
                return; // Button should be disabled
            }

            showLoading();
            
            // Start cooldown
            lastRequestTime = now;
            startCooldownTimer();

            try {
                const language = document.getElementById('languageSelect').value;
                const languageNames = {
                    'or': 'Odia (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü)',
                    'hi': 'Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)',
                    'en': 'English',
                    'bn': 'Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)',
                    'te': 'Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)'
                };

                const pdfExcerpt = pdfContent.substring(0, 8000);
                
                const prompt = `Generate 5 practice questions based on the following content. Generate in ${languageNames[language]} language.

Provide detailed, well-formed questions that thoroughly test understanding.

Difficulty: Medium

CONTENT:
${pdfExcerpt}

Create 5 meaningful practice questions that test understanding of this content. Number them 1-5.`;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            generationConfig: {
                                temperature: 0.9,
                                maxOutputTokens: 1024,
                            }
                        })
                    }
                );

                hideLoading();

                const data = await response.json();
                
                if (data.error) {
                    if (data.error.message.includes('quota') || data.error.message.includes('limit')) {
                        throw new Error('API Quota exhausted');
                    }
                    throw new Error(data.error.message || 'API Error');
                }

                const questions = data.candidates?.[0]?.content?.parts?.[0]?.text || '‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨® ‡¨∏‡≠É‡¨∑‡≠ç‡¨ü‡¨ø ‡¨ï‡¨∞‡¨ø‡¨π‡≠á‡¨≤‡¨æ ‡¨®‡¨æ‡¨π‡¨ø‡¨Å ‡•§';
                
                addMessage('assistant', `üìö ‡¨Ö‡¨≠‡≠ç‡≠ü‡¨æ‡¨∏ ‡¨™‡≠ç‡¨∞‡¨∂‡≠ç‡¨® (Practice Questions):\n\n${questions}`, false);
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                
                let errorMessage = '';
                if (error.message.includes('quota') || error.message.includes('Quota')) {
                    errorMessage = '‚ùå API Quota ‡¨∏‡¨Æ‡¨æ‡¨™‡≠ç‡¨§ ‡•§ ‡¨¶‡≠ü‡¨æ‡¨ï‡¨∞‡¨ø ‡¨Ü‡¨∏‡¨®‡≠ç‡¨§‡¨æ ‡¨ï‡¨æ‡¨≤‡¨ø ‡¨Æ‡≠ã ‡¨™‡¨æ‡¨ñ‡¨ï‡≠Å ‡¨Ü‡¨∏‡¨®‡≠ç‡¨§‡≠Å ‡•§';
                } else {
                    errorMessage = `‚ùå ‡¨§‡≠ç‡¨∞‡≠Å‡¨ü‡¨ø: ${error.message}`;
                }
                
                addMessage('assistant', errorMessage, false);
            }
        };

        // Quick action buttons
        window.askQuickQuestion = function(questionType) {
            if (!pdfContent) {
                addMessage('assistant', '‚ö†Ô∏è ‡¨™‡≠ç‡¨∞‡¨•‡¨Æ‡≠á PDF ‡¨Ö‡¨™‡¨≤‡≠ã‡¨°‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å ‡•§', false);
                return;
            }

            const questions = {
                'or': {
                    'summary': '‡¨è‡¨π‡¨ø PDF ‡¨∞ ‡¨∏‡¨æ‡¨∞‡¨æ‡¨Ç‡¨∂ ‡¨¶‡¨ø‡¨Ö',
                    'keypoints': '‡¨Æ‡≠Å‡¨ñ‡≠ç‡≠ü ‡¨¨‡¨ø‡¨®‡≠ç‡¨¶‡≠Å‡¨ó‡≠Å‡¨°‡¨º‡¨ø‡¨ï ‡¨ï\'‡¨£?',
                    'explain': '‡¨è‡¨π‡¨æ‡¨ï‡≠Å ‡¨∏‡¨∞‡¨≥ ‡¨≠‡¨æ‡¨¨‡¨∞‡≠á ‡¨¨‡≠Å‡¨ù‡¨æ‡¨Ö'
                },
                'hi': {
                    'summary': '‡§á‡§∏ PDF ‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§¶‡•á‡§Ç',
                    'keypoints': '‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡§ø‡§Ç‡§¶‡•Å ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à‡§Ç?',
                    'explain': '‡§á‡§∏‡•á ‡§∏‡§∞‡§≤ ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•á ‡§∏‡§Æ‡§ù‡§æ‡§è‡§Ç'
                },
                'en': {
                    'summary': 'Give a summary of this PDF',
                    'keypoints': 'What are the key points?',
                    'explain': 'Explain this simply'
                }
            };

            const lang = document.getElementById('languageSelect').value;
            const langGroup = lang === 'or' ? 'or' : (lang === 'hi' ? 'hi' : 'en');
            const question = questions[langGroup][questionType];
            
            document.getElementById('messageInput').value = question;
            sendMessage();
        };


</script>

</body>
</html>
